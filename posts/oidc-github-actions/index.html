<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Security-conscious cloud deployments from Github Actions via OpenID Connect | anthony lukach</title>
<meta name=keywords content="aws,devops,github actions"><meta name=description content="Goals This ticket is focused on how we can securely deploy to a major cloud provider environment (e.g. AWS, Azure, GCP) from within our Github Actions workflows.
Why is this challenging? A naive solution to this problem is to generate some cloud provider credentials (e.g. AWS Access Keys) and to store them as a Github Secret. Our Github Actions can then utilize these credentials in its workflows. However, this technique contains a number of concerns:"><meta name=author content><link rel=canonical href=https://alukach.com/posts/oidc-github-actions/><link crossorigin=anonymous href=/assets/css/stylesheet.1ed26481d325120f9a3f0ae345a661a48b2f3cff0b5eed3b700edd10d22d4d79.css integrity="sha256-HtJkgdMlEg+aPwrjRaZhpIsvPP8LXu07cA7dENItTXk=" rel="preload stylesheet" as=style><link rel=icon href=https://alukach.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://alukach.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://alukach.com/favicon-32x32.png><link rel=apple-touch-icon href=https://alukach.com/apple-touch-icon.png><link rel=mask-icon href=https://alukach.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://alukach.com/posts/oidc-github-actions/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Security-conscious cloud deployments from Github Actions via OpenID Connect"><meta property="og:description" content="Goals This ticket is focused on how we can securely deploy to a major cloud provider environment (e.g. AWS, Azure, GCP) from within our Github Actions workflows.
Why is this challenging? A naive solution to this problem is to generate some cloud provider credentials (e.g. AWS Access Keys) and to store them as a Github Secret. Our Github Actions can then utilize these credentials in its workflows. However, this technique contains a number of concerns:"><meta property="og:type" content="article"><meta property="og:url" content="https://alukach.com/posts/oidc-github-actions/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-20T00:00:00+00:00"><meta property="article:modified_time" content="2021-12-20T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Security-conscious cloud deployments from Github Actions via OpenID Connect"><meta name=twitter:description content="Goals This ticket is focused on how we can securely deploy to a major cloud provider environment (e.g. AWS, Azure, GCP) from within our Github Actions workflows.
Why is this challenging? A naive solution to this problem is to generate some cloud provider credentials (e.g. AWS Access Keys) and to store them as a Github Secret. Our Github Actions can then utilize these credentials in its workflows. However, this technique contains a number of concerns:"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alukach.com/posts/"},{"@type":"ListItem","position":2,"name":"Security-conscious cloud deployments from Github Actions via OpenID Connect","item":"https://alukach.com/posts/oidc-github-actions/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Security-conscious cloud deployments from Github Actions via OpenID Connect","name":"Security-conscious cloud deployments from Github Actions via OpenID Connect","description":"Goals This ticket is focused on how we can securely deploy to a major cloud provider environment (e.g. AWS, Azure, GCP) from within our Github Actions workflows.\nWhy is this challenging? A naive solution to this problem is to generate some cloud provider credentials (e.g. AWS Access Keys) and to store them as a Github Secret. Our Github Actions can then utilize these credentials in its workflows. However, this technique contains a number of concerns:","keywords":["aws","devops","github actions"],"articleBody":"Goals This ticket is focused on how we can securely deploy to a major cloud provider environment (e.g. AWS, Azure, GCP) from within our Github Actions workflows.\nWhy is this challenging? A naive solution to this problem is to generate some cloud provider credentials (e.g. AWS Access Keys) and to store them as a Github Secret. Our Github Actions can then utilize these credentials in its workflows. However, this technique contains a number of concerns:\nIt is reliant on long-standing credentials being stored in Github Actions. Some environments are unable to generate such long-standing credentials without serious admin intervention (e.g. environments using CloudTamer/Kion).\nIt grants any user with write-access to the repo with full use of the possibly wide-scoped credentials. Currently, within Github there are not a sufficient ways to limit who or what can be done with the credentials. For example, any user with write-access to the repo could create a workflow action that references the production credentials and uses them to teardown the production environment. This is due to the combination of two factors:\nThe instructions run during the build are entirely specified within the Github repo. This means that anyone can alter them as they see fit. The cloud providers lacks information about the context of a build (e.g. git branch or github user), and is therefore unable to apply or enforce any sort of restrictions regarding what a build can do. Github Environments solves some of these problems, however at time of writing it is only available on public repositories or private Github Enterprise account repositories, making it an unvialable solution for many of our partners.\nSolution: OpenID Connect On Nov 23, 2021 Github Actions announced the general availability of support for OpenID Connect (OIDC). For an in-depth understanding of this, I recommend reviewing the following links:\nAnnouncement: Secure deployments with OpenID Connect \u0026 GitHub Actions now generally available Docs: Security hardening your deployments [with OpenID Connect] High level summary With OIDC, you can register Github as an Identity Provider within your cloud platform of choice. When your Github Action workflows run, they can be setup to request short-lived credentials from your cloud provider. When the cloud provider grants the access token, it will be associated with a particular IAM Role. That IAM Role should be set up with the permissions necessary for deploying your application.\nNo need to store credentials. Github Actions workflows will request a short-lived access token at runtime. When a short-lived access token is requested, Github Actions sends an OIDC token with claims describing the context of the workflow (link). These claims can be interogated by the cloud provider and used to determine whether or not a token should be granted. This allows us to hardcode security requirements (e.g. limiting particular IAM Roles to specific Github branches, only allowing executions triggered by specified github usernames) in the cloud provider, providing guard-rails to limit what can be done by any particular user with write-access to a Github repository. Example with AWS Setup AWS Setting up OIDC with AWS is described in depth here, however the following is a quick summary:\nAdd Github as an Identity provider (docs).\nConsole Screenshot Create an IAM Policy for deployment executions. See recommendations for tips on how to craft this policy. Below is an example policy for frontend static website deployments:\nExample policy 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"SyncS3Bucket\", \"Effect\": \"Allow\", \"Action\": [ \"s3:ListBucket\", \"s3:GetObject\", \"s3:PutObject\", \"s3:PutObjectAcl\", \"s3:DeleteObject\" ], \"Resource\": [ \"arn:aws:s3:::my-staging-bucket\", \"arn:aws:s3:::my-staging-bucket/*\" ] }, { \"Sid\": \"InvalidateCloudfrontDistribution\", \"Effect\": \"Allow\", \"Action\": [\"cloudfront:CreateInvalidation\"], \"Resource\": \"*\" } ] } Create role for deployment executions.\nConsole Screenshot Attach your revelant policies. Optionally, specify the role’s permission boundaries.\nConsole Screenshot For this example, we’ll be naming our role Frontend-Staging-Deployment-Role\nConsole Screenshot By default, the IAM Role created for our OIDC Web Identity contains a condition where the aud claim in our token should match sts.amazonaws.com. However, it is here that we will enforce more strict conditions. The sub claim in our token contains information about the reposoitory and branch. As such, we need to customize our trust relationship to encorce our custom conditions.\nConsole Screenshot In the following example, we configure the trust relationship to enforce that this role can only be used on builds on the my-org/my-repo repository’s staging branch:\nExample conditions 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 { \"Version\": \"2012-10-17\", \"Statement\": [ { \"Effect\": \"Allow\", \"Principal\": { \"Federated\": \"arn:aws:iam::123456789000:oidc-provider/token.actions.githubusercontent.com\" }, \"Action\": \"sts:AssumeRoleWithWebIdentity\", \"Condition\": { \"StringEquals\": { \"token.actions.githubusercontent.com:aud\": \"sts.amazonaws.com\", \"token.actions.githubusercontent.com:sub\": \"repo:my-org/my-repo:ref:refs/heads/staging\" } } } ] } Setup GitHub Actions Workflow Workflows utilizing OIDC need a few particular elements.\nWe need to customize the permissions of our GITHUB_TOKEN via the permissions block. The workflow will need to be able to write an id-token along with the default permissions of reading the contents of the repository:\nPermissions block 1 2 3 permissions: id-token: write contents: read Add tooling to request the an access token from AWS. For this, the AWS’ offical “Configure AWS Credentials” Action works well. To use this, you must provide the ARN of the role that you would like to assume in your execution:\nAWS Configuration step 1 2 3 4 5 - name: Configure AWS credentials uses: aws-actions/configure-aws-credentials@v1 with: role-to-assume: arn:aws:iam::123456789000:role/Frontend-Staging-Deployment-Role aws-region: us-west-2 Full example A complete example workflow 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 name: Deploy Staging Frontend on: push: branches: - staging permissions: id-token: write contents: read jobs: build: runs-on: ubuntu-latest steps: - name: Setup Node.js uses: actions/setup-node@v2 with: node-version: 12 - name: Check out repository code uses: actions/checkout@v2 - name: Install dependencies run: npm install - name: Build code run: npm run build - name: Configure AWS credentials uses: aws-actions/configure-aws-credentials@v1 with: role-to-assume: arn:aws:iam::123456789000:role/Frontend-Staging-Deployment-Role aws-region: us-west-2 - name: Sync with S3 bucket env: BUCKET: my-staging-bucket run: | aws s3 sync \\ ./build \"s3://${BUCKET}\" \\ --acl public-read \\ --follow-symlinks \\ --delete - name: Invalidate CloudFront env: DISTRIBUTION: EDFDVBD6EXAMPLE run: | aws cloudfront create-invalidation \\ --distribution-id $DISTRIBUTION \\ --paths \"/*\" In the above example, we have hardcoded the Role ARN, S3 Bucket, and Cloudfront Distribution ID in the workflow file. However, you may prefer to store these values as Github Secrets. This allows the values to be changed without a code change and additionally helps avoid data-leak. An example:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 - name: Configure AWS credentials uses: aws-actions/configure-aws-credentials@v1 with: role-to-assume: ${{ secrets.STAGING_CD_ROLE_ARN }} aws-region: us-west-2 - name: Sync with S3 bucket env: BUCKET: ${{ secrets.STAGING_BUCKET_NAME }} run: | aws s3 sync \\ ./build \"s3://${BUCKET}\" \\ --acl public-read \\ --follow-symlinks \\ --delete - name: Invalidate CloudFront env: DISTRIBUTION: ${{ secrets.STAGING_DISTRIBUTION_ID }} run: | aws cloudfront create-invalidation \\ --distribution-id $DISTRIBUTION \\ --paths \"/*\" Recommendations Each IAM role should relate to a single deployment. For example, you may have a Service-X-Frontend-Staging-Deployment role and a Service-X-Frontend-Production-Deployment role, each referencing specific IAM policies that specify the minimal permissions needed to deploy to its respective environment. Each role should specify which repositories and branches can use the role. Configuring the IAM role’s trust relationship is key to enforcing logic around deployment permissions. Understanding the Condition block and the Github OIDC token is paramount. ","wordCount":"1276","inLanguage":"en","datePublished":"2021-12-20T00:00:00Z","dateModified":"2021-12-20T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://alukach.com/posts/oidc-github-actions/"},"publisher":{"@type":"Organization","name":"anthony lukach","logo":{"@type":"ImageObject","url":"https://alukach.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://alukach.com/ accesskey=h title="anthony lukach (Alt + H)">anthony lukach</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://alukach.com/categories/posts title=Posts><span>Posts</span></a></li><li><a href=https://alukach.com/categories/snippets title=Snippets><span>Snippets</span></a></li><li><a href=https://alukach.com/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://alukach.com/resume title=Résumé><span>Résumé</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">Security-conscious cloud deployments from Github Actions via OpenID Connect</h1><div class=post-meta><span title='2021-12-20 00:00:00 +0000 UTC'>December 20, 2021</span>&nbsp;·&nbsp;6 min&nbsp;|&nbsp;<a href=https://github.com/alukach/alukach.github.io/edit/main/content/posts/oidc-github-actions.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#goals aria-label=Goals>Goals</a><ul><li><a href=#why-is-this-challenging aria-label="Why is this challenging?">Why is this challenging?</a></li></ul></li><li><a href=#solution-openid-connect aria-label="Solution: OpenID Connect">Solution: OpenID Connect</a><ul><li><a href=#high-level-summary aria-label="High level summary">High level summary</a></li><li><a href=#example-with-aws aria-label="Example with AWS">Example with AWS</a><ul><li><a href=#setup-aws aria-label="Setup AWS">Setup AWS</a></li><li><a href=#setup-github-actions-workflow aria-label="Setup GitHub Actions Workflow">Setup GitHub Actions Workflow</a><ul><li><a href=#full-example aria-label="Full example">Full example</a></li></ul></li></ul></li></ul></li><li><a href=#recommendations aria-label=Recommendations>Recommendations</a></li></ul></div></details></div><div class=post-content><h2 id=goals>Goals<a hidden class=anchor aria-hidden=true href=#goals>#</a></h2><p>This ticket is focused on how we can securely deploy to a major cloud provider environment (e.g. AWS, Azure, GCP) from within our Github Actions workflows.</p><h3 id=why-is-this-challenging>Why is this challenging?<a hidden class=anchor aria-hidden=true href=#why-is-this-challenging>#</a></h3><p>A naive solution to this problem is to generate some cloud provider credentials (e.g. AWS Access Keys) and to store them as a Github Secret. Our Github Actions can then utilize these credentials in its workflows. However, this technique contains a number of concerns:</p><ol><li><p>It is reliant on long-standing credentials being stored in Github Actions. Some environments are unable to generate such long-standing credentials without serious admin intervention (e.g. environments using CloudTamer/Kion).</p></li><li><p>It grants any user with write-access to the repo with full use of the possibly wide-scoped credentials. Currently, within Github there are not a sufficient ways to limit who or what can be done with the credentials. For example, any user with write-access to the repo could create a workflow action that references the production credentials and uses them to teardown the production environment. This is due to the combination of two factors:</p><ol><li>The instructions run during the build are entirely specified within the Github repo. This means that anyone can alter them as they see fit.</li><li>The cloud providers lacks information about the context of a build (e.g. git branch or github user), and is therefore unable to apply or enforce any sort of restrictions regarding what a build can do.</li></ol><p><a href=https://docs.github.com/en/actions/deployment/targeting-different-environments/using-environments-for-deployment>Github Environments</a> solves some of these problems, however at time of writing it is only available on public repositories or private Github Enterprise account repositories, making it an unvialable solution for many of our partners.</p></li></ol><h2 id=solution-openid-connect>Solution: OpenID Connect<a hidden class=anchor aria-hidden=true href=#solution-openid-connect>#</a></h2><p>On Nov 23, 2021 Github Actions announced the general availability of support for OpenID Connect (OIDC). For an in-depth understanding of this, I recommend reviewing the following links:</p><ul><li>Announcement: <a href=https://github.blog/2021-11-23-secure-deployments-openid-connect-github-actions-generally-available/>Secure deployments with OpenID Connect & GitHub Actions now generally available</a></li><li>Docs: <a href=https://docs.github.com/en/actions/deployment/security-hardening-your-deployments>Security hardening your deployments [with OpenID Connect]</a></li></ul><h3 id=high-level-summary>High level summary<a hidden class=anchor aria-hidden=true href=#high-level-summary>#</a></h3><p>With OIDC, you can register Github as an Identity Provider within your cloud platform of choice. When your Github Action workflows run, they can be setup to request short-lived credentials from your cloud provider. When the cloud provider grants the access token, it will be associated with a particular IAM Role. That IAM Role should be set up with the permissions necessary for deploying your application.</p><ul><li>No need to store credentials. Github Actions workflows will request a short-lived access token at runtime.</li><li>When a short-lived access token is requested, Github Actions sends an OIDC token with claims describing the context of the workflow (<a href=https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token>link</a>). These claims can be interogated by the cloud provider and used to determine whether or not a token should be granted. This allows us to hardcode security requirements (e.g. limiting particular IAM Roles to specific Github branches, only allowing executions triggered by specified github usernames) in the cloud provider, providing guard-rails to limit what can be done by any particular user with write-access to a Github repository.</li></ul><h3 id=example-with-aws>Example with AWS<a hidden class=anchor aria-hidden=true href=#example-with-aws>#</a></h3><h4 id=setup-aws>Setup AWS<a hidden class=anchor aria-hidden=true href=#setup-aws>#</a></h4><p>Setting up OIDC with AWS is described in depth <a href=https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services>here</a>, however the following is a quick summary:</p><ol><li><p>Add Github as an Identity provider (<a href=https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services#adding-the-identity-provider-to-aws>docs</a>).</p><details><summary>Console Screenshot</summary><img width=885 alt="Screen Shot 2021-12-20 at 9 53 21 AM" src=https://user-images.githubusercontent.com/897290/146828985-c767dfed-d34c-446b-8597-cb4b15fd922c.png></details></li><li><p>Create an IAM Policy for deployment executions. See <a href=#recommendations>recommendations</a> for tips on how to craft this policy. Below is an example policy for frontend static website deployments:</p><details><summary>Example policy</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#2c5dcd;font-weight:700>&#34;Version&#34;</span>: <span style=color:#0c6>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#2c5dcd;font-weight:700>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Sid&#34;</span>: <span style=color:#0c6>&#34;SyncS3Bucket&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Effect&#34;</span>: <span style=color:#0c6>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Action&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#0c6>&#34;s3:ListBucket&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#0c6>&#34;s3:GetObject&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#0c6>&#34;s3:PutObject&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#0c6>&#34;s3:PutObjectAcl&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#0c6>&#34;s3:DeleteObject&#34;</span>
</span></span><span style=display:flex><span>      ],
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Resource&#34;</span>: [
</span></span><span style=display:flex><span>        <span style=color:#0c6>&#34;arn:aws:s3:::my-staging-bucket&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#0c6>&#34;arn:aws:s3:::my-staging-bucket/*&#34;</span>
</span></span><span style=display:flex><span>      ]
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Sid&#34;</span>: <span style=color:#0c6>&#34;InvalidateCloudfrontDistribution&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Effect&#34;</span>: <span style=color:#0c6>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Action&#34;</span>: [<span style=color:#0c6>&#34;cloudfront:CreateInvalidation&#34;</span>],
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Resource&#34;</span>: <span style=color:#0c6>&#34;*&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></li><li><p>Create role for deployment executions.</p><details><summary>Console Screenshot</summary><img width=982 alt="Screen Shot 2021-12-20 at 12 37 18 PM" src=https://user-images.githubusercontent.com/897290/146829615-0359eb95-7859-4433-ad21-fc1b5b17f47c.png></details><p>Attach your revelant policies. Optionally, specify the role&rsquo;s permission boundaries.</p><details><summary>Console Screenshot</summary><p><img loading=lazy src=https://user-images.githubusercontent.com/897290/146830755-0ddf31ad-7249-4032-8a7e-8278d4319597.png alt=image></p></details><p>For this example, we&rsquo;ll be naming our role <code>Frontend-Staging-Deployment-Role</code></p><details><summary>Console Screenshot</summary><p><img loading=lazy src=https://user-images.githubusercontent.com/897290/146831434-b69cb9d2-2776-4909-a237-508d9dbf0f8b.png alt=image></p></details></li><li><p>By default, the IAM Role created for our OIDC Web Identity contains a condition where the <code>aud</code> claim in our token should match <code>sts.amazonaws.com</code>. However, it is here that we will enforce more strict conditions. The <code>sub</code> claim in our token contains information about the reposoitory and branch. As such, we need to customize our trust relationship to encorce our custom conditions.</p><details><summary>Console Screenshot</summary><p><img loading=lazy src=https://user-images.githubusercontent.com/897290/146832709-cb125143-9a7b-48c2-9532-71c87191f410.png alt=image></p></details><p>In the following example, we configure the trust relationship to enforce that this role can only be used on builds on the <code>my-org/my-repo</code> repository&rsquo;s <code>staging</code> branch:</p><details><summary>Example conditions</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#2c5dcd;font-weight:700>&#34;Version&#34;</span>: <span style=color:#0c6>&#34;2012-10-17&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#2c5dcd;font-weight:700>&#34;Statement&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Effect&#34;</span>: <span style=color:#0c6>&#34;Allow&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Principal&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>&#34;Federated&#34;</span>: <span style=color:#0c6>&#34;arn:aws:iam::123456789000:oidc-provider/token.actions.githubusercontent.com&#34;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Action&#34;</span>: <span style=color:#0c6>&#34;sts:AssumeRoleWithWebIdentity&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Condition&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>&#34;StringEquals&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#2c5dcd;font-weight:700>&#34;token.actions.githubusercontent.com:aud&#34;</span>: <span style=color:#0c6>&#34;sts.amazonaws.com&#34;</span>,
</span></span><span style=display:flex><span>          <span style=color:#2c5dcd;font-weight:700>&#34;token.actions.githubusercontent.com:sub&#34;</span>: <span style=color:#0c6>&#34;repo:my-org/my-repo:ref:refs/heads/staging&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details></li></ol><h4 id=setup-github-actions-workflow>Setup GitHub Actions Workflow<a hidden class=anchor aria-hidden=true href=#setup-github-actions-workflow>#</a></h4><p>Workflows utilizing OIDC need a few particular elements.</p><ol><li><p>We need to customize the <a href=https://docs.github.com/en/actions/security-guides/automatic-token-authentication#permissions-for-the-github_token>permissions of our <code>GITHUB_TOKEN</code></a> via the <code>permissions</code> block. The workflow will need to be able to write an <code>id-token</code> along with the default permissions of reading the <code>contents</code> of the repository:</p><details><summary>Permissions block</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>permissions</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>id-token</span>:<span style=color:#cbcbcb> </span>write<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>contents</span>:<span style=color:#cbcbcb> </span>read<span style=color:#cbcbcb>
</span></span></span></code></pre></td></tr></table></div></div></details></li><li><p>Add tooling to request the an access token from AWS. For this, the AWS&rsquo; offical <a href=https://github.com/marketplace/actions/configure-aws-credentials-action-for-github-actions>&ldquo;Configure AWS Credentials&rdquo; Action</a> works well. To use this, you must provide the ARN of the role that you would like to assume in your execution:</p><details><summary>AWS Configuration step</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Configure AWS credentials<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>aws-actions/configure-aws-credentials@v1<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>role-to-assume</span>:<span style=color:#cbcbcb> </span>arn:aws:iam::123456789000:role/Frontend-Staging-Deployment-Role<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>aws-region</span>:<span style=color:#cbcbcb> </span>us-west-2<span style=color:#cbcbcb>
</span></span></span></code></pre></td></tr></table></div></div></details></li></ol><h5 id=full-example>Full example<a hidden class=anchor aria-hidden=true href=#full-example>#</a></h5><details><summary>A complete example workflow</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Deploy Staging Frontend<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>on</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>push</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>branches</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>      </span>- staging<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>permissions</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>id-token</span>:<span style=color:#cbcbcb> </span>write<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>contents</span>:<span style=color:#cbcbcb> </span>read<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>jobs</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>build</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>runs-on</span>:<span style=color:#cbcbcb> </span>ubuntu-latest<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>steps</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Setup Node.js<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>actions/setup-node@v2<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>node-version</span>:<span style=color:#cbcbcb> </span><span style=color:#5918bb;font-weight:700>12</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Check out repository code<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>actions/checkout@v2<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Install dependencies<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>npm install<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Build code<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>npm run build<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Configure AWS credentials<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>aws-actions/configure-aws-credentials@v1<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>role-to-assume</span>:<span style=color:#cbcbcb> </span>arn:aws:iam::123456789000:role/Frontend-Staging-Deployment-Role<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>aws-region</span>:<span style=color:#cbcbcb> </span>us-west-2<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Sync with S3 bucket<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>env</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>BUCKET</span>:<span style=color:#cbcbcb> </span>my-staging-bucket<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>          aws s3 sync \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>            ./build &#34;s3://${BUCKET}&#34; \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>            --acl public-read \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>            --follow-symlinks \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>            --delete</span><span style=color:#cbcbcb>          
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Invalidate CloudFront<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>env</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>DISTRIBUTION</span>:<span style=color:#cbcbcb> </span>EDFDVBD6EXAMPLE<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>          aws cloudfront create-invalidation \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>            --distribution-id $DISTRIBUTION \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>            --paths &#34;/*&#34;</span><span style=color:#cbcbcb>          
</span></span></span></code></pre></td></tr></table></div></div><p>In the above example, we have hardcoded the Role ARN, S3 Bucket, and Cloudfront Distribution ID in the workflow file. However, you may prefer to store these values as Github Secrets. This allows the values to be changed without a code change and additionally helps avoid data-leak. An example:</p><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=display:flex><span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Configure AWS credentials<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>aws-actions/configure-aws-credentials@v1<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>role-to-assume</span>:<span style=color:#cbcbcb> </span>${{ secrets.STAGING_CD_ROLE_ARN }}<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>aws-region</span>:<span style=color:#cbcbcb> </span>us-west-2<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Sync with S3 bucket<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>env</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>BUCKET</span>:<span style=color:#cbcbcb> </span>${{ secrets.STAGING_BUCKET_NAME }}<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>    aws s3 sync \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>      ./build &#34;s3://${BUCKET}&#34; \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>      --acl public-read \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>      --follow-symlinks \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>      --delete</span><span style=color:#cbcbcb>    
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Invalidate CloudFront<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>env</span>:<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>DISTRIBUTION</span>:<span style=color:#cbcbcb> </span>${{ secrets.STAGING_DISTRIBUTION_ID }}<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>    aws cloudfront create-invalidation \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>      --distribution-id $DISTRIBUTION \
</span></span></span><span style=display:flex><span><span style=color:#0c6;font-style:italic>      --paths &#34;/*&#34;</span><span style=color:#cbcbcb>    
</span></span></span></code></pre></td></tr></table></div></div></details><h2 id=recommendations>Recommendations<a hidden class=anchor aria-hidden=true href=#recommendations>#</a></h2><ul><li>Each IAM role should relate to a single deployment. For example, you may have a <code>Service-X-Frontend-Staging-Deployment</code> role and a <code>Service-X-Frontend-Production-Deployment</code> role, each referencing specific IAM policies that specify the minimal permissions needed to deploy to its respective environment. Each role should specify which repositories and branches can use the role.</li><li>Configuring the IAM role&rsquo;s trust relationship is key to enforcing logic around deployment permissions. Understanding the <a href=https://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements_condition.html><code>Condition</code> block</a> and the <a href=https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/about-security-hardening-with-openid-connect#understanding-the-oidc-token>Github OIDC token</a> is paramount.</li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://alukach.com/tags/aws/>Aws</a></li><li><a href=https://alukach.com/tags/devops/>Devops</a></li><li><a href=https://alukach.com/tags/github-actions/>Github Actions</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://alukach.com/>anthony lukach</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>