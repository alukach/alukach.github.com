<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Using CloudFront as a Reverse Proxy | anthony lukach</title>
<meta name=keywords content="python,aws,cdk,cloudfront">
<meta name=description content="Alternate title: How to be master of your domain.
The basic idea of this post is to demonstrate how CloudFront can be utilized as a serverless reverse-proxy, allowing you to host all of your application&rsquo;s content and services from a single domain. This minimizes a project&rsquo;s TLD footprint while providing project organization and performance along the way.
Why Within large organizations, bureaucracy can make it a challenge to obtain a subdomain for a project.">
<meta name=author content>
<link rel=canonical href=https://alukach.com/posts/using-cloudfont-as-a-reverse-proxy/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.d3ac7722b310eb0e766008030de600ef174720ca311dc5ef494d1ba934fa43f0.css integrity="sha256-06x3IrMQ6w52YAgDDeYA7xdHIMoxHcXvSU0bqTT6Q/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://alukach.com/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://alukach.com/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://alukach.com/favicon-32x32.png>
<link rel=apple-touch-icon href=https://alukach.com/apple-touch-icon.png>
<link rel=mask-icon href=https://alukach.com/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.89.4">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-16401510-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="Using CloudFront as a Reverse Proxy">
<meta property="og:description" content="Alternate title: How to be master of your domain.
The basic idea of this post is to demonstrate how CloudFront can be utilized as a serverless reverse-proxy, allowing you to host all of your application&rsquo;s content and services from a single domain. This minimizes a project&rsquo;s TLD footprint while providing project organization and performance along the way.
Why Within large organizations, bureaucracy can make it a challenge to obtain a subdomain for a project.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://alukach.com/posts/using-cloudfont-as-a-reverse-proxy/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2020-10-02T00:00:00+00:00">
<meta property="article:modified_time" content="2020-10-02T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Using CloudFront as a Reverse Proxy">
<meta name=twitter:description content="Alternate title: How to be master of your domain.
The basic idea of this post is to demonstrate how CloudFront can be utilized as a serverless reverse-proxy, allowing you to host all of your application&rsquo;s content and services from a single domain. This minimizes a project&rsquo;s TLD footprint while providing project organization and performance along the way.
Why Within large organizations, bureaucracy can make it a challenge to obtain a subdomain for a project.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alukach.com/posts/"},{"@type":"ListItem","position":2,"name":"Using CloudFront as a Reverse Proxy","item":"https://alukach.com/posts/using-cloudfont-as-a-reverse-proxy/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Using CloudFront as a Reverse Proxy","name":"Using CloudFront as a Reverse Proxy","description":"Alternate title: How to be master of your domain.\nThe basic idea of this post is to demonstrate how CloudFront can be utilized as a serverless reverse-proxy, allowing you to host all of your application\u0026rsquo;s content and services from a single domain. This minimizes a project\u0026rsquo;s TLD footprint while providing project organization and performance along the way.\nWhy Within large organizations, bureaucracy can make it a challenge to obtain a subdomain for a project.","keywords":["python","aws","cdk","cloudfront"],"articleBody":"Alternate title: How to be master of your domain.\nThe basic idea of this post is to demonstrate how CloudFront can be utilized as a serverless reverse-proxy, allowing you to host all of your application’s content and services from a single domain. This minimizes a project’s TLD footprint while providing project organization and performance along the way.\nWhy Within large organizations, bureaucracy can make it a challenge to obtain a subdomain for a project. This means that utilizing multiple service-specific subdomains (e.g. api.my-project.big-institution.gov or thumbnails.my-project.big-institution.gov) is an arduous process. To avoid this in a recent project, we settled on adopting a pattern where we use CloudFront to proxy all of our domain’s incoming requests to their appropriate service.\nHow it works CloudFront has the ability to support multiple origin configurations (i.e. multiple sources of content). We can utilize the Path Pattern setting to direct web requests by URL path to their appropriate service. CloudFront behaves like a typical router libraries, wherein it routes traffic to the first path with a pattern matching the incoming request and routes requests that don’t match route patterns to a default route. For example, our current infrastructure looks like this:\nmy-project.big-institution.gov/ ├── api/* Single Page Applications An S3 bucket configured for website hosting acts as the origin for our default route. If an incoming request’s path does not match routes specified elsewhere within the CloudFront distribution, it is routed to the single page application. To configure the single page application to handle any requests provided (i.e. not just requests sent to paths of existing files within the bucket, such as index.html or app.js), the bucket should be configured with a custom error page in response to 404 errors, returning the applications HTML entrypoint (index.html).\nRequirements To enable the usage of a custom error page, the S3 bucket’s website endpoint (i.e. .s3-website-.amazonaws.com, not .s3..amazonaws.com) must be configured as a custom origin for the distribution. Additionally, the bucket must be configured for public access. More information: Using Amazon S3 Buckets Configured as Website Endpoints for Your Origin. Being that the S3 website endpoint does not support SSL, the custom origin’s Protocol Policy should be set to HTTP Only.\n My bucket is private. Can CloudFront serve a website from this bucket?\n If your bucket is private, the website endpoint will not work (source). You could configure CloudFront to send traffic to the buckets REST API endpoint, however this will prevent you from being able to utilize S3’s custom error document feature which may be essential for hosting single page applications on S3. Tools like Next.js and [Gatsby.js] support rendering HTML documents for all routes, which can avoid the need for custom error pages; however care must be given to ensure that any dynamic portion of the page’s routes (e.g. /docs/3, where 3 is the ID of a record to be fetched from an API) must be specified as either a query parameter (e.g. /docs?3) or a hash (e.g. `/docs#3).\n CloudFront itself has support for custom error pages. Why can’t I use that to enable hosting private S3 buckets as websites?\n While it is true that CloudFront can route error responses to custom pages (e.g. sending all 404 responses the contents of s3://my-website-bucket/index.html), these custom error pages apply to the entirety of your CloudFront distribution. This is likely undesirable for any API services hosted by your CloudFront distribution. For example, if a user accesses a RESTful API at http://my-website.com/api/notes/12345 and the API server responds with a 404 of {\"details\": \"Record not found\"}, the response body will be re-written to contain the contents of s3://my-website-bucket/index.html. At time of writing, I am unaware of any capability of applying custom error pages to only certain content-types. A feature such as this might make distribution-wide custom error pages a viable solution.\nAPIs APIs are served as custom origins, with their Domain Name settings pointing to their an ALB’s DNS name.\n Does this work with APIs run with Lambda or EC2?\n Assuming that the service has a DNS name, it can be set up as an origin for CloudFront. This means that for an endpoint handled by a Lambda function, you would need to have it served behind an API Gateway or an ALB.\nRecommended configuration  Disable caching by setting the default, minimum, and maximum TTL to 0 seconds. Set AllowedMethods to forward all requests (i.e. GET, HEAD, OPTIONS, PUT, PATCH, POST, and DELETE). Set ForwardedValues so that querystring and the following headers are fowarded: referer, authorization, origin, accept, host Origin Protocol Policy of HTTP Only.  Data from S3 Buckets Data from a standard S3 bucket can be configured by pointing to the bucket’s REST endpoint (e.g. .s3..amazonaws.com). More information: Using Amazon S3 Buckets for Your Origin.\nThis can be a public bucket, in which case would benefit from the CDN and caching provided by CloudFront.\nWhen using a private bucket, CloudFront additionally can serve as a “trusted signer” to enable an application with access to the CloudFront security keys to create signed URLs/cookies to grant temporary access to particular private content. In order for CloudFront to access content within a private bucket, its Origin Access Identity must be given read privileges within the bucket’s policy. More information: Restricting Access to Amazon S3 Content by Using an Origin Access Identity\nCaveats The most substantial issue with this technique is the fact that CloudFront does not have the capability to remove portions of a path from a request’s URL. For example, if an API is configured as an origin at https://d1234abcde.cloudfront.net/api, it should be configured to respond to URLs starting with /api. This is often a non-issue, as many server frameworks have builtin support to support being hosted at a non-root path.\n Configuring FastAPI to be served under a non-root path 1 2 3 4 5 6 7 8 9 10 11 12  from fastapi import FastAPI, APIRouter API_BASE_PATH = '/api' app = FastAPI( title=\"Example API\", docs_url=API_BASE_PATH, swagger_ui_oauth2_redirect_url=f\"{API_BASE_PATH}/oauth2-redirect\", openapi_url=f\"{API_BASE_PATH}/openapi.json\", ) api_router = APIRouter() app.include_router(router, prefix=API_BASE_PATH)    Furthermore, if you have an S3 bucket serving content from https://d1234abcde.cloudfront.net/bucket, only keys with a prefix of bucket/ will be available to that origin. In the event that keys are not prefixed with a path matching the origins configured path pattern, there are two options:\n Move all of the files, likely utilizing something like S3 Batch (see #253 for more details) Use a Lambda@Edge function to rewrite the path of any incoming request for a non-cached resource to conform to the key structure of the S3 bucket’s objects.  Summary After learning this technique, it feels kind of obvious. I’m honestly not sure if this is AWS 101 level technique or something that is rarely done; however I never knew of it before this project and therefore felt it was worth sharing.\nA quick summary of some of the advantages that come with using CloudFront for all application endpoints:\n It feels generally tidier to have all your endpoints placed behind a single domain. No more dealing with ugly ALB, API Gateway, or S3 URLs. This additionally pays off when you are dealing with multiple stages (e.g. prod and dev) of the same service 🧹. SSL is managed and terminated at CloudFront. Everything after that is port 80 non-SSL traffic, simplifying the management of certificates 🔒. All non-SSL traffic can be set to auto-redirect to SSL endpoints ↩️. Out of the box, AWS Shield Standard is applied to CloudFront to provide protection against DDoS attacks 🏰. Static content is regionally cached and served from Edge Locations closer to the viewer 🌏. Dynamic content is also served from Edge Locations, which connect to the origin server via AWS' global private network. This is faster than connecting to an origin server over the public internet 🚀. Externally, all data is served from the same domain origin. Goodbye CORS errors 👋! Data egress costs are lower through CloudFront than other services. This can be ensured by only selecting Price Class 100, other price classes can be chosen if enabling a global CDN is worth the higher egress costs 💴.  Example  An example of a reverse-proxy CloudFront Distribution written with CDK in Python 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125  from aws_cdk import ( aws_s3 as s3, aws_certificatemanager as certmgr, aws_iam as iam, aws_cloudfront as cf, aws_elasticloadbalancingv2 as elbv2, core, ) class CloudfrontDistribution(core.Construct): def __init__( self, scope: core.Construct, id: str, api_lb: elbv2.ApplicationLoadBalancer, assets_bucket: s3.Bucket, website_bucket: s3.Bucket, domain_name: str = None, using_gcc_acct: bool = False, **kwargs, ) - None: super().__init__(scope, id, **kwargs) oai = cf.OriginAccessIdentity( self, \"Identity\", comment=\"Allow CloudFront to access S3 Bucket\", ) if not using_gcc_acct: self.grant_oai_read(oai, assets_bucket) certificate = ( certmgr.Certificate(self, \"Certificate\", domain_name=domain_name) if domain_name else None ) self.distribution = cf.CloudFrontWebDistribution( self, core.Stack.of(self).stack_name, alias_configuration=( cf.AliasConfiguration( acm_cert_ref=certificate.certificate_arn, names=[domain_name] ) if certificate else None ), comment=core.Stack.of(self).stack_name, origin_configs=[ # Frontend Website cf.SourceConfiguration( # NOTE: Can't use S3OriginConfig because we want to treat our # bucket as an S3 Website Endpoint rather than an S3 REST API # Endpoint. This allows us to use a custom error document to # direct all requests to a single HTML document (as required # to host an SPA). custom_origin_source=cf.CustomOriginConfig( domain_name=website_bucket.bucket_website_domain_name, origin_protocol_policy=cf.OriginProtocolPolicy.HTTP_ONLY, # In website-mode, S3 only serves HTTP # noqa: E501 ), behaviors=[cf.Behavior(is_default_behavior=True)], ), # API load balancer cf.SourceConfiguration( custom_origin_source=cf.CustomOriginConfig( domain_name=api_lb.load_balancer_dns_name, origin_protocol_policy=cf.OriginProtocolPolicy.HTTP_ONLY, ), behaviors=[ cf.Behavior( path_pattern=\"/api*\", # No trailing slash to permit access to root path of API # noqa: E501 allowed_methods=cf.CloudFrontAllowedMethods.ALL, forwarded_values={ \"query_string\": True, \"headers\": [ \"referer\", \"authorization\", \"origin\", \"accept\", \"host\", # Required to prevent API's redirects on trailing slashes directing users to ALB endpoint # noqa: E501 ], }, # Disable caching default_ttl=core.Duration.seconds(0), min_ttl=core.Duration.seconds(0), max_ttl=core.Duration.seconds(0), ) ], ), # Assets cf.SourceConfiguration( s3_origin_source=cf.S3OriginConfig( s3_bucket_source=assets_bucket, origin_access_identity=oai, ), behaviors=[ cf.Behavior( path_pattern=\"/storage/*\", trusted_signers=[\"self\"], ) ], ), ], ) self.assets_path = f\"https://{self.distribution.domain_name}/storage\" core.CfnOutput(self, \"Endpoint\", value=self.distribution.domain_name) def grant_oai_read(self, oai: cf.OriginAccessIdentity, bucket: s3.Bucket): \"\"\" To grant read access to our OAI, at time of writing we can not simply use `bucket.grant_read(oai)`. This is due to the fact that we are looking up our bucket by its name. For more information, see the following: https://stackoverflow.com/a/60917015/728583. As a work-around, we can manually assigned a policy statement, however this does not work in situations where a policy is already applied to the bucket (e.g. in GCC environments). \"\"\" policy_statement = iam.PolicyStatement( actions=[\"s3:GetObject*\", \"s3:List*\"], resources=[bucket.bucket_arn, f\"{bucket.bucket_arn}/storage*\"], principals=[], ) policy_statement.add_canonical_user_principal( oai.cloud_front_origin_access_identity_s3_canonical_user_id ) assets_policy = s3.BucketPolicy(self, \"AssetsPolicy\", bucket=bucket) assets_policy.document.add_statements(policy_statement)    Additional reading  Amazon S3 + Amazon CloudFront: A Match Made in the Cloud Dynamic Whole Site Delivery with Amazon CloudFront  ","wordCount":"1927","inLanguage":"en","datePublished":"2020-10-02T00:00:00Z","dateModified":"2020-10-02T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://alukach.com/posts/using-cloudfont-as-a-reverse-proxy/"},"publisher":{"@type":"Organization","name":"anthony lukach","logo":{"@type":"ImageObject","url":"https://alukach.com/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://alukach.com/ accesskey=h title="anthony lukach (Alt + H)">anthony lukach</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://alukach.com/ title=Home>
<span>Home</span>
</a>
</li>
<li>
<a href=https://alukach.com/categories/posts title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://alukach.com/categories/snippets title=Snippets>
<span>Snippets</span>
</a>
</li>
<li>
<a href=https://alukach.com/search title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://alukach.com/resume title=Resume>
<span>Resume</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Using CloudFront as a Reverse Proxy
</h1>
<div class=post-meta><span title="2020-10-02 00:00:00 +0000 UTC">October 2, 2020</span>&nbsp;·&nbsp;10 min&nbsp;|&nbsp;<a href=https://github.com/alukach/alukach.github.io/edit/main/content/posts/using-cloudfont-as-a-reverse-proxy.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#why aria-label=Why>Why</a></li>
<li>
<a href=#how-it-works aria-label="How it works">How it works</a><ul>
<li>
<a href=#single-page-applications aria-label="Single Page Applications">Single Page Applications</a><ul>
<li>
<a href=#requirements aria-label=Requirements>Requirements</a></li></ul>
</li>
<li>
<a href=#apis aria-label=APIs>APIs</a><ul>
<li>
<a href=#recommended-configuration aria-label="Recommended configuration">Recommended configuration</a></li></ul>
</li>
<li>
<a href=#data-from-s3-buckets aria-label="Data from S3 Buckets">Data from S3 Buckets</a></li></ul>
</li>
<li>
<a href=#caveats aria-label=Caveats>Caveats</a></li>
<li>
<a href=#summary aria-label=Summary>Summary</a></li>
<li>
<a href=#example aria-label=Example>Example</a></li>
<li>
<a href=#additional-reading aria-label="Additional reading">Additional reading</a>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><p><em>Alternate title: How to be master of your domain.</em></p>
<p>The basic idea of this post is to demonstrate how CloudFront can be utilized as a serverless <a href=https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/>reverse-proxy</a>, allowing you to host all of your application&rsquo;s content and services from a single domain. This minimizes a project&rsquo;s <a href=https://en.wikipedia.org/wiki/Top-level_domain>TLD</a> footprint while providing project organization and performance along the way.</p>
<h2 id=why>Why<a hidden class=anchor aria-hidden=true href=#why>#</a></h2>
<p>Within large organizations, bureaucracy can make it a challenge to obtain a subdomain for a project. This means that utilizing multiple service-specific subdomains (e.g. <code>api.my-project.big-institution.gov</code> or <code>thumbnails.my-project.big-institution.gov</code>) is an arduous process. To avoid this in a recent project, we settled on adopting a pattern where we use CloudFront to proxy all of our domain&rsquo;s incoming requests to their appropriate service.</p>
<h2 id=how-it-works>How it works<a hidden class=anchor aria-hidden=true href=#how-it-works>#</a></h2>
<p>CloudFront has the ability to support multiple origin configurations (i.e. multiple sources of content). We can utilize the <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesPathPattern>Path Pattern</a> setting to direct web requests by URL path to their appropriate service. CloudFront behaves like a typical router libraries, wherein it routes traffic to the first path with a pattern matching the incoming request and routes requests that don&rsquo;t match route patterns to a default route. For example, our current infrastructure looks like this:</p>
<pre tabindex=0><code>my-project.big-institution.gov/
├── api/*         &lt;- Application Load Balancer (ALB) that distributes traffic to order
│                    management API service running on Elastic Container Service (ECS).
│
├── stac/*        &lt;- ALB that distributes traffic to STAC API service running on ECS.
│
├── storage/*     &lt;- Private S3 bucket storing private data. Only URLs that have been
│                    signed with our CloudFront keypair will be successful.
│
├── thumbnails/*  &lt;- Public S3 bucket storing thumbnail imagery.
│
└── *             &lt;- Public S3 website bucket storing our single page application frontend.
</code></pre><h3 id=single-page-applications>Single Page Applications<a hidden class=anchor aria-hidden=true href=#single-page-applications>#</a></h3>
<p>An S3 bucket configured for <a href=https://docs.aws.amazon.com/AmazonS3/latest/dev/WebsiteHosting.html>website hosting</a> acts as the origin for our default route. If an incoming request&rsquo;s path does not match routes specified elsewhere within the CloudFront distribution, it is routed to the single page application. To configure the single page application to handle any requests provided (i.e. not just requests sent to paths of existing files within the bucket, such as <code>index.html</code> or <code>app.js</code>), the bucket should be configured with a <a href=https://docs.aws.amazon.com/AmazonS3/latest/dev/CustomErrorDocSupport.html>custom error page</a> in response to <code>404</code> errors, returning the applications HTML entrypoint (<code>index.html</code>).</p>
<h4 id=requirements>Requirements<a hidden class=anchor aria-hidden=true href=#requirements>#</a></h4>
<p>To enable the usage of a custom error page, the S3 bucket&rsquo;s website endpoint (i.e. <code>&lt;bucket-name>.s3-website-&lt;region>.amazonaws.com</code>, not <code>&lt;bucket-name>.s3.&lt;region>.amazonaws.com</code>) must be configured as a custom origin for the distribution. Additionally, the bucket must be configured for public access. More information: <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/DownloadDistS3AndCustomOrigins.html#concept_S3Origin_website>Using Amazon S3 Buckets Configured as Website Endpoints for Your Origin</a>. Being that the S3 website endpoint does not support SSL, the custom origin&rsquo;s <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesOriginProtocolPolicy>Protocol Policy</a> should be set to HTTP Only.</p>
<blockquote>
<p>My bucket is private. Can CloudFront serve a website from this bucket?</p>
</blockquote>
<p>If your bucket is private, the website endpoint will not work (<a href=https://aws.amazon.com/premiumsupport/knowledge-center/s3-cloudfront-website-access/>source</a>). You could configure CloudFront to send traffic to the buckets REST API endpoint, however this will prevent you from being able to utilize S3&rsquo;s custom error document feature which may be essential for hosting single page applications on S3. Tools like <a href=https://nextjs.org/>Next.js</a> and [Gatsby.js] support rendering HTML documents for all routes, which can avoid the need for custom error pages; however care must be given to ensure that any dynamic portion of the page&rsquo;s routes (e.g. <code>/docs/3</code>, where <code>3</code> is the ID of a record to be fetched from an API) must be specified as either a query parameter (e.g. <code>/docs?3</code>) or a hash (e.g. `/docs#3).</p>
<blockquote>
<p>CloudFront itself has support for custom error pages. Why can&rsquo;t I use that to enable hosting private S3 buckets as websites?</p>
</blockquote>
<p>While it is true that CloudFront can route error responses to custom pages (e.g. sending all <code>404</code> responses the contents of <code>s3://my-website-bucket/index.html</code>), these custom error pages apply to the entirety of your CloudFront distribution. This is likely undesirable for any API services hosted by your CloudFront distribution. For example, if a user accesses a RESTful API at <code>http://my-website.com/api/notes/12345</code> and the API server responds with a <code>404</code> of <code>{"details": "Record not found"}</code>, the response body will be re-written to contain the contents of <code>s3://my-website-bucket/index.html</code>. <em>At time of writing, I am unaware of any capability of applying custom error pages to only certain content-types. A feature such as this might make distribution-wide custom error pages a viable solution.</em></p>
<h3 id=apis>APIs<a hidden class=anchor aria-hidden=true href=#apis>#</a></h3>
<p>APIs are served as custom origins, with their <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesDomainName>Domain Name</a> settings pointing to their an ALB&rsquo;s DNS name.</p>
<blockquote>
<p>Does this work with APIs run with Lambda or EC2?</p>
</blockquote>
<p>Assuming that the service has a DNS name, it can be set up as an origin for CloudFront. This means that for an endpoint handled by a Lambda function, you would need to have it served behind an API Gateway or an ALB.</p>
<h4 id=recommended-configuration>Recommended configuration<a hidden class=anchor aria-hidden=true href=#recommended-configuration>#</a></h4>
<ul>
<li><a href=https://aws.amazon.com/premiumsupport/knowledge-center/prevent-cloudfront-from-caching-files/>Disable caching</a> by setting the default, minimum, and maximum TTL to <code>0</code> seconds.</li>
<li>Set <a href=https://docs.aws.amazon.com/cloudfront/latest/APIReference/API_AllowedMethods.html>AllowedMethods</a> to forward all requests (i.e. <code>GET</code>, <code>HEAD</code>, <code>OPTIONS</code>, <code>PUT</code>, <code>PATCH</code>, <code>POST</code>, and <code>DELETE</code>).</li>
<li>Set <a href=https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-cloudfront-distribution-forwardedvalues.html>ForwardedValues</a> so that querystring and the following headers are fowarded: <code>referer</code>, <code>authorization</code>, <code>origin</code>, <code>accept</code>, <code>host</code></li>
<li><a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/distribution-web-values-specify.html#DownloadDistValuesOriginProtocolPolicy>Origin Protocol Policy</a> of HTTP Only.</li>
</ul>
<h3 id=data-from-s3-buckets>Data from S3 Buckets<a hidden class=anchor aria-hidden=true href=#data-from-s3-buckets>#</a></h3>
<p>Data from a standard S3 bucket can be configured by pointing to the bucket&rsquo;s REST endpoint (e.g. <code>&lt;bucket-name>.s3.&lt;region>.amazonaws.com</code>). More information: <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/DownloadDistS3AndCustomOrigins.html>Using Amazon S3 Buckets for Your Origin</a>.</p>
<p>This can be a public bucket, in which case would benefit from the CDN and caching provided by CloudFront.</p>
<p>When using a private bucket, CloudFront additionally can serve as a &ldquo;trusted signer&rdquo; to enable an application with access to the CloudFront security keys to create signed URLs/cookies to grant temporary access to particular private content. In order for CloudFront to access content within a private bucket, its Origin Access Identity must be given read privileges within the bucket&rsquo;s policy. More information: <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-restricting-access-to-s3.html>Restricting Access to Amazon S3 Content by Using an Origin Access Identity</a></p>
<h2 id=caveats>Caveats<a hidden class=anchor aria-hidden=true href=#caveats>#</a></h2>
<p>The most substantial issue with this technique is the fact that CloudFront does not have the capability to remove portions of a path from a request&rsquo;s URL. For example, if an API is configured as an origin at <code>https://d1234abcde.cloudfront.net/api</code>, it should be configured to respond to URLs starting with <code>/api</code>. This is often a non-issue, as many server frameworks have builtin support to support being hosted at a non-root path.</p>
<details>
<summary>Configuring FastAPI to be served under a non-root path</summary>
<div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=color:#2c5dcd;font-weight:700>from</span> fastapi <span style=color:#2c5dcd;font-weight:700>import</span> FastAPI, APIRouter

API_BASE_PATH <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#39;/api&#39;</span>

app <span style=color:#2c5dcd>=</span> FastAPI(
    title<span style=color:#2c5dcd>=</span><span style=color:#0c6>&#34;Example API&#34;</span>,
    docs_url<span style=color:#2c5dcd>=</span>API_BASE_PATH,
    swagger_ui_oauth2_redirect_url<span style=color:#2c5dcd>=</span><span style=color:#0c6>f</span><span style=color:#0c6>&#34;</span><span style=color:#0c6>{</span>API_BASE_PATH<span style=color:#0c6>}</span><span style=color:#0c6>/oauth2-redirect&#34;</span>,
    openapi_url<span style=color:#2c5dcd>=</span><span style=color:#0c6>f</span><span style=color:#0c6>&#34;</span><span style=color:#0c6>{</span>API_BASE_PATH<span style=color:#0c6>}</span><span style=color:#0c6>/openapi.json&#34;</span>,
)
api_router <span style=color:#2c5dcd>=</span> APIRouter()
app<span style=color:#2c5dcd>.</span>include_router(router, prefix<span style=color:#2c5dcd>=</span>API_BASE_PATH)
</code></pre></td></tr></table>
</div>
</div></details>
<p>Furthermore, if you have an S3 bucket serving content from <code>https://d1234abcde.cloudfront.net/bucket</code>, only keys with a prefix of <code>bucket/</code> will be available to that origin. In the event that keys are not prefixed with a path matching the origins configured path pattern, there are two options:</p>
<ol>
<li>Move all of the files, likely utilizing something like S3 Batch (see #253 for more details)</li>
<li>Use a Lambda@Edge function to rewrite the path of any incoming request for a non-cached resource to conform to the key structure of the S3 bucket&rsquo;s objects.</li>
</ol>
<h2 id=summary>Summary<a hidden class=anchor aria-hidden=true href=#summary>#</a></h2>
<p>After learning this technique, it feels kind of obvious. I&rsquo;m honestly not sure if this is AWS 101 level technique or something that is rarely done; however I never knew of it before this project and therefore felt it was worth sharing.</p>
<p>A quick summary of some of the advantages that come with using CloudFront for all application endpoints:</p>
<ul>
<li>It feels generally tidier to have all your endpoints placed behind a single domain. No more dealing with ugly ALB, API Gateway, or S3 URLs. This additionally pays off when you are dealing with multiple stages (e.g. <code>prod</code> and <code>dev</code>) of the same service 🧹.</li>
<li>SSL is managed and terminated at CloudFront. Everything after that is port 80 non-SSL traffic, simplifying the management of certificates 🔒.</li>
<li>All non-SSL traffic can be set to auto-redirect to SSL endpoints ↩️.</li>
<li>Out of the box, AWS Shield Standard is applied to CloudFront to provide protection against DDoS attacks 🏰.</li>
<li>Static content is regionally cached and served from <a href=https://aws.amazon.com/cloudfront/features/#Amazon_CloudFront_Infrastructure>Edge Locations</a> closer to the viewer 🌏.</li>
<li>Dynamic content is also served from Edge Locations, which connect to the origin server via AWS' global private network. This is faster than connecting to an origin server over the public internet 🚀.</li>
<li>Externally, all data is served from the same domain origin. Goodbye CORS errors 👋!</li>
<li>Data egress costs are lower through CloudFront than other services. This can be ensured by only selecting <a href=https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/PriceClass.html>Price Class 100</a>, other price classes can be chosen if enabling a global CDN is worth the higher egress costs 💴.</li>
</ul>
<h2 id=example>Example<a hidden class=anchor aria-hidden=true href=#example>#</a></h2>
<details>
<summary>An example of a reverse-proxy CloudFront Distribution written with CDK in Python</summary>
<div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">120
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">121
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">122
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">123
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">124
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">125
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=color:#2c5dcd;font-weight:700>from</span> aws_cdk <span style=color:#2c5dcd;font-weight:700>import</span> (
    aws_s3 <span style=color:#2c5dcd;font-weight:700>as</span> s3,
    aws_certificatemanager <span style=color:#2c5dcd;font-weight:700>as</span> certmgr,
    aws_iam <span style=color:#2c5dcd;font-weight:700>as</span> iam,
    aws_cloudfront <span style=color:#2c5dcd;font-weight:700>as</span> cf,
    aws_elasticloadbalancingv2 <span style=color:#2c5dcd;font-weight:700>as</span> elbv2,
    core,
)


<span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>CloudfrontDistribution</span>(core<span style=color:#2c5dcd>.</span>Construct):
    <span style=color:#2c5dcd;font-weight:700>def</span> __init__(
        self,
        scope: core<span style=color:#2c5dcd>.</span>Construct,
        <span style=color:#5918bb;font-weight:700>id</span>: <span style=color:#5918bb;font-weight:700>str</span>,
        api_lb: elbv2<span style=color:#2c5dcd>.</span>ApplicationLoadBalancer,
        assets_bucket: s3<span style=color:#2c5dcd>.</span>Bucket,
        website_bucket: s3<span style=color:#2c5dcd>.</span>Bucket,
        domain_name: <span style=color:#5918bb;font-weight:700>str</span> <span style=color:#2c5dcd>=</span> <span style=color:#2c5dcd;font-weight:700>None</span>,
        using_gcc_acct: <span style=color:#5918bb;font-weight:700>bool</span> <span style=color:#2c5dcd>=</span> <span style=color:#2c5dcd;font-weight:700>False</span>,
        <span style=color:#2c5dcd>**</span>kwargs,
    ) <span style=color:#2c5dcd>-&gt;</span> <span style=color:#2c5dcd;font-weight:700>None</span>:
        <span style=color:#5918bb;font-weight:700>super</span>()<span style=color:#2c5dcd>.</span>__init__(scope, <span style=color:#5918bb;font-weight:700>id</span>, <span style=color:#2c5dcd>**</span>kwargs)

        oai <span style=color:#2c5dcd>=</span> cf<span style=color:#2c5dcd>.</span>OriginAccessIdentity(
            self, <span style=color:#0c6>&#34;Identity&#34;</span>, comment<span style=color:#2c5dcd>=</span><span style=color:#0c6>&#34;Allow CloudFront to access S3 Bucket&#34;</span>,
        )
        <span style=color:#2c5dcd;font-weight:700>if</span> <span style=color:#2c5dcd;font-weight:700>not</span> using_gcc_acct:
            self<span style=color:#2c5dcd>.</span>grant_oai_read(oai, assets_bucket)

        certificate <span style=color:#2c5dcd>=</span> (
            certmgr<span style=color:#2c5dcd>.</span>Certificate(self, <span style=color:#0c6>&#34;Certificate&#34;</span>, domain_name<span style=color:#2c5dcd>=</span>domain_name)
            <span style=color:#2c5dcd;font-weight:700>if</span> domain_name
            <span style=color:#2c5dcd;font-weight:700>else</span> <span style=color:#2c5dcd;font-weight:700>None</span>
        )

        self<span style=color:#2c5dcd>.</span>distribution <span style=color:#2c5dcd>=</span> cf<span style=color:#2c5dcd>.</span>CloudFrontWebDistribution(
            self,
            core<span style=color:#2c5dcd>.</span>Stack<span style=color:#2c5dcd>.</span>of(self)<span style=color:#2c5dcd>.</span>stack_name,
            alias_configuration<span style=color:#2c5dcd>=</span>(
                cf<span style=color:#2c5dcd>.</span>AliasConfiguration(
                    acm_cert_ref<span style=color:#2c5dcd>=</span>certificate<span style=color:#2c5dcd>.</span>certificate_arn, names<span style=color:#2c5dcd>=</span>[domain_name]
                )
                <span style=color:#2c5dcd;font-weight:700>if</span> certificate
                <span style=color:#2c5dcd;font-weight:700>else</span> <span style=color:#2c5dcd;font-weight:700>None</span>
            ),
            comment<span style=color:#2c5dcd>=</span>core<span style=color:#2c5dcd>.</span>Stack<span style=color:#2c5dcd>.</span>of(self)<span style=color:#2c5dcd>.</span>stack_name,
            origin_configs<span style=color:#2c5dcd>=</span>[
                <span style=color:#0080ff;font-style:italic># Frontend Website</span>
                cf<span style=color:#2c5dcd>.</span>SourceConfiguration(
                    <span style=color:#0080ff;font-style:italic># NOTE: Can&#39;t use S3OriginConfig because we want to treat our</span>
                    <span style=color:#0080ff;font-style:italic># bucket as an S3 Website Endpoint rather than an S3 REST API</span>
                    <span style=color:#0080ff;font-style:italic># Endpoint. This allows us to use a custom error document to</span>
                    <span style=color:#0080ff;font-style:italic># direct all requests to a single HTML document (as required</span>
                    <span style=color:#0080ff;font-style:italic># to host an SPA).</span>
                    custom_origin_source<span style=color:#2c5dcd>=</span>cf<span style=color:#2c5dcd>.</span>CustomOriginConfig(
                        domain_name<span style=color:#2c5dcd>=</span>website_bucket<span style=color:#2c5dcd>.</span>bucket_website_domain_name,
                        origin_protocol_policy<span style=color:#2c5dcd>=</span>cf<span style=color:#2c5dcd>.</span>OriginProtocolPolicy<span style=color:#2c5dcd>.</span>HTTP_ONLY,  <span style=color:#0080ff;font-style:italic># In website-mode, S3 only serves HTTP # noqa: E501</span>
                    ),
                    behaviors<span style=color:#2c5dcd>=</span>[cf<span style=color:#2c5dcd>.</span>Behavior(is_default_behavior<span style=color:#2c5dcd>=</span><span style=color:#2c5dcd;font-weight:700>True</span>)],
                ),
                <span style=color:#0080ff;font-style:italic># API load balancer</span>
                cf<span style=color:#2c5dcd>.</span>SourceConfiguration(
                    custom_origin_source<span style=color:#2c5dcd>=</span>cf<span style=color:#2c5dcd>.</span>CustomOriginConfig(
                        domain_name<span style=color:#2c5dcd>=</span>api_lb<span style=color:#2c5dcd>.</span>load_balancer_dns_name,
                        origin_protocol_policy<span style=color:#2c5dcd>=</span>cf<span style=color:#2c5dcd>.</span>OriginProtocolPolicy<span style=color:#2c5dcd>.</span>HTTP_ONLY,
                    ),
                    behaviors<span style=color:#2c5dcd>=</span>[
                        cf<span style=color:#2c5dcd>.</span>Behavior(
                            path_pattern<span style=color:#2c5dcd>=</span><span style=color:#0c6>&#34;/api*&#34;</span>,  <span style=color:#0080ff;font-style:italic># No trailing slash to permit access to root path of API # noqa: E501</span>
                            allowed_methods<span style=color:#2c5dcd>=</span>cf<span style=color:#2c5dcd>.</span>CloudFrontAllowedMethods<span style=color:#2c5dcd>.</span>ALL,
                            forwarded_values<span style=color:#2c5dcd>=</span>{
                                <span style=color:#0c6>&#34;query_string&#34;</span>: <span style=color:#2c5dcd;font-weight:700>True</span>,
                                <span style=color:#0c6>&#34;headers&#34;</span>: [
                                    <span style=color:#0c6>&#34;referer&#34;</span>,
                                    <span style=color:#0c6>&#34;authorization&#34;</span>,
                                    <span style=color:#0c6>&#34;origin&#34;</span>,
                                    <span style=color:#0c6>&#34;accept&#34;</span>,
                                    <span style=color:#0c6>&#34;host&#34;</span>,  <span style=color:#0080ff;font-style:italic># Required to prevent API&#39;s redirects on trailing slashes directing users to ALB endpoint # noqa: E501</span>
                                ],
                            },
                            <span style=color:#0080ff;font-style:italic># Disable caching</span>
                            default_ttl<span style=color:#2c5dcd>=</span>core<span style=color:#2c5dcd>.</span>Duration<span style=color:#2c5dcd>.</span>seconds(<span style=color:#5918bb;font-weight:700>0</span>),
                            min_ttl<span style=color:#2c5dcd>=</span>core<span style=color:#2c5dcd>.</span>Duration<span style=color:#2c5dcd>.</span>seconds(<span style=color:#5918bb;font-weight:700>0</span>),
                            max_ttl<span style=color:#2c5dcd>=</span>core<span style=color:#2c5dcd>.</span>Duration<span style=color:#2c5dcd>.</span>seconds(<span style=color:#5918bb;font-weight:700>0</span>),
                        )
                    ],
                ),
                <span style=color:#0080ff;font-style:italic># Assets</span>
                cf<span style=color:#2c5dcd>.</span>SourceConfiguration(
                    s3_origin_source<span style=color:#2c5dcd>=</span>cf<span style=color:#2c5dcd>.</span>S3OriginConfig(
                        s3_bucket_source<span style=color:#2c5dcd>=</span>assets_bucket, origin_access_identity<span style=color:#2c5dcd>=</span>oai,
                    ),
                    behaviors<span style=color:#2c5dcd>=</span>[
                        cf<span style=color:#2c5dcd>.</span>Behavior(
                            path_pattern<span style=color:#2c5dcd>=</span><span style=color:#0c6>&#34;/storage/*&#34;</span>, trusted_signers<span style=color:#2c5dcd>=</span>[<span style=color:#0c6>&#34;self&#34;</span>],
                        )
                    ],
                ),
            ],
        )
        self<span style=color:#2c5dcd>.</span>assets_path <span style=color:#2c5dcd>=</span> <span style=color:#0c6>f</span><span style=color:#0c6>&#34;https://</span><span style=color:#0c6>{</span>self<span style=color:#2c5dcd>.</span>distribution<span style=color:#2c5dcd>.</span>domain_name<span style=color:#0c6>}</span><span style=color:#0c6>/storage&#34;</span>
        core<span style=color:#2c5dcd>.</span>CfnOutput(self, <span style=color:#0c6>&#34;Endpoint&#34;</span>, value<span style=color:#2c5dcd>=</span>self<span style=color:#2c5dcd>.</span>distribution<span style=color:#2c5dcd>.</span>domain_name)

    <span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>grant_oai_read</span>(self, oai: cf<span style=color:#2c5dcd>.</span>OriginAccessIdentity, bucket: s3<span style=color:#2c5dcd>.</span>Bucket):
        <span style=color:#0c6>&#34;&#34;&#34;
</span><span style=color:#0c6>        To grant read access to our OAI, at time of writing we can not simply use
</span><span style=color:#0c6>        `bucket.grant_read(oai)`. This is due to the fact that we are looking up
</span><span style=color:#0c6>        our bucket by its name. For more information, see the following:
</span><span style=color:#0c6>        https://stackoverflow.com/a/60917015/728583.
</span><span style=color:#0c6>
</span><span style=color:#0c6>        As a work-around, we can manually assigned a policy statement, however
</span><span style=color:#0c6>        this does not work in situations where a policy is already applied to
</span><span style=color:#0c6>        the bucket (e.g. in GCC environments).
</span><span style=color:#0c6>        &#34;&#34;&#34;</span>
        policy_statement <span style=color:#2c5dcd>=</span> iam<span style=color:#2c5dcd>.</span>PolicyStatement(
            actions<span style=color:#2c5dcd>=</span>[<span style=color:#0c6>&#34;s3:GetObject*&#34;</span>, <span style=color:#0c6>&#34;s3:List*&#34;</span>],
            resources<span style=color:#2c5dcd>=</span>[bucket<span style=color:#2c5dcd>.</span>bucket_arn, <span style=color:#0c6>f</span><span style=color:#0c6>&#34;</span><span style=color:#0c6>{</span>bucket<span style=color:#2c5dcd>.</span>bucket_arn<span style=color:#0c6>}</span><span style=color:#0c6>/storage*&#34;</span>],
            principals<span style=color:#2c5dcd>=</span>[],
        )
        policy_statement<span style=color:#2c5dcd>.</span>add_canonical_user_principal(
            oai<span style=color:#2c5dcd>.</span>cloud_front_origin_access_identity_s3_canonical_user_id
        )
        assets_policy <span style=color:#2c5dcd>=</span> s3<span style=color:#2c5dcd>.</span>BucketPolicy(self, <span style=color:#0c6>&#34;AssetsPolicy&#34;</span>, bucket<span style=color:#2c5dcd>=</span>bucket)
        assets_policy<span style=color:#2c5dcd>.</span>document<span style=color:#2c5dcd>.</span>add_statements(policy_statement)
</code></pre></td></tr></table>
</div>
</div></details>
<h2 id=additional-reading>Additional reading<a hidden class=anchor aria-hidden=true href=#additional-reading>#</a></h2>
<ul>
<li><a href=https://aws.amazon.com/blogs/networking-and-content-delivery/amazon-s3-amazon-cloudfront-a-match-made-in-the-cloud/>Amazon S3 + Amazon CloudFront: A Match Made in the Cloud</a></li>
<li><a href=https://aws.amazon.com/blogs/networking-and-content-delivery/dynamic-whole-site-delivery-with-amazon-cloudfront/>Dynamic Whole Site Delivery with Amazon CloudFront</a></li>
</ul>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://alukach.com/tags/python/>python</a></li>
<li><a href=https://alukach.com/tags/aws/>aws</a></li>
<li><a href=https://alukach.com/tags/cdk/>cdk</a></li>
<li><a href=https://alukach.com/tags/cloudfront/>cloudfront</a></li>
</ul>
</footer>
</article>
</main>
<footer class=footer>
<span>Anthony Lukach</span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>