<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Tips for working with a large number of files in S3 | anthony lukach</title><meta name=keywords content="python,aws,s3"><meta name=description content="I would argue that S3 is basically AWS&rsquo; best service. It&rsquo;s super cheap, it&rsquo;s basically infinitely scalable, and it never goes down (except for when it does). Part of its beauty is its simplicity. You give it a file and a key to identify that file, you can have faith that it will store it without issue. You give it a key, you can have faith that it will return the file represented by that key, assuming there is one."><meta name=author content><link rel=canonical href=https://alukach.com/posts/tips-for-working-with-a-large-number-of-files-in-s3/><link crossorigin=anonymous href=/assets/css/stylesheet.min.4ba82eb0954ce20ea51d7ca6c3b71ea48dd719c880f27386be309802fedc6b21.css integrity="sha256-S6gusJVM4g6lHXymw7cepI3XGciA8nOGvjCYAv7cayE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.2840b7fccd34145847db71a290569594bdbdb00047097f75d6495d162f5d7dff.js integrity="sha256-KEC3/M00FFhH23GikFaVlL29sABHCX911kldFi9dff8=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://alukach.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://alukach.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://alukach.com/favicon-32x32.png><link rel=apple-touch-icon href=https://alukach.com/apple-touch-icon.png><link rel=mask-icon href=https://alukach.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(e,o,i,a,t,n,s){e.GoogleAnalyticsObject=t,e[t]=e[t]||function(){(e[t].q=e[t].q||[]).push(arguments)},e[t].l=1*new Date,n=o.createElement(i),s=o.getElementsByTagName(i)[0],n.async=1,n.src=a,s.parentNode.insertBefore(n,s)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-16401510-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Tips for working with a large number of files in S3"><meta property="og:description" content="I would argue that S3 is basically AWS&rsquo; best service. It&rsquo;s super cheap, it&rsquo;s basically infinitely scalable, and it never goes down (except for when it does). Part of its beauty is its simplicity. You give it a file and a key to identify that file, you can have faith that it will store it without issue. You give it a key, you can have faith that it will return the file represented by that key, assuming there is one."><meta property="og:type" content="article"><meta property="og:url" content="https://alukach.com/posts/tips-for-working-with-a-large-number-of-files-in-s3/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-05-30T00:00:00+00:00"><meta property="article:modified_time" content="2020-05-30T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Tips for working with a large number of files in S3"><meta name=twitter:description content="I would argue that S3 is basically AWS&rsquo; best service. It&rsquo;s super cheap, it&rsquo;s basically infinitely scalable, and it never goes down (except for when it does). Part of its beauty is its simplicity. You give it a file and a key to identify that file, you can have faith that it will store it without issue. You give it a key, you can have faith that it will return the file represented by that key, assuming there is one."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alukach.com/posts/"},{"@type":"ListItem","position":2,"name":"Tips for working with a large number of files in S3","item":"https://alukach.com/posts/tips-for-working-with-a-large-number-of-files-in-s3/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Tips for working with a large number of files in S3","name":"Tips for working with a large number of files in S3","description":"I would argue that S3 is basically AWS\u0026rsquo; best service. It\u0026rsquo;s super cheap, it\u0026rsquo;s basically infinitely scalable, and it never goes down (except for when it does). Part of its beauty is its simplicity. You give it a file and a key to identify that file, you can have faith that it will store it without issue. You give it a key, you can have faith that it will return the file represented by that key, assuming there is one.","keywords":["python","aws","s3"],"articleBody":"I would argue that S3 is basically AWS’ best service. It’s super cheap, it’s basically infinitely scalable, and it never goes down (except for when it does). Part of its beauty is its simplicity. You give it a file and a key to identify that file, you can have faith that it will store it without issue. You give it a key, you can have faith that it will return the file represented by that key, assuming there is one.\nHowever, when you’ve enlisted S3 to manage a large number of files (1M+), it can get complicated to do anything beyond doing simple writes and retrievals. Fortunately, there are a number of helpers available to make it manageable to working with this scale of data. This post aims to capture some common workflows that may be of use when working with huge S3 buckets.\nListing Files The mere act of listing all of the data within a huge S3 bucket is a challenge. S3’s list-objects API returns a max of 1000 items per request, meaning you’ll have to work through thousands of pages of API responses to fully list all items within the bucket. To make this simpler, we can utilize S3’s Inventory.\n Amazon S3 inventory provides comma-separated values (CSV), Apache optimized row columnar (ORC) or Apache Parquet (Parquet) output files that list your objects and their corresponding metadata on a daily or weekly basis for an S3 bucket or a shared prefix.\n Be aware that it can take up to 48 hours to generate an Inventory Report. From that point forward, reports can be generated on a regular interval.\nAn inventory report serves as a great first-step when attempting to do any processing on an entire bucket of files. Often, you don’t need to retrieve the inventory report manually from S3. Instead, it can be fed into Athena or S3 Batch Operations as described below.\nHowever, when you do need to access the data locally, downloading and reading all of the gzipped CSV files that make up an inventory report can be somewhat tedious. The following script was written to help with this process. Its output can be piped to a local CSV file to create a single output or sent to another function for processing.\n Stream S3 Inventory Report Python script 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  import json import csv import gzip  import boto3  s3 = boto3.resource('s3')   def list_keys(bucket, manifest_key):  manifest = json.load(s3.Object(bucket, manifest_key).get()['Body'])  for obj in manifest['files']:  gzip_obj = s3.Object(bucket_name=bucket, key=obj['key'])  buffer = gzip.open(gzip_obj.get()[\"Body\"], mode='rt')  reader = csv.reader(buffer)  for row in reader:  yield row   if __name__ == '__main__':  bucket = 's3-inventory-output-bucket'  manifest_key = 'path/to/my/inventory/2019-12-15T00-00Z/manifest.json'   for bucket, key, *rest in list_keys(bucket, manifest_key):  print(bucket, key, *rest)    Querying files by S3 Properties Sometimes you may need a subset of the files within S3, based some metadata property of the object (e.g. storage class, the key’s extension). While you can use the S3 list-objects API to list files beginning with a particular prefix, you can not filter by suffix. To get around this limitation, we can utilize AWS Athena to query over an S3 Inventory report.\n 1. Create a table This example assumes that you chose CSV as the S3 Inventory Output Format. For information on other formats, review the docs.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25  CREATEEXTERNALTABLEyour_table_name(`bucket`string,keystring,version_idstring,is_latestboolean,is_delete_markerboolean,sizebigint,last_modified_datetimestamp,e_tagstring,storage_classstring,is_multipart_uploadedboolean,replication_statusstring,encryption_statusstring,object_lock_retain_until_datetimestamp,object_lock_modestring,object_lock_legal_hold_statusstring)PARTITIONEDBY(dtstring)ROWFORMATDELIMITEDFIELDSTERMINATEDBY','ESCAPEDBY'\\\\'LINESTERMINATEDBY'\\n'STOREDASINPUTFORMAT'org.apache.hadoop.hive.ql.io.SymlinkTextInputFormat'OUTPUTFORMAT'org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat'LOCATION's3://destination-prefix/source-bucket/YOUR_CONFIG_ID/hive/';    2. Add inventory reports partitions 1  MSCKREPAIRTABLEyour_table_name;    3. Query for S3 keys by their filename, size, storage class, etc 1 2 3 4  SELECTstorage_class,count(*)ascountFROMyour_table_nameWHEREdt='2019-12-22-00-00'GROUPBYstorage_class   More information about querying Storage Inventory files with Athena can be found here.\nProcessing Files Situations may arise where you need to run all (or a large number) of the files within an S3 bucket through some operation. S3 Batch Operations (not to be confused with AWS Batch) is built to do the following:\n copy objects, set object tags or access control lists (ACLs), initiate object restores from Amazon S3 Glacier, or invoke an AWS Lambda function to perform custom actions using your objects.\n With that last feature, invoking an AWS Lambda function, we can utilize Batch Operations to process a massive number of files without dealing without any of the complexity associated with data-processing infrastructure. Instead, we provide the Batch Operations with a CSV or S3 Inventory Manifest file and a Lambda function to run over each file.\nTo work with S3 Batch Operations, the lambda function must return a particular response object to describe if the process succeeded, failed, or failed but should be retried.\n S3 Batch Operation Boilerplate Python script 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74  import urllib  import boto3 from botocore.exceptions import ClientError  s3 = boto3.resource(\"s3\")   TMP_FAILURE = \"TemporaryFailure\" FAILURE = \"PermanentFailure\" SUCCESS = \"Succeeded\"   def process_object(src_object):  return \"TODO: Populate with processing task...\"   def get_task_id(event):  return event[\"tasks\"][0][\"taskId\"]   def parse_job_parameters(event):  # Parse job parameters from Amazon S3 batch operations  # jobId = event[\"job\"][\"id\"]  invocationId = event[\"invocationId\"]  invocationSchemaVersion = event[\"invocationSchemaVersion\"]  return dict(  invocationId=invocationId, invocationSchemaVersion=invocationSchemaVersion  )   def get_s3_object(event):  # Parse Amazon S3 Key, Key Version, and Bucket ARN  s3Key = urllib.parse.unquote(event[\"tasks\"][0][\"s3Key\"])  s3VersionId = event[\"tasks\"][0][\"s3VersionId\"] # Unused  s3BucketArn = event[\"tasks\"][0][\"s3BucketArn\"]  s3Bucket = s3BucketArn.split(\":::\")[-1]  return s3.Object(s3Bucket, s3Key)   def build_result(status: str, msg: str):  return dict(resultCode=status, resultString=msg)   def handler(event, context):  task_id = get_task_id(event)  job_params = parse_job_parameters(event)  s3_object = get_s3_object(event)   try:  output = process_object(s3_object)  # Mark as succeeded  result = build_result(SUCCESS, output)  except ClientError as e:  # If request timed out, mark as a temp failure  # and Amazon S3 batch operations will make the task for retry. If  # any other exceptions are received, mark as permanent failure.  errorCode = e.response[\"Error\"][\"Code\"]  errorMessage = e.response[\"Error\"][\"Message\"]  if errorCode == \"RequestTimeout\":  result = build_result(  TMP_FAILURE, \"Retry request to Amazon S3 due to timeout.\"  )  else:  result = build_result(FAILURE, f\"{errorCode}: {errorMessage}\")  except Exception as e:  # Catch all exceptions to permanently fail the task  result = build_result(FAILURE, f\"Exception: {e}\")   return {  **job_params,  \"treatMissingKeysAs\": \"PermanentFailure\",  \"results\": [{**result, \"taskId\": task_id}],  }    S3 Batch Operations will then run every key through this Lambda handler, retry temporary failures, and log its results in result files. The result files are conveniently grouped by success/failure status and linked to from a Manifest Result File.\n Example Manifest Result File 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19  {  \"Format\": \"Report_CSV_20180820\",  \"ReportCreationDate\": \"2019-04-05T17:48:39.725Z\",  \"Results\": [  {  \"TaskExecutionStatus\": \"succeeded\",  \"Bucket\": \"my-job-reports\",  \"MD5Checksum\": \"83b1c4cbe93fc893f54053697e10fd6e\",  \"Key\": \"job-f8fb9d89-a3aa-461d-bddc-ea6a1b131955/results/6217b0fab0de85c408b4be96aeaca9b195a7daa5.csv\"  },  {  \"TaskExecutionStatus\": \"failed\",  \"Bucket\": \"my-job-reports\",  \"MD5Checksum\": \"22ee037f3515975f7719699e5c416eaa\",  \"Key\": \"job-f8fb9d89-a3aa-461d-bddc-ea6a1b131955/results/b2ddad417e94331e9f37b44f1faf8c7ed5873f2e.csv\"  }  ],  \"ReportSchema\": \"Bucket, Key, VersionId, TaskStatus, ErrorCode, HTTPStatusCode, ResultMessage\" }    More information about the Complete Report format can be found here.\n At time of writing, S3 Batch Operations cost $0.25 / job + $1 / million S3 objects processed.\nPrice to process 5 million thumbnails in 2hrs:\n S3 Batch Operations: $0.25 + (5 \\* $1) = $5.25 Lambda: 128MB * 2000 ms * 5,000,000 = $21.83 S3 Get Requests: 5,000,000 / 1000 \\* $0.0004 = $2 S3 Put Requests: 5,000,000 / 1000 \\* $0.005 = $25 TOTAL: $54.08  Things not discussed in this post If you are looking for more techniques on querying data stored in S3, consider the following:\n Using Athena to query the contents of your files stored in S3 Using S3 Select to select a subset of a single (very large) file stored in S3  ","wordCount":"1297","inLanguage":"en","datePublished":"2020-05-30T00:00:00Z","dateModified":"2020-05-30T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://alukach.com/posts/tips-for-working-with-a-large-number-of-files-in-s3/"},"publisher":{"@type":"Organization","name":"anthony lukach","logo":{"@type":"ImageObject","url":"https://alukach.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://alukach.com/ accesskey=h title="anthony lukach (Alt + H)">anthony lukach</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://alukach.com/categories/posts title=Posts><span>Posts</span></a></li><li><a href=https://alukach.com/categories/snippets title=Snippets><span>Snippets</span></a></li><li><a href=https://alukach.com/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://alukach.com/resume title=Résumé><span>Résumé</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Tips for working with a large number of files in S3</h1><div class=post-meta><span title="2020-05-30 00:00:00 +0000 UTC">May 30, 2020</span>&nbsp;·&nbsp;7 min&nbsp;|&nbsp;<a href=https://github.com/alukach/alukach.github.io/edit/main/content/posts/tips-for-working-with-a-large-number-of-files-in-s3.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#listing-files aria-label="Listing Files">Listing Files</a></li><li><a href=#querying-files-by-s3-properties aria-label="Querying files by S3 Properties">Querying files by S3 Properties</a></li><li><a href=#processing-files aria-label="Processing Files">Processing Files</a></li><li><a href=#things-not-discussed-in-this-post aria-label="Things not discussed in this post">Things not discussed in this post</a></li></ul></div></details></div><div class=post-content><p>I would argue that S3 is basically AWS&rsquo; best service. It&rsquo;s super cheap, it&rsquo;s basically infinitely scalable, and it never goes down (except for <a href=https://www.theregister.co.uk/2017/03/01/aws_s3_outage/>when it does</a>). Part of its beauty is its simplicity. You give it a file and a key to identify that file, you can have faith that it will store it without issue. You give it a key, you can have faith that it will return the file represented by that key, assuming there is one.</p><p>However, when you&rsquo;ve enlisted S3 to manage a large number of files (1M+), it can get complicated to do anything beyond doing simple writes and retrievals. Fortunately, there are a number of helpers available to make it manageable to working with this scale of data. This post aims to capture some common workflows that may be of use when working with huge S3 buckets.</p><h2 id=listing-files>Listing Files<a hidden class=anchor aria-hidden=true href=#listing-files>#</a></h2><p>The mere act of listing all of the data within a huge S3 bucket is a challenge. S3&rsquo;s <a href=https://docs.aws.amazon.com/cli/latest/reference/s3api/list-objects.html>list-objects API</a> returns a max of 1000 items per request, meaning you&rsquo;ll have to work through thousands of pages of API responses to fully list all items within the bucket. To make this simpler, we can utilize <a href=https://docs.aws.amazon.com/AmazonS3/latest/dev/storage-inventory.html>S3&rsquo;s Inventory</a>.</p><blockquote><p>Amazon S3 inventory provides comma-separated values (CSV), Apache optimized row columnar (ORC) or Apache Parquet (Parquet) output files that list your objects and their corresponding metadata on a daily or weekly basis for an S3 bucket or a shared prefix.</p></blockquote><p>Be aware that it can take up to 48 hours to generate an Inventory Report. From that point forward, reports can be generated on a regular interval.</p><p>An inventory report serves as a great first-step when attempting to do any processing on an entire bucket of files. Often, you don&rsquo;t need to retrieve the inventory report manually from S3. Instead, it can be fed into Athena or S3 Batch Operations as described below.</p><p>However, when you do need to access the data locally, downloading and reading all of the gzipped CSV files that make up an inventory report can be somewhat tedious. The following script was written to help with this process. Its output can be piped to a local CSV file to create a single output or sent to another function for processing.</p><details><summary>Stream S3 Inventory Report Python script</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> json
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> csv
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> gzip
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> boto3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>s3 <span style=color:#2c5dcd>=</span> boto3<span style=color:#2c5dcd>.</span>resource(<span style=color:#0c6>&#39;s3&#39;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>list_keys</span>(bucket, manifest_key):
</span></span><span style=display:flex><span>    manifest <span style=color:#2c5dcd>=</span> json<span style=color:#2c5dcd>.</span>load(s3<span style=color:#2c5dcd>.</span>Object(bucket, manifest_key)<span style=color:#2c5dcd>.</span>get()[<span style=color:#0c6>&#39;Body&#39;</span>])
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>for</span> obj <span style=color:#2c5dcd;font-weight:700>in</span> manifest[<span style=color:#0c6>&#39;files&#39;</span>]:
</span></span><span style=display:flex><span>        gzip_obj <span style=color:#2c5dcd>=</span> s3<span style=color:#2c5dcd>.</span>Object(bucket_name<span style=color:#2c5dcd>=</span>bucket, key<span style=color:#2c5dcd>=</span>obj[<span style=color:#0c6>&#39;key&#39;</span>])
</span></span><span style=display:flex><span>        buffer <span style=color:#2c5dcd>=</span> gzip<span style=color:#2c5dcd>.</span>open(gzip_obj<span style=color:#2c5dcd>.</span>get()[<span style=color:#0c6>&#34;Body&#34;</span>], mode<span style=color:#2c5dcd>=</span><span style=color:#0c6>&#39;rt&#39;</span>)
</span></span><span style=display:flex><span>        reader <span style=color:#2c5dcd>=</span> csv<span style=color:#2c5dcd>.</span>reader(buffer)
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>for</span> row <span style=color:#2c5dcd;font-weight:700>in</span> reader:
</span></span><span style=display:flex><span>            <span style=color:#2c5dcd;font-weight:700>yield</span> row
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>if</span> __name__ <span style=color:#2c5dcd>==</span> <span style=color:#0c6>&#39;__main__&#39;</span>:
</span></span><span style=display:flex><span>    bucket <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#39;s3-inventory-output-bucket&#39;</span>
</span></span><span style=display:flex><span>    manifest_key <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#39;path/to/my/inventory/2019-12-15T00-00Z/manifest.json&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>for</span> bucket, key, <span style=color:#2c5dcd>*</span>rest <span style=color:#2c5dcd;font-weight:700>in</span> list_keys(bucket, manifest_key):
</span></span><span style=display:flex><span>        <span style=color:#5918bb;font-weight:700>print</span>(bucket, key, <span style=color:#2c5dcd>*</span>rest)
</span></span></code></pre></td></tr></table></div></div></details><h2 id=querying-files-by-s3-properties>Querying files by S3 Properties<a hidden class=anchor aria-hidden=true href=#querying-files-by-s3-properties>#</a></h2><p>Sometimes you may need a subset of the files within S3, based some metadata property of the object (e.g. storage class, the key&rsquo;s extension). While you can use the S3 list-objects API to list files beginning with a particular prefix, you can not filter by suffix. To get around this limitation, we can utilize AWS Athena to query over an S3 Inventory report.</p><details><summary>1. Create a table</summary><p><em>This example assumes that you chose <code>CSV</code> as the S3 Inventory Output Format. For information on other formats, review <a href=https://docs.aws.amazon.com/athena/latest/ug/supported-format.html>the docs.</a></em></p><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>CREATE</span><span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>EXTERNAL</span><span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>TABLE</span><span style=color:#cbcbcb> </span>your_table_name(<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd>`</span>bucket<span style=color:#2c5dcd>`</span><span style=color:#cbcbcb> </span>string,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>key</span><span style=color:#cbcbcb> </span>string,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>version_id<span style=color:#cbcbcb> </span>string,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>is_latest<span style=color:#cbcbcb> </span><span style=color:#5918bb;font-weight:700>boolean</span>,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>is_delete_marker<span style=color:#cbcbcb> </span><span style=color:#5918bb;font-weight:700>boolean</span>,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>size</span><span style=color:#cbcbcb> </span><span style=color:#5918bb;font-weight:700>bigint</span>,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>last_modified_date<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>timestamp</span>,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>e_tag<span style=color:#cbcbcb> </span>string,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>storage_class<span style=color:#cbcbcb> </span>string,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>is_multipart_uploaded<span style=color:#cbcbcb> </span><span style=color:#5918bb;font-weight:700>boolean</span>,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>replication_status<span style=color:#cbcbcb> </span>string,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>encryption_status<span style=color:#cbcbcb> </span>string,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>object_lock_retain_until_date<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>timestamp</span>,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>object_lock_mode<span style=color:#cbcbcb> </span>string,<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>object_lock_legal_hold_status<span style=color:#cbcbcb> </span>string<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>)<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>PARTITIONED<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>BY</span><span style=color:#cbcbcb> </span>(dt<span style=color:#cbcbcb> </span>string)<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>ROW</span><span style=color:#cbcbcb> </span>FORMAT<span style=color:#cbcbcb> </span>DELIMITED<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span>FIELDS<span style=color:#cbcbcb> </span>TERMINATED<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>BY</span><span style=color:#cbcbcb> </span><span style=color:#0c6>&#39;,&#39;</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span>ESCAPED<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>BY</span><span style=color:#cbcbcb> </span><span style=color:#0c6>&#39;\\&#39;</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>    </span>LINES<span style=color:#cbcbcb> </span>TERMINATED<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>BY</span><span style=color:#cbcbcb> </span><span style=color:#0c6>&#39;\n&#39;</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>STORED<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>AS</span><span style=color:#cbcbcb> </span>INPUTFORMAT<span style=color:#cbcbcb> </span><span style=color:#0c6>&#39;org.apache.hadoop.hive.ql.io.SymlinkTextInputFormat&#39;</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span>OUTPUTFORMAT<span style=color:#cbcbcb>  </span><span style=color:#0c6>&#39;org.apache.hadoop.hive.ql.io.IgnoreKeyTextOutputFormat&#39;</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>LOCATION</span><span style=color:#cbcbcb> </span><span style=color:#0c6>&#39;s3://destination-prefix/source-bucket/YOUR_CONFIG_ID/hive/&#39;</span>;<span style=color:#cbcbcb>
</span></span></span></code></pre></td></tr></table></div></div></details><details><summary>2. Add inventory reports partitions</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span>MSCK<span style=color:#cbcbcb> </span>REPAIR<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>TABLE</span><span style=color:#cbcbcb> </span>your_table_name;<span style=color:#cbcbcb>
</span></span></span></code></pre></td></tr></table></div></div></details><details><summary>3. Query for S3 keys by their filename, size, storage class, etc</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>SELECT</span><span style=color:#cbcbcb> </span>storage_class,<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>count</span>(<span style=color:#2c5dcd>*</span>)<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>as</span><span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>count</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>FROM</span><span style=color:#cbcbcb> </span>your_table_name<span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>WHERE</span><span style=color:#cbcbcb> </span>dt<span style=color:#cbcbcb> </span><span style=color:#2c5dcd>=</span><span style=color:#cbcbcb> </span><span style=color:#0c6>&#39;2019-12-22-00-00&#39;</span><span style=color:#cbcbcb>
</span></span></span><span style=display:flex><span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>GROUP</span><span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>BY</span><span style=color:#cbcbcb> </span>storage_class<span style=color:#cbcbcb>
</span></span></span></code></pre></td></tr></table></div></div></details><p>More information about querying Storage Inventory files with Athena can be <a href=https://docs.aws.amazon.com/AmazonS3/latest/dev/storage-inventory.html#storage-inventory-athena-query>found here</a>.</p><h2 id=processing-files>Processing Files<a hidden class=anchor aria-hidden=true href=#processing-files>#</a></h2><p>Situations may arise where you need to run all (or a large number) of the files within an S3 bucket through some operation. <a href=https://docs.aws.amazon.com/AmazonS3/latest/user-guide/batch-ops.html>S3 Batch Operations</a> (not to be confused with <a href=https://aws.amazon.com/batch/>AWS Batch</a>) is built to do the following:</p><blockquote><p>copy objects, set object tags or access control lists (ACLs), initiate object restores from Amazon S3 Glacier, or invoke an AWS Lambda function to perform custom actions using your objects.</p></blockquote><p>With that last feature, invoking an AWS Lambda function, we can utilize Batch Operations to process a massive number of files without dealing without any of the complexity associated with data-processing infrastructure. Instead, we provide the Batch Operations with a CSV or S3 Inventory Manifest file and a Lambda function to run over each file.</p><p>To work with S3 Batch Operations, the lambda function must return a particular response object to describe if the process succeeded, failed, or failed but should be retried.</p><details><summary>S3 Batch Operation Boilerplate Python script</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> urllib
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> boto3
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>from</span> botocore.exceptions <span style=color:#2c5dcd;font-weight:700>import</span> ClientError
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>s3 <span style=color:#2c5dcd>=</span> boto3<span style=color:#2c5dcd>.</span>resource(<span style=color:#0c6>&#34;s3&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>TMP_FAILURE <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#34;TemporaryFailure&#34;</span>
</span></span><span style=display:flex><span>FAILURE <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#34;PermanentFailure&#34;</span>
</span></span><span style=display:flex><span>SUCCESS <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#34;Succeeded&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>process_object</span>(src_object):
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>return</span> <span style=color:#0c6>&#34;TODO: Populate with processing task...&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>get_task_id</span>(event):
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>return</span> event[<span style=color:#0c6>&#34;tasks&#34;</span>][<span style=color:#5918bb;font-weight:700>0</span>][<span style=color:#0c6>&#34;taskId&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>parse_job_parameters</span>(event):
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># Parse job parameters from Amazon S3 batch operations</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># jobId = event[&#34;job&#34;][&#34;id&#34;]</span>
</span></span><span style=display:flex><span>    invocationId <span style=color:#2c5dcd>=</span> event[<span style=color:#0c6>&#34;invocationId&#34;</span>]
</span></span><span style=display:flex><span>    invocationSchemaVersion <span style=color:#2c5dcd>=</span> event[<span style=color:#0c6>&#34;invocationSchemaVersion&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>return</span> <span style=color:#5918bb;font-weight:700>dict</span>(
</span></span><span style=display:flex><span>        invocationId<span style=color:#2c5dcd>=</span>invocationId, invocationSchemaVersion<span style=color:#2c5dcd>=</span>invocationSchemaVersion
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>get_s3_object</span>(event):
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># Parse Amazon S3 Key, Key Version, and Bucket ARN</span>
</span></span><span style=display:flex><span>    s3Key <span style=color:#2c5dcd>=</span> urllib<span style=color:#2c5dcd>.</span>parse<span style=color:#2c5dcd>.</span>unquote(event[<span style=color:#0c6>&#34;tasks&#34;</span>][<span style=color:#5918bb;font-weight:700>0</span>][<span style=color:#0c6>&#34;s3Key&#34;</span>])
</span></span><span style=display:flex><span>    s3VersionId <span style=color:#2c5dcd>=</span> event[<span style=color:#0c6>&#34;tasks&#34;</span>][<span style=color:#5918bb;font-weight:700>0</span>][<span style=color:#0c6>&#34;s3VersionId&#34;</span>]  <span style=color:#0080ff;font-style:italic># Unused</span>
</span></span><span style=display:flex><span>    s3BucketArn <span style=color:#2c5dcd>=</span> event[<span style=color:#0c6>&#34;tasks&#34;</span>][<span style=color:#5918bb;font-weight:700>0</span>][<span style=color:#0c6>&#34;s3BucketArn&#34;</span>]
</span></span><span style=display:flex><span>    s3Bucket <span style=color:#2c5dcd>=</span> s3BucketArn<span style=color:#2c5dcd>.</span>split(<span style=color:#0c6>&#34;:::&#34;</span>)[<span style=color:#2c5dcd>-</span><span style=color:#5918bb;font-weight:700>1</span>]
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>return</span> s3<span style=color:#2c5dcd>.</span>Object(s3Bucket, s3Key)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>build_result</span>(status: <span style=color:#5918bb;font-weight:700>str</span>, msg: <span style=color:#5918bb;font-weight:700>str</span>):
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>return</span> <span style=color:#5918bb;font-weight:700>dict</span>(resultCode<span style=color:#2c5dcd>=</span>status, resultString<span style=color:#2c5dcd>=</span>msg)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>handler</span>(event, context):
</span></span><span style=display:flex><span>    task_id <span style=color:#2c5dcd>=</span> get_task_id(event)
</span></span><span style=display:flex><span>    job_params <span style=color:#2c5dcd>=</span> parse_job_parameters(event)
</span></span><span style=display:flex><span>    s3_object <span style=color:#2c5dcd>=</span> get_s3_object(event)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>try</span>:
</span></span><span style=display:flex><span>        output <span style=color:#2c5dcd>=</span> process_object(s3_object)
</span></span><span style=display:flex><span>        <span style=color:#0080ff;font-style:italic># Mark as succeeded</span>
</span></span><span style=display:flex><span>        result <span style=color:#2c5dcd>=</span> build_result(SUCCESS, output)
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>except</span> ClientError <span style=color:#2c5dcd;font-weight:700>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#0080ff;font-style:italic># If request timed out, mark as a temp failure</span>
</span></span><span style=display:flex><span>        <span style=color:#0080ff;font-style:italic># and Amazon S3 batch operations will make the task for retry. If</span>
</span></span><span style=display:flex><span>        <span style=color:#0080ff;font-style:italic># any other exceptions are received, mark as permanent failure.</span>
</span></span><span style=display:flex><span>        errorCode <span style=color:#2c5dcd>=</span> e<span style=color:#2c5dcd>.</span>response[<span style=color:#0c6>&#34;Error&#34;</span>][<span style=color:#0c6>&#34;Code&#34;</span>]
</span></span><span style=display:flex><span>        errorMessage <span style=color:#2c5dcd>=</span> e<span style=color:#2c5dcd>.</span>response[<span style=color:#0c6>&#34;Error&#34;</span>][<span style=color:#0c6>&#34;Message&#34;</span>]
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>if</span> errorCode <span style=color:#2c5dcd>==</span> <span style=color:#0c6>&#34;RequestTimeout&#34;</span>:
</span></span><span style=display:flex><span>            result <span style=color:#2c5dcd>=</span> build_result(
</span></span><span style=display:flex><span>                TMP_FAILURE, <span style=color:#0c6>&#34;Retry request to Amazon S3 due to timeout.&#34;</span>
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>else</span>:
</span></span><span style=display:flex><span>            result <span style=color:#2c5dcd>=</span> build_result(FAILURE, <span style=color:#0c6>f</span><span style=color:#0c6>&#34;</span><span style=color:#0c6>{</span>errorCode<span style=color:#0c6>}</span><span style=color:#0c6>: </span><span style=color:#0c6>{</span>errorMessage<span style=color:#0c6>}</span><span style=color:#0c6>&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>except</span> <span style=color:#5918bb;font-weight:700>Exception</span> <span style=color:#2c5dcd;font-weight:700>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#0080ff;font-style:italic># Catch all exceptions to permanently fail the task</span>
</span></span><span style=display:flex><span>        result <span style=color:#2c5dcd>=</span> build_result(FAILURE, <span style=color:#0c6>f</span><span style=color:#0c6>&#34;Exception: </span><span style=color:#0c6>{</span>e<span style=color:#0c6>}</span><span style=color:#0c6>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>return</span> {
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd>**</span>job_params,
</span></span><span style=display:flex><span>        <span style=color:#0c6>&#34;treatMissingKeysAs&#34;</span>: <span style=color:#0c6>&#34;PermanentFailure&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#0c6>&#34;results&#34;</span>: [{<span style=color:#2c5dcd>**</span>result, <span style=color:#0c6>&#34;taskId&#34;</span>: task_id}],
</span></span><span style=display:flex><span>    }
</span></span></code></pre></td></tr></table></div></div></details><p>S3 Batch Operations will then run every key through this Lambda handler, retry temporary failures, and log its results in result files. The result files are conveniently grouped by success/failure status and linked to from a Manifest Result File.</p><details><summary>Example Manifest Result File</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#2c5dcd;font-weight:700>&#34;Format&#34;</span>: <span style=color:#0c6>&#34;Report_CSV_20180820&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#2c5dcd;font-weight:700>&#34;ReportCreationDate&#34;</span>: <span style=color:#0c6>&#34;2019-04-05T17:48:39.725Z&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#2c5dcd;font-weight:700>&#34;Results&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;TaskExecutionStatus&#34;</span>: <span style=color:#0c6>&#34;succeeded&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Bucket&#34;</span>: <span style=color:#0c6>&#34;my-job-reports&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;MD5Checksum&#34;</span>: <span style=color:#0c6>&#34;83b1c4cbe93fc893f54053697e10fd6e&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Key&#34;</span>: <span style=color:#0c6>&#34;job-f8fb9d89-a3aa-461d-bddc-ea6a1b131955/results/6217b0fab0de85c408b4be96aeaca9b195a7daa5.csv&#34;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;TaskExecutionStatus&#34;</span>: <span style=color:#0c6>&#34;failed&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Bucket&#34;</span>: <span style=color:#0c6>&#34;my-job-reports&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;MD5Checksum&#34;</span>: <span style=color:#0c6>&#34;22ee037f3515975f7719699e5c416eaa&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#2c5dcd;font-weight:700>&#34;Key&#34;</span>: <span style=color:#0c6>&#34;job-f8fb9d89-a3aa-461d-bddc-ea6a1b131955/results/b2ddad417e94331e9f37b44f1faf8c7ed5873f2e.csv&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#2c5dcd;font-weight:700>&#34;ReportSchema&#34;</span>: <span style=color:#0c6>&#34;Bucket, Key, VersionId, TaskStatus, ErrorCode, HTTPStatusCode, ResultMessage&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></details><p>More information about the Complete Report format can be <a href=https://docs.aws.amazon.com/AmazonS3/latest/dev/batch-ops-examples-reports.html>found here</a>.</p><hr><p>At time of writing, S3 Batch Operations cost $0.25 / job + $1 / million S3 objects processed.</p><p>Price to process 5 million thumbnails in 2hrs:</p><ul><li>S3 Batch Operations: <code>$0.25 + (5 \* $1)</code> = $5.25</li><li>Lambda: <code>128MB * 2000 ms * 5,000,000</code> = $21.83</li><li>S3 Get Requests: <code>5,000,000 / 1000 \* $0.0004</code> = $2</li><li>S3 Put Requests: <code>5,000,000 / 1000 \* $0.005</code> = $25</li><li>TOTAL: <strong>$54.08</strong></li></ul><h2 id=things-not-discussed-in-this-post>Things not discussed in this post<a hidden class=anchor aria-hidden=true href=#things-not-discussed-in-this-post>#</a></h2><p>If you are looking for more techniques on querying data stored in S3, consider the following:</p><ul><li><a href=https://aws.amazon.com/blogs/big-data/analyzing-data-in-s3-using-amazon-athena/>Using Athena to query the contents of your files stored in S3</a></li><li><a href=https://aws.amazon.com/blogs/aws/s3-glacier-select/>Using S3 Select to select a subset of a single (very large) file stored in S3</a></li></ul></div><footer class=post-footer><ul class=post-tags><li><a href=https://alukach.com/tags/python/>python</a></li><li><a href=https://alukach.com/tags/aws/>aws</a></li><li><a href=https://alukach.com/tags/s3/>s3</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2022 <a href=https://alukach.com/>anthony lukach</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();var e=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(e)}']`).scrollIntoView({behavior:"smooth"}),e==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${e}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(t=>{const n=t.parentNode.parentNode,e=document.createElement("button");e.classList.add("copy-code"),e.innerText="copy";function s(){e.innerText="copied!",setTimeout(()=>{e.innerText="copy"},2e3)}e.addEventListener("click",o=>{if("clipboard"in navigator){navigator.clipboard.writeText(t.textContent),s();return}const e=document.createRange();e.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(e);try{document.execCommand("copy"),s()}catch(e){}n.removeRange(e)}),n.classList.contains("highlight")?n.appendChild(e):n.parentNode.firstChild==n||(t.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?t.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(e):t.parentNode.appendChild(e))})</script></body></html>