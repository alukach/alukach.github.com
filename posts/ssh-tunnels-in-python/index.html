<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>SSH tunnels in Python | anthony lukach</title>
<meta name=keywords content="python,ssh,tunnel"><meta name=description content="At times, a developer may need to access infrastructure not available on the public internet. A common example of this is accessing a database located in a private subnet, as described in the VPC Scenario docs:
Instances in the private subnet are back-end servers that don&rsquo;t need to accept incoming traffic from the internet and therefore do not have public IP addresses; however, they can send requests to the internet using the NAT gateway."><meta name=author content><link rel=canonical href=https://alukach.com/posts/ssh-tunnels-in-python/><link crossorigin=anonymous href=/assets/css/stylesheet.min.4ba82eb0954ce20ea51d7ca6c3b71ea48dd719c880f27386be309802fedc6b21.css integrity="sha256-S6gusJVM4g6lHXymw7cepI3XGciA8nOGvjCYAv7cayE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.5b9ae0304f93db6cc493f51846f012428af399c614b4f2fbdb7fa59dd4d5ef5b.js integrity="sha256-W5rgME+T22zEk/UYRvASQorzmcYUtPL723+lndTV71s=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://alukach.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://alukach.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://alukach.com/favicon-32x32.png><link rel=apple-touch-icon href=https://alukach.com/apple-touch-icon.png><link rel=mask-icon href=https://alukach.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-16401510-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="SSH tunnels in Python"><meta property="og:description" content="At times, a developer may need to access infrastructure not available on the public internet. A common example of this is accessing a database located in a private subnet, as described in the VPC Scenario docs:
Instances in the private subnet are back-end servers that don&rsquo;t need to accept incoming traffic from the internet and therefore do not have public IP addresses; however, they can send requests to the internet using the NAT gateway."><meta property="og:type" content="article"><meta property="og:url" content="https://alukach.com/posts/ssh-tunnels-in-python/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-17T00:00:00+00:00"><meta property="article:modified_time" content="2021-09-17T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="SSH tunnels in Python"><meta name=twitter:description content="At times, a developer may need to access infrastructure not available on the public internet. A common example of this is accessing a database located in a private subnet, as described in the VPC Scenario docs:
Instances in the private subnet are back-end servers that don&rsquo;t need to accept incoming traffic from the internet and therefore do not have public IP addresses; however, they can send requests to the internet using the NAT gateway."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alukach.com/posts/"},{"@type":"ListItem","position":2,"name":"SSH tunnels in Python","item":"https://alukach.com/posts/ssh-tunnels-in-python/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"SSH tunnels in Python","name":"SSH tunnels in Python","description":"At times, a developer may need to access infrastructure not available on the public internet. A common example of this is accessing a database located in a private subnet, as described in the VPC Scenario docs:\nInstances in the private subnet are back-end servers that don\u0026rsquo;t need to accept incoming traffic from the internet and therefore do not have public IP addresses; however, they can send requests to the internet using the NAT gateway.","keywords":["python","ssh","tunnel"],"articleBody":"At times, a developer may need to access infrastructure not available on the public internet. A common example of this is accessing a database located in a private subnet, as described in the VPC Scenario docs:\nInstances in the private subnet are back-end servers that donâ€™t need to accept incoming traffic from the internet and therefore do not have public IP addresses; however, they can send requests to the internet using the NAT gateway.\nThe common strategy for connecting to one of these devices is to tunnel your traffic through a jump box AKA jump server AKA jump host. This can be achieved by SSH Port Forwarding AKA SSH Tunneling.\nFor a recent project, I needed a convenient way to query private databases in Python to do some repeatable data management operations. Tools like DBeaver have built-in support for connecting to databases over SSH tunnels, however I needed something more scriptable. Standing up a service in AWS would have worked however seemed to be overkill for my simple scripting needs. My goals were to 1) get auth credentials from AWS Secrets Manager (RDS places credentials in Secrets Manager by default, or at least when creating RDS instances via CDK); 2) setup a tunnel through a jumpbox to allow access to the RDS Instance; 3) run SQL queries against the DB. Automating this process in Python was not immediately clear until found the sshtunnel module. After playing around with the code for a bit, I was able to put together a utility class with Pydantic and Psycopg2 to conveniently connect to a private RDS instance via SSH tunneling. I figured I would share in the event that someone ever needs such a tool in the future.\nCode Sample 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 import socket import contextlib import logging from typing import Any, Generator, Tuple, Optional import psycopg2 import psycopg2.extras from pydantic.main import BaseModel from sshtunnel import open_tunnel logger = logging.getLogger(__name__) class Db(BaseModel): dbname: str user: str password: str host: str port: int = 5432 @contextlib.contextmanager def cursor( self, name=None ) -\u003e Generator[Tuple[Any, psycopg2.extras.DictCursor], None, None]: logger.debug(\"Connecting to %s\", self.dbname) with psycopg2.connect(**self.dict()) as conn: cursor = conn.cursor(name, cursor_factory=psycopg2.extras.DictCursor) with cursor as curs: logger.debug(\"Yielding cursor\") yield conn, curs logger.debug(\"Disconnecting from %s\", self.dbname) @contextlib.contextmanager def create_tunnel( self, jumpbox_host: str, local_port: Optional[int] = None, jumpbox_port: int = 22, local_host: str = \"127.0.0.1\", jumpbox_username: str = None, ssh_key_password: str = None, ) -\u003e Generator[\"Db\", None, None]: \"\"\" Generates an SSH tunnel to DB via jumpbox. \"\"\" if local_port is None: local_port = self._find_free_port() with open_tunnel( (jumpbox_host, jumpbox_port), ssh_username=jumpbox_username, remote_bind_address=(self.host, self.port), local_bind_address=(local_host, local_port), ssh_private_key_password=ssh_key_password, ) as tunnel: logger.debug( \"Tunnel to %s through %s established on port %s\", self.host, jumpbox_host, local_port, ) yield self.copy( update={ \"host\": tunnel.local_bind_host, \"port\": tunnel.local_bind_port, } ) @classmethod def from_rds_credentials(cls, secret): return cls.parse_obj({\"user\": secret.pop(\"username\"), **secret}) @staticmethod def _find_free_port() -\u003e int: # https://stackoverflow.com/a/45690594/728583 with contextlib.closing(socket.socket(socket.AF_INET, socket.SOCK_STREAM)) as s: s.bind((\"\", 0)) s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1) return s.getsockname()[1] if __name__ == \"__main__\": import json import boto3 rds_secret = \"myRdsDbSecret\" # ARN or Secret ID jumpbox_host = \"my-jumpbox-hostname\" # hostname/ip address of jumpbox credentials = json.load( boto3.client(\"secretsmanager\").get_secret_value(SecretId=rds_secret)[ \"SecretString\" ] ) private_db = Db.from_rds_credentials(credentials) with private_db.create_tunnel(jumpbox_host) as db: with db.cursor() as (conn, cur): cur.execute(\"SELECT COUNT(*) FROM my_table;\") print(cur.fetchone()) ","wordCount":"621","inLanguage":"en","datePublished":"2021-09-17T00:00:00Z","dateModified":"2021-09-17T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://alukach.com/posts/ssh-tunnels-in-python/"},"publisher":{"@type":"Organization","name":"anthony lukach","logo":{"@type":"ImageObject","url":"https://alukach.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://alukach.com/ accesskey=h title="anthony lukach (Alt + H)">anthony lukach</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://alukach.com/categories/posts title=Posts><span>Posts</span></a></li><li><a href=https://alukach.com/categories/snippets title=Snippets><span>Snippets</span></a></li><li><a href=https://alukach.com/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://alukach.com/resume title=RÃ©sumÃ©><span>RÃ©sumÃ©</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>SSH tunnels in Python</h1><div class=post-meta>&lt;span title='2021-09-17 00:00:00 +0000 UTC'>September 17, 2021&lt;/span>&amp;nbsp;Â·&amp;nbsp;3 min&nbsp;|&nbsp;<a href=https://github.com/alukach/alukach.github.io/edit/main/content/posts/ssh-tunnels-in-python.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#code-sample aria-label="Code Sample">Code Sample</a></li></ul></div></details></div><div class=post-content><p>At times, a developer may need to access infrastructure not available on the public internet. A common example of this is accessing a database located in a private subnet, as described in the <a href=https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Scenario2.html>VPC Scenario docs</a>:</p><blockquote><p>Instances in the private subnet are back-end servers that don&rsquo;t need to accept incoming traffic from the internet and therefore do not have public IP addresses; however, they can send requests to the internet using the NAT gateway.</p></blockquote><p>The common strategy for connecting to one of these devices is to tunnel your traffic through a <a href=https://en.wikipedia.org/wiki/Jump_server>jump box AKA jump server AKA jump host</a>. This can be achieved by <a href=https://www.ssh.com/academy/ssh/tunneling/example>SSH Port Forwarding AKA SSH Tunneling</a>.</p><p>For a recent project, I needed a convenient way to query private databases in Python to do some repeatable data management operations. Tools like <a href=https://dbeaver.io/>DBeaver</a> have built-in support for connecting to databases over SSH tunnels, however I needed something more scriptable. Standing up a service in AWS would have worked however seemed to be overkill for my simple scripting needs. My goals were to 1) get auth credentials from AWS Secrets Manager (RDS places credentials in Secrets Manager by default, or at least when creating RDS instances via CDK); 2) setup a tunnel through a jumpbox to allow access to the RDS Instance; 3) run SQL queries against the DB. Automating this process in Python was not immediately clear until found the <a href=https://sshtunnel.readthedocs.io/en/latest/><code>sshtunnel</code> module</a>. After playing around with the code for a bit, I was able to put together a utility class with <a href=http://pydantic-docs.helpmanual.io/>Pydantic</a> and <a href=https://www.psycopg.org/docs/>Psycopg2</a> to conveniently connect to a private RDS instance via SSH tunneling. I figured I would share in the event that someone ever needs such a tool in the future.</p><h3 id=code-sample>Code Sample<a hidden class=anchor aria-hidden=true href=#code-sample>#</a></h3><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">97
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> socket
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> contextlib
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> logging
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>from</span> typing <span style=color:#2c5dcd;font-weight:700>import</span> Any, Generator, Tuple, Optional
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> psycopg2
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> psycopg2.extras
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>from</span> pydantic.main <span style=color:#2c5dcd;font-weight:700>import</span> BaseModel
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>from</span> sshtunnel <span style=color:#2c5dcd;font-weight:700>import</span> open_tunnel
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>logger <span style=color:#2c5dcd>=</span> logging<span style=color:#2c5dcd>.</span>getLogger(__name__)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Db</span>(BaseModel):
</span></span><span style=display:flex><span>    dbname: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    user: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    password: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    host: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    port: <span style=color:#5918bb;font-weight:700>int</span> <span style=color:#2c5dcd>=</span> <span style=color:#5918bb;font-weight:700>5432</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff8000;font-weight:700>@contextlib.contextmanager</span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>cursor</span>(
</span></span><span style=display:flex><span>        self, name<span style=color:#2c5dcd>=</span><span style=color:#2c5dcd;font-weight:700>None</span>
</span></span><span style=display:flex><span>    ) <span style=color:#2c5dcd>-&gt;</span> Generator[Tuple[Any, psycopg2<span style=color:#2c5dcd>.</span>extras<span style=color:#2c5dcd>.</span>DictCursor], <span style=color:#2c5dcd;font-weight:700>None</span>, <span style=color:#2c5dcd;font-weight:700>None</span>]:
</span></span><span style=display:flex><span>        logger<span style=color:#2c5dcd>.</span>debug(<span style=color:#0c6>&#34;Connecting to </span><span style=color:#0c6>%s</span><span style=color:#0c6>&#34;</span>, self<span style=color:#2c5dcd>.</span>dbname)
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>with</span> psycopg2<span style=color:#2c5dcd>.</span>connect(<span style=color:#2c5dcd>**</span>self<span style=color:#2c5dcd>.</span>dict()) <span style=color:#2c5dcd;font-weight:700>as</span> conn:
</span></span><span style=display:flex><span>            cursor <span style=color:#2c5dcd>=</span> conn<span style=color:#2c5dcd>.</span>cursor(name, cursor_factory<span style=color:#2c5dcd>=</span>psycopg2<span style=color:#2c5dcd>.</span>extras<span style=color:#2c5dcd>.</span>DictCursor)
</span></span><span style=display:flex><span>            <span style=color:#2c5dcd;font-weight:700>with</span> cursor <span style=color:#2c5dcd;font-weight:700>as</span> curs:
</span></span><span style=display:flex><span>                logger<span style=color:#2c5dcd>.</span>debug(<span style=color:#0c6>&#34;Yielding cursor&#34;</span>)
</span></span><span style=display:flex><span>                <span style=color:#2c5dcd;font-weight:700>yield</span> conn, curs
</span></span><span style=display:flex><span>                logger<span style=color:#2c5dcd>.</span>debug(<span style=color:#0c6>&#34;Disconnecting from </span><span style=color:#0c6>%s</span><span style=color:#0c6>&#34;</span>, self<span style=color:#2c5dcd>.</span>dbname)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff8000;font-weight:700>@contextlib.contextmanager</span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>create_tunnel</span>(
</span></span><span style=display:flex><span>        self,
</span></span><span style=display:flex><span>        jumpbox_host: <span style=color:#5918bb;font-weight:700>str</span>,
</span></span><span style=display:flex><span>        local_port: Optional[<span style=color:#5918bb;font-weight:700>int</span>] <span style=color:#2c5dcd>=</span> <span style=color:#2c5dcd;font-weight:700>None</span>,
</span></span><span style=display:flex><span>        jumpbox_port: <span style=color:#5918bb;font-weight:700>int</span> <span style=color:#2c5dcd>=</span> <span style=color:#5918bb;font-weight:700>22</span>,
</span></span><span style=display:flex><span>        local_host: <span style=color:#5918bb;font-weight:700>str</span> <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#34;127.0.0.1&#34;</span>,
</span></span><span style=display:flex><span>        jumpbox_username: <span style=color:#5918bb;font-weight:700>str</span> <span style=color:#2c5dcd>=</span> <span style=color:#2c5dcd;font-weight:700>None</span>,
</span></span><span style=display:flex><span>        ssh_key_password: <span style=color:#5918bb;font-weight:700>str</span> <span style=color:#2c5dcd>=</span> <span style=color:#2c5dcd;font-weight:700>None</span>,
</span></span><span style=display:flex><span>    ) <span style=color:#2c5dcd>-&gt;</span> Generator[<span style=color:#0c6>&#34;Db&#34;</span>, <span style=color:#2c5dcd;font-weight:700>None</span>, <span style=color:#2c5dcd;font-weight:700>None</span>]:
</span></span><span style=display:flex><span>        <span style=color:#0c6>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#0c6>        Generates an SSH tunnel to DB via jumpbox.
</span></span></span><span style=display:flex><span><span style=color:#0c6>        &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>if</span> local_port <span style=color:#2c5dcd;font-weight:700>is</span> <span style=color:#2c5dcd;font-weight:700>None</span>:
</span></span><span style=display:flex><span>            local_port <span style=color:#2c5dcd>=</span> self<span style=color:#2c5dcd>.</span>_find_free_port()
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>with</span> open_tunnel(
</span></span><span style=display:flex><span>            (jumpbox_host, jumpbox_port),
</span></span><span style=display:flex><span>            ssh_username<span style=color:#2c5dcd>=</span>jumpbox_username,
</span></span><span style=display:flex><span>            remote_bind_address<span style=color:#2c5dcd>=</span>(self<span style=color:#2c5dcd>.</span>host, self<span style=color:#2c5dcd>.</span>port),
</span></span><span style=display:flex><span>            local_bind_address<span style=color:#2c5dcd>=</span>(local_host, local_port),
</span></span><span style=display:flex><span>            ssh_private_key_password<span style=color:#2c5dcd>=</span>ssh_key_password,
</span></span><span style=display:flex><span>        ) <span style=color:#2c5dcd;font-weight:700>as</span> tunnel:
</span></span><span style=display:flex><span>            logger<span style=color:#2c5dcd>.</span>debug(
</span></span><span style=display:flex><span>                <span style=color:#0c6>&#34;Tunnel to </span><span style=color:#0c6>%s</span><span style=color:#0c6> through </span><span style=color:#0c6>%s</span><span style=color:#0c6> established on port </span><span style=color:#0c6>%s</span><span style=color:#0c6>&#34;</span>,
</span></span><span style=display:flex><span>                self<span style=color:#2c5dcd>.</span>host,
</span></span><span style=display:flex><span>                jumpbox_host,
</span></span><span style=display:flex><span>                local_port,
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>            <span style=color:#2c5dcd;font-weight:700>yield</span> self<span style=color:#2c5dcd>.</span>copy(
</span></span><span style=display:flex><span>                update<span style=color:#2c5dcd>=</span>{
</span></span><span style=display:flex><span>                    <span style=color:#0c6>&#34;host&#34;</span>: tunnel<span style=color:#2c5dcd>.</span>local_bind_host,
</span></span><span style=display:flex><span>                    <span style=color:#0c6>&#34;port&#34;</span>: tunnel<span style=color:#2c5dcd>.</span>local_bind_port,
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            )
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff8000;font-weight:700>@classmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>from_rds_credentials</span>(cls, secret):
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>return</span> cls<span style=color:#2c5dcd>.</span>parse_obj({<span style=color:#0c6>&#34;user&#34;</span>: secret<span style=color:#2c5dcd>.</span>pop(<span style=color:#0c6>&#34;username&#34;</span>), <span style=color:#2c5dcd>**</span>secret})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#ff8000;font-weight:700>@staticmethod</span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>_find_free_port</span>() <span style=color:#2c5dcd>-&gt;</span> <span style=color:#5918bb;font-weight:700>int</span>:
</span></span><span style=display:flex><span>        <span style=color:#0080ff;font-style:italic># https://stackoverflow.com/a/45690594/728583</span>
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>with</span> contextlib<span style=color:#2c5dcd>.</span>closing(socket<span style=color:#2c5dcd>.</span>socket(socket<span style=color:#2c5dcd>.</span>AF_INET, socket<span style=color:#2c5dcd>.</span>SOCK_STREAM)) <span style=color:#2c5dcd;font-weight:700>as</span> s:
</span></span><span style=display:flex><span>            s<span style=color:#2c5dcd>.</span>bind((<span style=color:#0c6>&#34;&#34;</span>, <span style=color:#5918bb;font-weight:700>0</span>))
</span></span><span style=display:flex><span>            s<span style=color:#2c5dcd>.</span>setsockopt(socket<span style=color:#2c5dcd>.</span>SOL_SOCKET, socket<span style=color:#2c5dcd>.</span>SO_REUSEADDR, <span style=color:#5918bb;font-weight:700>1</span>)
</span></span><span style=display:flex><span>            <span style=color:#2c5dcd;font-weight:700>return</span> s<span style=color:#2c5dcd>.</span>getsockname()[<span style=color:#5918bb;font-weight:700>1</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>if</span> __name__ <span style=color:#2c5dcd>==</span> <span style=color:#0c6>&#34;__main__&#34;</span>:
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>import</span> json
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>import</span> boto3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    rds_secret <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#34;myRdsDbSecret&#34;</span>  <span style=color:#0080ff;font-style:italic># ARN or Secret ID</span>
</span></span><span style=display:flex><span>    jumpbox_host <span style=color:#2c5dcd>=</span> <span style=color:#0c6>&#34;my-jumpbox-hostname&#34;</span>  <span style=color:#0080ff;font-style:italic># hostname/ip address of jumpbox</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    credentials <span style=color:#2c5dcd>=</span> json<span style=color:#2c5dcd>.</span>load(
</span></span><span style=display:flex><span>        boto3<span style=color:#2c5dcd>.</span>client(<span style=color:#0c6>&#34;secretsmanager&#34;</span>)<span style=color:#2c5dcd>.</span>get_secret_value(SecretId<span style=color:#2c5dcd>=</span>rds_secret)[
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;SecretString&#34;</span>
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    private_db <span style=color:#2c5dcd>=</span> Db<span style=color:#2c5dcd>.</span>from_rds_credentials(credentials)
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>with</span> private_db<span style=color:#2c5dcd>.</span>create_tunnel(jumpbox_host) <span style=color:#2c5dcd;font-weight:700>as</span> db:
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>with</span> db<span style=color:#2c5dcd>.</span>cursor() <span style=color:#2c5dcd;font-weight:700>as</span> (conn, cur):
</span></span><span style=display:flex><span>            cur<span style=color:#2c5dcd>.</span>execute(<span style=color:#0c6>&#34;SELECT COUNT(*) FROM my_table;&#34;</span>)
</span></span><span style=display:flex><span>            <span style=color:#5918bb;font-weight:700>print</span>(cur<span style=color:#2c5dcd>.</span>fetchone())
</span></span></code></pre></td></tr></table></div></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://alukach.com/tags/python/>python</a></li><li><a href=https://alukach.com/tags/ssh/>ssh</a></li><li><a href=https://alukach.com/tags/tunnel/>tunnel</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://alukach.com/>anthony lukach</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>