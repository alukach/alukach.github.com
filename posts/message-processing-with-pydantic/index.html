<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Type-based message processing with Pydantic | anthony lukach</title>
<meta name=keywords content="python,pydantic"><meta name=description content="When building systems to process messages, it&rsquo;s not unlikely to find yourself in a situation where you need to process a number of inputted heterogeneous messages (i.e. messages of varying shapes/types). For example, consider a situation where you are processing messages from an SQS queue via a Lambda function. This post attempts to highlight how this can be achieved in a clean and elegant manner by utilizing Pydantic, Python&rsquo;s typing system, and some helpers from the Python standard library."><meta name=author content><link rel=canonical href=https://alukach.com/posts/message-processing-with-pydantic/><link crossorigin=anonymous href=/assets/css/stylesheet.min.4ba82eb0954ce20ea51d7ca6c3b71ea48dd719c880f27386be309802fedc6b21.css integrity="sha256-S6gusJVM4g6lHXymw7cepI3XGciA8nOGvjCYAv7cayE=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.min.5b9ae0304f93db6cc493f51846f012428af399c614b4f2fbdb7fa59dd4d5ef5b.js integrity="sha256-W5rgME+T22zEk/UYRvASQorzmcYUtPL723+lndTV71s=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://alukach.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://alukach.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://alukach.com/favicon-32x32.png><link rel=apple-touch-icon href=https://alukach.com/apple-touch-icon.png><link rel=mask-icon href=https://alukach.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-16401510-1","auto"),ga("send","pageview"))</script><meta property="og:title" content="Type-based message processing with Pydantic"><meta property="og:description" content="When building systems to process messages, it&rsquo;s not unlikely to find yourself in a situation where you need to process a number of inputted heterogeneous messages (i.e. messages of varying shapes/types). For example, consider a situation where you are processing messages from an SQS queue via a Lambda function. This post attempts to highlight how this can be achieved in a clean and elegant manner by utilizing Pydantic, Python&rsquo;s typing system, and some helpers from the Python standard library."><meta property="og:type" content="article"><meta property="og:url" content="https://alukach.com/posts/message-processing-with-pydantic/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-08-05T00:00:00+00:00"><meta property="article:modified_time" content="2022-08-05T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Type-based message processing with Pydantic"><meta name=twitter:description content="When building systems to process messages, it&rsquo;s not unlikely to find yourself in a situation where you need to process a number of inputted heterogeneous messages (i.e. messages of varying shapes/types). For example, consider a situation where you are processing messages from an SQS queue via a Lambda function. This post attempts to highlight how this can be achieved in a clean and elegant manner by utilizing Pydantic, Python&rsquo;s typing system, and some helpers from the Python standard library."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alukach.com/posts/"},{"@type":"ListItem","position":2,"name":"Type-based message processing with Pydantic","item":"https://alukach.com/posts/message-processing-with-pydantic/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Type-based message processing with Pydantic","name":"Type-based message processing with Pydantic","description":"When building systems to process messages, it\u0026rsquo;s not unlikely to find yourself in a situation where you need to process a number of inputted heterogeneous messages (i.e. messages of varying shapes/types). For example, consider a situation where you are processing messages from an SQS queue via a Lambda function. This post attempts to highlight how this can be achieved in a clean and elegant manner by utilizing Pydantic, Python\u0026rsquo;s typing system, and some helpers from the Python standard library.","keywords":["python","pydantic"],"articleBody":"When building systems to process messages, it’s not unlikely to find yourself in a situation where you need to process a number of inputted heterogeneous messages (i.e. messages of varying shapes/types). For example, consider a situation where you are processing messages from an SQS queue via a Lambda function. This post attempts to highlight how this can be achieved in a clean and elegant manner by utilizing Pydantic, Python’s typing system, and some helpers from the Python standard library.\nCategorizing messages of unknown type The first thing you likely need to do is identify the type of an inputted message by its properties. We can use Pydantic to model the types of messages we expect to have coming into our system. We can then utilize Pydantic’s parse_obj_as function to cast these messages to their respective Pydantic classes.\nIn the following example, we are able to distinguish between messages based on the attributes that they contain:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 import pydantic import typing class Email(pydantic.BaseModel): to: typing.List[str] subject: str message: str class Sms(pydantic.BaseModel): to: str message: str # Create a type demonstrating all of the expected messages SupportedMessages = typing.Union[Email, Sms] # Pass in our new type with a list of uncategorized messages messages = pydantic.parse_obj_as( typing.List[SupportedMessages], [ { \"to\": ['bill@gmail.com', 'alice@outlook.com'], \"subject\": \"BBQ Emergency\", \"message\": \"Need more ketchup!\" }, { \"to\": \"911\", \"message\": \"Burnt finger at BBQ :(\" } ] ) # They have now been cast to their appropriate types print(messages) #\u003e [Email(to=['bill@gmail.com', 'alice@outlook.com'], subject='BBQ Emergency', message='Need more ketchup!'), Sms(to='911', message='Burnt finger at BBQ :(')] Other times, messages are differentiated based on the value of a particular attribute. The same pattern applies:\nExample of value-based differentiation 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 import pydantic import typing class Email(pydantic.BaseModel): type: typing.Literal[\"email\"] to: str message: str class Sms(pydantic.BaseModel): type: typing.Literal[\"sms\"] to: str message: str # Create a type demonstrating all of the expected messages SupportedMessages = typing.Union[Email, Sms] # Pass in our new type with a list of uncategorized messages messages = pydantic.parse_obj_as( typing.List[SupportedMessages], [ { \"type\": \"email\", \"to\": \"paul@outlook.com\", \"message\": \"Head's up, Ringo has a new idea\" }, { \"type\": \"sms\", \"to\": \"867-5309\", \"message\": \"New phone, who dis?\" } ] ) # They have now been cast to their appropriate types print(messages) #\u003e [Email(type='email', to='paul@outlook.com', message=\"Head's up, Ringo has a new idea\"), Sms(type='sms', to='867-5309', message='New phone, who dis?')] Edge Cases Unknown types In the event that a message does not fit any model, a pydantic.ValidationError will be thrown:\nExample of an unexpected message 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 import pydantic import typing class Email(pydantic.BaseModel): to: typing.List[str] subject: str message: str pydantic.parse_obj_as(Email, {\"foo\": \"bar\"}) #\u003e Traceback (most recent call last): # File \"\", line 1, in # File \"pydantic/tools.py\", line 38, in pydantic.tools.parse_obj_as # File \"pydantic/main.py\", line 341, in pydantic.main.BaseModel.__init__ # pydantic.error_wrappers.ValidationError: 3 validation errors for ParsingModel[Email] # __root__ -\u003e to # field required (type=value_error.missing) # __root__ -\u003e subject # field required (type=value_error.missing) # __root__ -\u003e message # field required (type=value_error.missing) Similar types You can find yourself in challenging situations when one type is a subset of another:\nExample of a situation where you can differentiate between similar message types 1 2 3 4 5 6 7 8 9 10 11 12 13 14 import pydantic import typing class Person(pydantic.BaseModel): name: str class Pet(pydantic.BaseModel): name: str breed: str print(pydantic.parse_obj_as(typing.Union[Person, Pet], {\"name\": \"Bob\"})) #\u003e Person(name='Bob') pydantic.parse_obj_as(typing.Union[Person, Pet], {\"name\": \"Fido\", \"breed\": \"poodle\"}) #\u003e Person(name='Fido') By default, Pydantic permits extra attributes on models. By specifying that extra attributes are forbidden via the extra option, we can help Pydantic narrow in on the correct type.\nExample of using `extra` to help differentiate between similar message types 1 2 3 4 5 6 7 8 9 10 11 class Person(pydantic.BaseModel, extra=pydantic.Extra.forbid): name: str class Pet(pydantic.BaseModel, extra=pydantic.Extra.forbid): name: str breed: str pydantic.parse_obj_as(typing.Union[Person, Pet], {\"name\": \"Bob\"}) #\u003e Person(name='Bob') pydantic.parse_obj_as(typing.Union[Person, Pet], {\"name\": \"Fido\", \"breed\": \"poodle\"}) #\u003e Pet(name='Fido', breed='poodle') Processing Messages Now that we have our messages categorized, it’s likely that you’ll want to process each message according to its type. We could write a long if isinstance(msg, TypeA): ... elif isinstance(msg, TypeB): ..., but that’s no fun. Instead, we can reach for Python’s functools module, which has a convenient singledispatch decorator.\nFor those of us who aren’t function programming wizards (e.g. myself), here are some helpful definitions from Python’s glossary:\nsingle dispatch A form of generic function dispatch where the implementation is chosen based on the type of a single argument. generic function A function composed of multiple functions implementing the same operation for different types. Which implementation should be used during a call is determined by the dispatch algorithm. Let’s take a look at how that could work:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 import functools import pydantic import typing class Foo(pydantic.BaseModel): type: typing.Literal[\"foo\"] class Bar(pydantic.BaseModel): type: typing.Literal[\"foo\"] @functools.singledispatch def send(msg): # this is the default sender, which should only ever be called if a message # comes in with a type for which we haven't registered a handler. in this # situation, we may want to throw an error to signal that we don't know how # to handle this message; alternatively we may want to have a default handler # that applies to any types without explicitly registered handlers. ... @send.register def handle_foo(msg: Foo): ... @send.register def handle_bar(msg: Bar): ... Example of applying this pattern to our previous Email/SMS types 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 import functools import pydantic import typing class Email(pydantic.BaseModel): to: typing.List[str] subject: str message: str class Sms(pydantic.BaseModel): to: str message: str @functools.singledispatch def send(msg): # this is the default sender, which should only ever be called if a message # comes in with a type for which we haven't registered a handler. in this # situation, we may want to throw an error to signal that we don't know how # to handle this message; alternatively we may want to have a default handler # that applies to any types without explicitly registered handlers. raise Exception(f\"Unexpected message type ({type(msg)=}, {msg})\") @send.register def send_email(msg: Email): print(f\"Sending email to {' and '.join(msg.to)}\") @send.register def send_sms(msg: Sms): print(f\"Sending SMS to {msg.to}\") def handle_message(message: typing.Dict[str, typing.Any]): parsed_message = pydantic.parse_obj_as(typing.Union[Email, Sms], message) send(parsed_message) handle_message({ \"to\": ['bill@gmail.com', 'alice@outlook.com'], \"subject\": \"BBQ Emergency\", \"message\": \"Need more ketchup!\" }) #\u003e Sending email to bill@gmail.com and alice@outlook.com handle_message({ \"to\": \"911\", \"message\": \"Burnt finger at BBQ :(\" }) #\u003e Sending SMS to 911 Testing This type-based message handling is neat and all, but can we test this? I found it to be a bit challenging to integrate mocking with the @functools.singledispatch, but ended up using a simple context manager to conveniently swap out registered type handlers with mocks:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 import contextlib import typing import unittest.mock @contextlib.contextmanager def override_registry( dispatch_callable: \"_SingleDispatchCallable[Any]\", cls: typing.Type, mock: unittest.mock.Mock, ): \"\"\" Helper to override a singledispatch function with a mock for testing. \"\"\" original = dispatch_callable.registry[cls] dispatch_callable.register(cls, mock) try: yield mock finally: dispatch_callable.register(cls, original) Example of a full set of tests to validate that routing logic is appropriately configured 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 import functools import pydantic import typing import contextlib import unittest.mock class Email(pydantic.BaseModel): to: typing.List[str] subject: str message: str class Sms(pydantic.BaseModel): to: str message: str @functools.singledispatch def send(msg): # this is the default sender, which should only ever be called if a message # comes in with a type for which we haven't registered a handler. in this # situation, we may want to throw an error to signal that we don't know how # to handle this message; alternatively we may want to have a default handler # that applies to any types without explicitely registered handlers. raise Exception(f\"Unexpected message type ({type(msg)=}, {msg})\") @send.register def send_email(msg: Email): print(f\"Sending email to {' and '.join(msg.to)}\") @send.register def send_sms(msg: Sms): print(f\"Sending SMS to {msg.to}\") def handle_message(message: typing.Dict[str, typing.Any]): parsed_message = pydantic.parse_obj_as(typing.Union[Email, Sms], message) send(parsed_message) @contextlib.contextmanager def override_registry( dispatch_callable: \"_SingleDispatchCallable[Any]\", cls: typing.Type, mock: unittest.mock.Mock, ): \"\"\" Helper to override a singledispatch function with a mock for testing. \"\"\" original = dispatch_callable.registry[cls] dispatch_callable.register(cls, mock) try: yield mock finally: dispatch_callable.register(cls, original) def test_handling_email(): \"\"\" Ensure that the system properly handles Email messages. \"\"\" with override_registry( send, Email, unittest.mock.MagicMock() ) as called_mock, override_registry( send, Sms, unittest.mock.MagicMock() ) as not_called_mock: output = handle_message({ \"to\": ['bill@gmail.com', 'alice@outlook.com'], \"subject\": \"BBQ Emergency\", \"message\": \"Need more ketchup!\" }) assert called_mock.call_count == 1 assert not not_called_mock.call_count def test_handling_sms(): \"\"\" Ensure that the system properly handles SMS messages. \"\"\" with override_registry( send, Sms, unittest.mock.MagicMock() ) as called_mock, override_registry( send, Email, unittest.mock.MagicMock() ) as not_called_mock: output = handle_message({ \"to\": \"911\", \"message\": \"Burnt finger at BBQ :(\" }) assert called_mock.call_count == 1 assert not not_called_mock.call_count test_handling_email() test_handling_sms() This pattern is all a bit new to me and fresh in my mind. Hoping it can prove useful to others. I’m very open to hearing concerns or suggestions for improvement from others if anyone has them.\n","wordCount":"1700","inLanguage":"en","datePublished":"2022-08-05T00:00:00Z","dateModified":"2022-08-05T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://alukach.com/posts/message-processing-with-pydantic/"},"publisher":{"@type":"Organization","name":"anthony lukach","logo":{"@type":"ImageObject","url":"https://alukach.com/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://alukach.com/ accesskey=h title="anthony lukach (Alt + H)">anthony lukach</a>
<span class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></span></div><ul id=menu><li><a href=https://alukach.com/categories/posts title=Posts><span>Posts</span></a></li><li><a href=https://alukach.com/categories/snippets title=Snippets><span>Snippets</span></a></li><li><a href=https://alukach.com/search title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://alukach.com/resume title=Résumé><span>Résumé</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Type-based message processing with Pydantic</h1><div class=post-meta>&lt;span title='2022-08-05 00:00:00 +0000 UTC'>August 5, 2022&lt;/span>&amp;nbsp;·&amp;nbsp;8 min&nbsp;|&nbsp;<a href=https://github.com/alukach/alukach.github.io/edit/main/content/posts/message-processing-with-pydantic.md rel="noopener noreferrer" target=_blank>Edit</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><ul><li><a href=#categorizing-messages-of-unknown-type aria-label="Categorizing messages of unknown type">Categorizing messages of unknown type</a><ul><li><a href=#edge-cases aria-label="Edge Cases">Edge Cases</a><ul><li><a href=#unknown-types aria-label="Unknown types">Unknown types</a></li><li><a href=#similar-types aria-label="Similar types">Similar types</a></li></ul></li></ul></li><li><a href=#processing-messages aria-label="Processing Messages">Processing Messages</a></li><li><a href=#testing aria-label=Testing>Testing</a></li></ul></div></details></div><div class=post-content><p>When building systems to process messages, it&rsquo;s not unlikely to find yourself in a situation where you need to process a number of inputted heterogeneous messages (i.e. messages of varying shapes/types). For example, consider a situation where you are processing messages from an SQS queue via a Lambda function. This post attempts to highlight how this can be achieved in a clean and elegant manner by utilizing <a href=https://pydantic-docs.helpmanual.io/>Pydantic</a>, Python&rsquo;s <a href=https://docs.python.org/3/library/typing.html>typing</a> system, and some helpers from the Python standard library.</p><h2 id=categorizing-messages-of-unknown-type>Categorizing messages of unknown type<a hidden class=anchor aria-hidden=true href=#categorizing-messages-of-unknown-type>#</a></h2><p>The first thing you likely need to do is identify the type of an inputted message by its properties. We can use Pydantic to model the types of messages we expect to have coming into our system. We can then utilize <a href=https://pydantic-docs.helpmanual.io/usage/models/#parsing-data-into-a-specified-type>Pydantic&rsquo;s <code>parse_obj_as</code></a> function to cast these messages to their respective Pydantic classes.</p><p>In the following example, we are able to distinguish between messages based on the <em>attributes</em> that they contain:</p><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> pydantic
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> typing
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Email</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    to: typing<span style=color:#2c5dcd>.</span>List[<span style=color:#5918bb;font-weight:700>str</span>]
</span></span><span style=display:flex><span>    subject: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    message: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Sms</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    to: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    message: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic># Create a type demonstrating all of the expected messages</span>
</span></span><span style=display:flex><span>SupportedMessages <span style=color:#2c5dcd>=</span> typing<span style=color:#2c5dcd>.</span>Union[Email, Sms]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic># Pass in our new type with a list of uncategorized messages</span>
</span></span><span style=display:flex><span>messages <span style=color:#2c5dcd>=</span> pydantic<span style=color:#2c5dcd>.</span>parse_obj_as(
</span></span><span style=display:flex><span>    typing<span style=color:#2c5dcd>.</span>List[SupportedMessages],
</span></span><span style=display:flex><span>    [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;to&#34;</span>: [<span style=color:#0c6>&#39;bill@gmail.com&#39;</span>, <span style=color:#0c6>&#39;alice@outlook.com&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;subject&#34;</span>: <span style=color:#0c6>&#34;BBQ Emergency&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;message&#34;</span>: <span style=color:#0c6>&#34;Need more ketchup!&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;to&#34;</span>: <span style=color:#0c6>&#34;911&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;message&#34;</span>: <span style=color:#0c6>&#34;Burnt finger at BBQ :(&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic># They have now been cast to their appropriate types</span>
</span></span><span style=display:flex><span><span style=color:#5918bb;font-weight:700>print</span>(messages)
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#&gt; [Email(to=[&#39;bill@gmail.com&#39;, &#39;alice@outlook.com&#39;], subject=&#39;BBQ Emergency&#39;, message=&#39;Need more ketchup!&#39;), Sms(to=&#39;911&#39;, message=&#39;Burnt finger at BBQ :(&#39;)]</span>
</span></span></code></pre></td></tr></table></div></div><p>Other times, messages are differentiated based on the <em>value</em> of a particular attribute. The same pattern applies:</p><details><summary>Example of value-based differentiation</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> pydantic
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> typing
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Email</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#5918bb;font-weight:700>type</span>: typing<span style=color:#2c5dcd>.</span>Literal[<span style=color:#0c6>&#34;email&#34;</span>]
</span></span><span style=display:flex><span>    to: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    message: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Sms</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#5918bb;font-weight:700>type</span>: typing<span style=color:#2c5dcd>.</span>Literal[<span style=color:#0c6>&#34;sms&#34;</span>]
</span></span><span style=display:flex><span>    to: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    message: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic># Create a type demonstrating all of the expected messages</span>
</span></span><span style=display:flex><span>SupportedMessages <span style=color:#2c5dcd>=</span> typing<span style=color:#2c5dcd>.</span>Union[Email, Sms]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic># Pass in our new type with a list of uncategorized messages</span>
</span></span><span style=display:flex><span>messages <span style=color:#2c5dcd>=</span> pydantic<span style=color:#2c5dcd>.</span>parse_obj_as(
</span></span><span style=display:flex><span>    typing<span style=color:#2c5dcd>.</span>List[SupportedMessages],
</span></span><span style=display:flex><span>    [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;type&#34;</span>: <span style=color:#0c6>&#34;email&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;to&#34;</span>: <span style=color:#0c6>&#34;paul@outlook.com&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;message&#34;</span>: <span style=color:#0c6>&#34;Head&#39;s up, Ringo has a new idea&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;type&#34;</span>: <span style=color:#0c6>&#34;sms&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;to&#34;</span>: <span style=color:#0c6>&#34;867-5309&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;message&#34;</span>: <span style=color:#0c6>&#34;New phone, who dis?&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic># They have now been cast to their appropriate types</span>
</span></span><span style=display:flex><span><span style=color:#5918bb;font-weight:700>print</span>(messages)
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#&gt; [Email(type=&#39;email&#39;, to=&#39;paul@outlook.com&#39;, message=&#34;Head&#39;s up, Ringo has a new idea&#34;), Sms(type=&#39;sms&#39;, to=&#39;867-5309&#39;, message=&#39;New phone, who dis?&#39;)]</span>
</span></span></code></pre></td></tr></table></div></div></details><h3 id=edge-cases>Edge Cases<a hidden class=anchor aria-hidden=true href=#edge-cases>#</a></h3><h4 id=unknown-types>Unknown types<a hidden class=anchor aria-hidden=true href=#unknown-types>#</a></h4><p>In the event that a message does not fit any model, a <code>pydantic.ValidationError</code> will be thrown:</p><details><summary>Example of an unexpected message</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> pydantic
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> typing
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Email</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    to: typing<span style=color:#2c5dcd>.</span>List[<span style=color:#5918bb;font-weight:700>str</span>]
</span></span><span style=display:flex><span>    subject: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    message: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pydantic<span style=color:#2c5dcd>.</span>parse_obj_as(Email, {<span style=color:#0c6>&#34;foo&#34;</span>: <span style=color:#0c6>&#34;bar&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#&gt; Traceback (most recent call last):</span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#    File &#34;&lt;stdin&gt;&#34;, line 1, in &lt;module&gt;</span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#    File &#34;pydantic/tools.py&#34;, line 38, in pydantic.tools.parse_obj_as</span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#    File &#34;pydantic/main.py&#34;, line 341, in pydantic.main.BaseModel.__init__</span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#  pydantic.error_wrappers.ValidationError: 3 validation errors for ParsingModel[Email]</span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#  __root__ -&gt; to</span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#    field required (type=value_error.missing)</span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#  __root__ -&gt; subject</span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#    field required (type=value_error.missing)</span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#  __root__ -&gt; message</span>
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#    field required (type=value_error.missing)</span>
</span></span></code></pre></td></tr></table></div></div></details><h4 id=similar-types>Similar types<a hidden class=anchor aria-hidden=true href=#similar-types>#</a></h4><p>You can find yourself in challenging situations when one type is a subset of another:</p><details><summary>Example of a situation where you can differentiate between similar message types</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> pydantic
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> typing
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Person</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    name: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Pet</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    name: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    breed: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5918bb;font-weight:700>print</span>(pydantic<span style=color:#2c5dcd>.</span>parse_obj_as(typing<span style=color:#2c5dcd>.</span>Union[Person, Pet], {<span style=color:#0c6>&#34;name&#34;</span>: <span style=color:#0c6>&#34;Bob&#34;</span>}))
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#&gt; Person(name=&#39;Bob&#39;)</span>
</span></span><span style=display:flex><span>pydantic<span style=color:#2c5dcd>.</span>parse_obj_as(typing<span style=color:#2c5dcd>.</span>Union[Person, Pet], {<span style=color:#0c6>&#34;name&#34;</span>: <span style=color:#0c6>&#34;Fido&#34;</span>, <span style=color:#0c6>&#34;breed&#34;</span>: <span style=color:#0c6>&#34;poodle&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#&gt; Person(name=&#39;Fido&#39;)</span>
</span></span></code></pre></td></tr></table></div></div></details><p>By default, Pydantic permits extra attributes on models. By specifying that extra attributes are forbidden via the <a href=https://pydantic-docs.helpmanual.io/usage/model_config/#options><code>extra</code> option</a>, we can help Pydantic narrow in on the correct type.</p><details><summary>Example of using `extra` to help differentiate between similar message types</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Person</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel, extra<span style=color:#2c5dcd>=</span>pydantic<span style=color:#2c5dcd>.</span>Extra<span style=color:#2c5dcd>.</span>forbid):
</span></span><span style=display:flex><span>    name: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Pet</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel, extra<span style=color:#2c5dcd>=</span>pydantic<span style=color:#2c5dcd>.</span>Extra<span style=color:#2c5dcd>.</span>forbid):
</span></span><span style=display:flex><span>    name: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    breed: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>pydantic<span style=color:#2c5dcd>.</span>parse_obj_as(typing<span style=color:#2c5dcd>.</span>Union[Person, Pet], {<span style=color:#0c6>&#34;name&#34;</span>: <span style=color:#0c6>&#34;Bob&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#&gt; Person(name=&#39;Bob&#39;)</span>
</span></span><span style=display:flex><span>pydantic<span style=color:#2c5dcd>.</span>parse_obj_as(typing<span style=color:#2c5dcd>.</span>Union[Person, Pet], {<span style=color:#0c6>&#34;name&#34;</span>: <span style=color:#0c6>&#34;Fido&#34;</span>, <span style=color:#0c6>&#34;breed&#34;</span>: <span style=color:#0c6>&#34;poodle&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#&gt; Pet(name=&#39;Fido&#39;, breed=&#39;poodle&#39;)</span>
</span></span></code></pre></td></tr></table></div></div></details><h2 id=processing-messages>Processing Messages<a hidden class=anchor aria-hidden=true href=#processing-messages>#</a></h2><p>Now that we have our messages categorized, it&rsquo;s likely that you&rsquo;ll want to process each message according to its type. We could write a long <code>if isinstance(msg, TypeA): ... elif isinstance(msg, TypeB): ...</code>, but that&rsquo;s no fun. Instead, we can reach for Python&rsquo;s <code>functools</code> module, which has a convenient <a href=https://docs.python.org/3/library/functools.html#functools.singledispatch><code>singledispatch</code> decorator</a>.</p><p>For those of us who aren&rsquo;t function programming wizards (e.g. myself), here are some helpful definitions from <a href=https://docs.python.org/3/glossary.html>Python&rsquo;s glossary</a>:</p><blockquote><dl><dt><a href=https://docs.python.org/3/glossary.html#term-single-dispatch>single dispatch</a></dt><dd>A form of generic function dispatch where the implementation is chosen based on the type of a single argument.</dd><dt><a href=https://docs.python.org/3/glossary.html#term-generic-function>generic function</a></dt><dd>A function composed of multiple functions implementing the same operation for different types. Which implementation should be used during a call is determined by the dispatch algorithm.</dd></dl></blockquote><p>Let&rsquo;s take a look at how that could work:</p><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> functools
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> pydantic
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> typing
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Foo</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#5918bb;font-weight:700>type</span>: typing<span style=color:#2c5dcd>.</span>Literal[<span style=color:#0c6>&#34;foo&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Bar</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    <span style=color:#5918bb;font-weight:700>type</span>: typing<span style=color:#2c5dcd>.</span>Literal[<span style=color:#0c6>&#34;foo&#34;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@functools.singledispatch</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>send</span>(msg):
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># this is the default sender, which should only ever be called if a message</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># comes in with a type for which we haven&#39;t registered a handler. in this</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># situation, we may want to throw an error to signal that we don&#39;t know how</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># to handle this message; alternatively we may want to have a default handler</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># that applies to any types without explicitly registered handlers.</span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@send.register</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>handle_foo</span>(msg: Foo):
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@send.register</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>handle_bar</span>(msg: Bar):
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd>...</span>
</span></span></code></pre></td></tr></table></div></div><details><summary>Example of applying this pattern to our previous Email/SMS types</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> functools
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> pydantic
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> typing
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Email</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    to: typing<span style=color:#2c5dcd>.</span>List[<span style=color:#5918bb;font-weight:700>str</span>]
</span></span><span style=display:flex><span>    subject: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    message: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Sms</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    to: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    message: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@functools.singledispatch</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>send</span>(msg):
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># this is the default sender, which should only ever be called if a message</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># comes in with a type for which we haven&#39;t registered a handler. in this</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># situation, we may want to throw an error to signal that we don&#39;t know how</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># to handle this message; alternatively we may want to have a default handler</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># that applies to any types without explicitly registered handlers.</span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>raise</span> <span style=color:#5918bb;font-weight:700>Exception</span>(<span style=color:#0c6>f</span><span style=color:#0c6>&#34;Unexpected message type (</span><span style=color:#0c6>{</span><span style=color:#5918bb;font-weight:700>type</span>(msg)<span style=color:#0c6>=}</span><span style=color:#0c6>, </span><span style=color:#0c6>{</span>msg<span style=color:#0c6>}</span><span style=color:#0c6>)&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@send.register</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>send_email</span>(msg: Email):
</span></span><span style=display:flex><span>    <span style=color:#5918bb;font-weight:700>print</span>(<span style=color:#0c6>f</span><span style=color:#0c6>&#34;Sending email to </span><span style=color:#0c6>{</span><span style=color:#0c6>&#39; and &#39;</span><span style=color:#2c5dcd>.</span>join(msg<span style=color:#2c5dcd>.</span>to)<span style=color:#0c6>}</span><span style=color:#0c6>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@send.register</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>send_sms</span>(msg: Sms):
</span></span><span style=display:flex><span>    <span style=color:#5918bb;font-weight:700>print</span>(<span style=color:#0c6>f</span><span style=color:#0c6>&#34;Sending SMS to </span><span style=color:#0c6>{</span>msg<span style=color:#2c5dcd>.</span>to<span style=color:#0c6>}</span><span style=color:#0c6>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>handle_message</span>(message: typing<span style=color:#2c5dcd>.</span>Dict[<span style=color:#5918bb;font-weight:700>str</span>, typing<span style=color:#2c5dcd>.</span>Any]):
</span></span><span style=display:flex><span>    parsed_message <span style=color:#2c5dcd>=</span> pydantic<span style=color:#2c5dcd>.</span>parse_obj_as(typing<span style=color:#2c5dcd>.</span>Union[Email, Sms], message)
</span></span><span style=display:flex><span>    send(parsed_message)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>handle_message({
</span></span><span style=display:flex><span>    <span style=color:#0c6>&#34;to&#34;</span>: [<span style=color:#0c6>&#39;bill@gmail.com&#39;</span>, <span style=color:#0c6>&#39;alice@outlook.com&#39;</span>],
</span></span><span style=display:flex><span>    <span style=color:#0c6>&#34;subject&#34;</span>: <span style=color:#0c6>&#34;BBQ Emergency&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#0c6>&#34;message&#34;</span>: <span style=color:#0c6>&#34;Need more ketchup!&#34;</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#&gt; Sending email to bill@gmail.com and alice@outlook.com</span>
</span></span><span style=display:flex><span>handle_message({
</span></span><span style=display:flex><span>    <span style=color:#0c6>&#34;to&#34;</span>: <span style=color:#0c6>&#34;911&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#0c6>&#34;message&#34;</span>: <span style=color:#0c6>&#34;Burnt finger at BBQ :(&#34;</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span><span style=color:#0080ff;font-style:italic>#&gt; Sending SMS to 911</span>
</span></span></code></pre></td></tr></table></div></div></details><h2 id=testing>Testing<a hidden class=anchor aria-hidden=true href=#testing>#</a></h2><p>This type-based message handling is neat and all, but can we test this? I found it to be a bit challenging to integrate <a href=https://docs.python.org/3/library/unittest.mock.html>mocking</a> with the <code>@functools.singledispatch</code>, but ended up using a simple context manager to conveniently swap out registered type handlers with mocks:</p><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> contextlib
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> typing
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> unittest.mock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@contextlib.contextmanager</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>override_registry</span>(
</span></span><span style=display:flex><span>    dispatch_callable: <span style=color:#0c6>&#34;_SingleDispatchCallable[Any]&#34;</span>,
</span></span><span style=display:flex><span>    cls: typing<span style=color:#2c5dcd>.</span>Type,
</span></span><span style=display:flex><span>    mock: unittest<span style=color:#2c5dcd>.</span>mock<span style=color:#2c5dcd>.</span>Mock,
</span></span><span style=display:flex><span>):
</span></span><span style=display:flex><span>    <span style=color:#0c6>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#0c6>    Helper to override a singledispatch function with a mock for testing.
</span></span></span><span style=display:flex><span><span style=color:#0c6>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    original <span style=color:#2c5dcd>=</span> dispatch_callable<span style=color:#2c5dcd>.</span>registry[cls]
</span></span><span style=display:flex><span>    dispatch_callable<span style=color:#2c5dcd>.</span>register(cls, mock)
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>yield</span> mock
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>finally</span>:
</span></span><span style=display:flex><span>        dispatch_callable<span style=color:#2c5dcd>.</span>register(cls, original)
</span></span></code></pre></td></tr></table></div></div><details><summary>Example of a full set of tests to validate that routing logic is appropriately configured</summary><div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> functools
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> pydantic
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> typing
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> contextlib
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>import</span> unittest.mock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Email</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    to: typing<span style=color:#2c5dcd>.</span>List[<span style=color:#5918bb;font-weight:700>str</span>]
</span></span><span style=display:flex><span>    subject: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    message: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>class</span> <span style=text-decoration:underline>Sms</span>(pydantic<span style=color:#2c5dcd>.</span>BaseModel):
</span></span><span style=display:flex><span>    to: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>    message: <span style=color:#5918bb;font-weight:700>str</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@functools.singledispatch</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>send</span>(msg):
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># this is the default sender, which should only ever be called if a message</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># comes in with a type for which we haven&#39;t registered a handler. in this</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># situation, we may want to throw an error to signal that we don&#39;t know how</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># to handle this message; alternatively we may want to have a default handler</span>
</span></span><span style=display:flex><span>    <span style=color:#0080ff;font-style:italic># that applies to any types without explicitely registered handlers.</span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>raise</span> <span style=color:#5918bb;font-weight:700>Exception</span>(<span style=color:#0c6>f</span><span style=color:#0c6>&#34;Unexpected message type (</span><span style=color:#0c6>{</span><span style=color:#5918bb;font-weight:700>type</span>(msg)<span style=color:#0c6>=}</span><span style=color:#0c6>, </span><span style=color:#0c6>{</span>msg<span style=color:#0c6>}</span><span style=color:#0c6>)&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@send.register</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>send_email</span>(msg: Email):
</span></span><span style=display:flex><span>    <span style=color:#5918bb;font-weight:700>print</span>(<span style=color:#0c6>f</span><span style=color:#0c6>&#34;Sending email to </span><span style=color:#0c6>{</span><span style=color:#0c6>&#39; and &#39;</span><span style=color:#2c5dcd>.</span>join(msg<span style=color:#2c5dcd>.</span>to)<span style=color:#0c6>}</span><span style=color:#0c6>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@send.register</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>send_sms</span>(msg: Sms):
</span></span><span style=display:flex><span>    <span style=color:#5918bb;font-weight:700>print</span>(<span style=color:#0c6>f</span><span style=color:#0c6>&#34;Sending SMS to </span><span style=color:#0c6>{</span>msg<span style=color:#2c5dcd>.</span>to<span style=color:#0c6>}</span><span style=color:#0c6>&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>handle_message</span>(message: typing<span style=color:#2c5dcd>.</span>Dict[<span style=color:#5918bb;font-weight:700>str</span>, typing<span style=color:#2c5dcd>.</span>Any]):
</span></span><span style=display:flex><span>    parsed_message <span style=color:#2c5dcd>=</span> pydantic<span style=color:#2c5dcd>.</span>parse_obj_as(typing<span style=color:#2c5dcd>.</span>Union[Email, Sms], message)
</span></span><span style=display:flex><span>    send(parsed_message)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff8000;font-weight:700>@contextlib.contextmanager</span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>override_registry</span>(
</span></span><span style=display:flex><span>    dispatch_callable: <span style=color:#0c6>&#34;_SingleDispatchCallable[Any]&#34;</span>,
</span></span><span style=display:flex><span>    cls: typing<span style=color:#2c5dcd>.</span>Type,
</span></span><span style=display:flex><span>    mock: unittest<span style=color:#2c5dcd>.</span>mock<span style=color:#2c5dcd>.</span>Mock,
</span></span><span style=display:flex><span>):
</span></span><span style=display:flex><span>    <span style=color:#0c6>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#0c6>    Helper to override a singledispatch function with a mock for testing.
</span></span></span><span style=display:flex><span><span style=color:#0c6>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    original <span style=color:#2c5dcd>=</span> dispatch_callable<span style=color:#2c5dcd>.</span>registry[cls]
</span></span><span style=display:flex><span>    dispatch_callable<span style=color:#2c5dcd>.</span>register(cls, mock)
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#2c5dcd;font-weight:700>yield</span> mock
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>finally</span>:
</span></span><span style=display:flex><span>        dispatch_callable<span style=color:#2c5dcd>.</span>register(cls, original)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>test_handling_email</span>():
</span></span><span style=display:flex><span>    <span style=color:#0c6>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#0c6>    Ensure that the system properly handles Email messages.
</span></span></span><span style=display:flex><span><span style=color:#0c6>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>with</span> override_registry(
</span></span><span style=display:flex><span>        send, Email, unittest<span style=color:#2c5dcd>.</span>mock<span style=color:#2c5dcd>.</span>MagicMock()
</span></span><span style=display:flex><span>    ) <span style=color:#2c5dcd;font-weight:700>as</span> called_mock, override_registry(
</span></span><span style=display:flex><span>        send, Sms, unittest<span style=color:#2c5dcd>.</span>mock<span style=color:#2c5dcd>.</span>MagicMock()
</span></span><span style=display:flex><span>    ) <span style=color:#2c5dcd;font-weight:700>as</span> not_called_mock:
</span></span><span style=display:flex><span>        output <span style=color:#2c5dcd>=</span> handle_message({
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;to&#34;</span>: [<span style=color:#0c6>&#39;bill@gmail.com&#39;</span>, <span style=color:#0c6>&#39;alice@outlook.com&#39;</span>],
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;subject&#34;</span>: <span style=color:#0c6>&#34;BBQ Emergency&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;message&#34;</span>: <span style=color:#0c6>&#34;Need more ketchup!&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>assert</span> called_mock<span style=color:#2c5dcd>.</span>call_count <span style=color:#2c5dcd>==</span> <span style=color:#5918bb;font-weight:700>1</span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>assert</span> <span style=color:#2c5dcd;font-weight:700>not</span> not_called_mock<span style=color:#2c5dcd>.</span>call_count
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#2c5dcd;font-weight:700>def</span> <span style=color:#ff8000;font-weight:700>test_handling_sms</span>():
</span></span><span style=display:flex><span>    <span style=color:#0c6>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#0c6>    Ensure that the system properly handles SMS messages.
</span></span></span><span style=display:flex><span><span style=color:#0c6>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>with</span> override_registry(
</span></span><span style=display:flex><span>        send, Sms, unittest<span style=color:#2c5dcd>.</span>mock<span style=color:#2c5dcd>.</span>MagicMock()
</span></span><span style=display:flex><span>    ) <span style=color:#2c5dcd;font-weight:700>as</span> called_mock, override_registry(
</span></span><span style=display:flex><span>        send, Email, unittest<span style=color:#2c5dcd>.</span>mock<span style=color:#2c5dcd>.</span>MagicMock()
</span></span><span style=display:flex><span>    ) <span style=color:#2c5dcd;font-weight:700>as</span> not_called_mock:
</span></span><span style=display:flex><span>        output <span style=color:#2c5dcd>=</span> handle_message({
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;to&#34;</span>: <span style=color:#0c6>&#34;911&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#0c6>&#34;message&#34;</span>: <span style=color:#0c6>&#34;Burnt finger at BBQ :(&#34;</span>
</span></span><span style=display:flex><span>        })
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>assert</span> called_mock<span style=color:#2c5dcd>.</span>call_count <span style=color:#2c5dcd>==</span> <span style=color:#5918bb;font-weight:700>1</span>
</span></span><span style=display:flex><span>    <span style=color:#2c5dcd;font-weight:700>assert</span> <span style=color:#2c5dcd;font-weight:700>not</span> not_called_mock<span style=color:#2c5dcd>.</span>call_count
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>test_handling_email()
</span></span><span style=display:flex><span>test_handling_sms()
</span></span></code></pre></td></tr></table></div></div><details><hr><p>This pattern is all a bit new to me and fresh in my mind. Hoping it can prove useful to others. I&rsquo;m very open to hearing concerns or suggestions for improvement from others if anyone has them.</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://alukach.com/tags/python/>python</a></li><li><a href=https://alukach.com/tags/pydantic/>pydantic</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2023 <a href=https://alukach.com/>anthony lukach</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="copy";function s(){t.innerText="copied!",setTimeout(()=>{t.innerText="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>