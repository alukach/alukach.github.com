<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>Roll your own PR preview CI pipeline | anthony lukach</title>
<meta name=keywords content="devops,github actions,s3">
<meta name=description content="Goal We want a CI pipeline that will build and deploy an instance of our frontend application for every PR created in our frontend repo. Additionally, we want to be able to easily spin up applications with overridden configuration to allow developers to test the frontend against experimental backends. Finally, we want a reporting mechanism to inform developers when and where these deployed environments are available.
Other Options Before you jump into this, consider that there are out-of-the-box solutions to solve this problem mentioned in the followup at the bottom of this page.">
<meta name=author content>
<link rel=canonical href=https://alukach.com/posts/diy-pr-previews/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.ec5cdd07fdb067133c5ff34dea9dd5600a5e402560ae010c52e0dc18a961a867.css integrity="sha256-7FzdB/2wZxM8X/NN6p3VYApeQCVgrgEMUuDcGKlhqGc=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://alukach.com/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://alukach.com/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://alukach.com/favicon-32x32.png>
<link rel=apple-touch-icon href=https://alukach.com/apple-touch-icon.png>
<link rel=mask-icon href=https://alukach.com/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.1">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)}(window,document,'script','https://www.google-analytics.com/analytics.js','ga'),ga('create','UA-16401510-1','auto'),ga('send','pageview'))</script><meta property="og:title" content="Roll your own PR preview CI pipeline">
<meta property="og:description" content="Goal We want a CI pipeline that will build and deploy an instance of our frontend application for every PR created in our frontend repo. Additionally, we want to be able to easily spin up applications with overridden configuration to allow developers to test the frontend against experimental backends. Finally, we want a reporting mechanism to inform developers when and where these deployed environments are available.
Other Options Before you jump into this, consider that there are out-of-the-box solutions to solve this problem mentioned in the followup at the bottom of this page.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://alukach.com/posts/diy-pr-previews/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-11-21T00:00:00+00:00">
<meta property="article:modified_time" content="2021-11-21T00:00:00+00:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Roll your own PR preview CI pipeline">
<meta name=twitter:description content="Goal We want a CI pipeline that will build and deploy an instance of our frontend application for every PR created in our frontend repo. Additionally, we want to be able to easily spin up applications with overridden configuration to allow developers to test the frontend against experimental backends. Finally, we want a reporting mechanism to inform developers when and where these deployed environments are available.
Other Options Before you jump into this, consider that there are out-of-the-box solutions to solve this problem mentioned in the followup at the bottom of this page.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://alukach.com/posts/"},{"@type":"ListItem","position":2,"name":"Roll your own PR preview CI pipeline","item":"https://alukach.com/posts/diy-pr-previews/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Roll your own PR preview CI pipeline","name":"Roll your own PR preview CI pipeline","description":"Goal We want a CI pipeline that will build and deploy an instance of our frontend application for every PR created in our frontend repo. Additionally, we want to be able to easily spin up applications with overridden configuration to allow developers to test the frontend against experimental backends. Finally, we want a reporting mechanism to inform developers when and where these deployed environments are available.\nOther Options Before you jump into this, consider that there are out-of-the-box solutions to solve this problem mentioned in the followup at the bottom of this page.","keywords":["devops","github actions","s3"],"articleBody":"Goal We want a CI pipeline that will build and deploy an instance of our frontend application for every PR created in our frontend repo. Additionally, we want to be able to easily spin up applications with overridden configuration to allow developers to test the frontend against experimental backends. Finally, we want a reporting mechanism to inform developers when and where these deployed environments are available.\nOther Options Before you jump into this, consider that there are out-of-the-box solutions to solve this problem mentioned in the followup at the bottom of this page.\nBackground: Project Infrastructure Our production frontend is a React application (using Next.js). We build this application into static HTML/CSS/JS files and upload them to an S3 bucket. This bucket has been setup to serve static websites and is served via HTTPS by CloudFront (see #270).\nThe frontend accesses multiple backend APIs (e.g. a STAC API, a FastAPI REST API). Deployment of those APIs is outside of the scope of the frontend codebase.\nCI: Cloud Infrastructure Our goal is to mimic the production frontend deployment to a reasonable degree.\n1. Setup a bucket First, we will need an S3 bucket to store our builds. We created a bucket (s3://project-frontend-ci) and configured it to serve static websites. As a sanity check, we wrote a simple message to a public file that we place at the root of the bucket:\n1  echo \"Project frontend CI builds\" | aws s3 cp - s3://project-frontend-ci/index.html --acl public-read --content-type text/html   We can verify that everything is configured properly by visiting the bucket‚Äôs website url: http://project-frontend-ci.s3-website.us-east-1.amazonaws.com/\n2. Setup SSL via API Gateway Unfortunately, S3 does not support serving content via SSL (i.e. over HTTPS). As such, we need to use something like API Gateway or CloudFront to accept traffic over HTTPS and to route it to our bucket‚Äôs content over HTTP. For the sake of simplicity, we chose to use API Gateway for this purpose. For our actual staging environment, we utilize CloudFront to more closely mimic the production environment, however for these temporary CI builds we felt that API Gateway was close-enough.\nWe created an API Gateway HTTP API configured to direct all traffic to our S3 bucket‚Äôs website URL: We can now visit our bucket over SSL via the API Gateway endpoint: https://0zy9z5ko27.execute-api.us-east-1.amazonaws.com/\n3. Setup a URL for the CI builds The downside of API Gateway or CloudFront is that it produces very unmemorable URLs. Just to be a bit fancy üíÖ , we set up a custom URL on domain.com. We settled on ci.project-staging.domain.com to pair nicely with our staging environment (project-staging.domain.com).\n Setting this up is a bit of a multi-step process. Click here to see the details... a. Create SSL Certificate On the AWS account owns the API Gateway HTTP API we just setup, we created an SSL Certificate via AWS Certificate Manager (ACM):\nb. Verify ownership of domain ACM requires that you verify that you have control of a domain before it will grant you an SSL certificate. After creating an SSL certificate, you‚Äôll see that it is in ‚ÄúPending Validation‚Äù status.\nTo verify that we control domain.com, we add a CNAME record to the domain.com hosted zone. Once this is done, we frantically refresh the ACM status page until it states that our domain has been verified.\nc. Setup API Gateway custom domain Back over to API Gateway, we set up a custom domain.\nAfter creating the custom domain, we add an API mapping to our HTTP API.\nd. Creating a DNS entry for our new URL We now want to instruct Route53 to direct all traffic sent to our URL (ci.project-staging.domain.com) to our new API Gateway custom domain. To do this, we copy the API Gateway domain name.\nWe use the copied API Gateway domain name to create a new DNS entry to facilitate this mapping:\n After this, we should be able to see our sanity-check message at https://ci.project-staging.domain.com.\nCI: Workflows Building \u0026 Deploying Our goal is to build a version of our frontend application for every pull request and have it available at https://ci.project-staging.domain.com. Our chosen strategy was to build each PR and to place the build in a path prefixed with the PR number (i.e. PR 208 should be available at https://ci.project-staging.domain.com/208). To facilitate this, your frontend application must be configured to allow it to be served from non-route paths. In the case of NextJS, this is done via the Base Path configuration.\nBuilding and Deploying the application via Github actions is pretty straightforward.\n Example of a simple build/deploy Github Actions workflow 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59  name:Deploy to CI environmenton:pull_request:jobs:build-and-deploy:runs-on:ubuntu-lateststeps:- name:Cancel Previous Runsuses:styfle/cancel-workflow-action@0.8.0with:access_token:${{ github.token }}- name:Checkoutuses:actions/checkout@v2- name:Use Node.js 14uses:actions/setup-node@v1with:node-version:14- name:Cache node modulesuses:actions/cache@v2env:cache-name:cache-node-moduleswith:path:node_moduleskey:${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/yarn.lock') }}restore-keys:|${{ runner.os }}-build-${{ env.cache-name }}- ${{ runner.os }}-build- ${{ runner.os }}-- name:Build and Exportid:buildenv:NEXT_PUBLIC_BASE_URL:https://ci.project-staging.domain.com/${{ github.event.pull_request.number }}NEXT_PUBLIC_STAC_API:${{ 'https://project-staging.domain.com/stac' }}NEXT_PUBLIC_ORDERS_API:${{ 'https://project-staging.domain.com/api' }}run:|yarn install yarn build yarn run next export- name:Configure AWS credentials from staging accountuses:aws-actions/configure-aws-credentials@v1with:aws-access-key-id:${{ secrets.STAGING_AWS_ACCESS_KEY_ID }}aws-secret-access-key:${{ secrets.STAGING_AWS_SECRET_ACCESS_KEY }}aws-region:us-east-1- name:Deploy üöÄrun:|aws s3 sync \\ ./out \\ s3://project-frontend-ci/${{ github.event.pull_request.number }} \\ --delete \\ --acl public-read  You can see that we pass in our Base URL and external APIs via the env at build time and that we have our AWS credentials available as encrypted secrets.\nNote that, as per the Github docs, the pull_request event only triggers when a PR is opened, updated, or re-opened:\n By default, a workflow only runs when a pull_request‚Äôs activity type is opened, synchronize, or reopened.\n  Adding a comment on our PR to notify others of the build Once the CI has built and deployed a new instance of our frontend, we want to notify others (e.g. those reviewing PRs) where they can view the build. To do this, we add the following steps to our Github Actions workflow to take place after our build:\n Example of jobs to add comments to a PR 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27  jobs:build-and-deploy:steps:# ...- name:Get current timeuses:gerred/actions/current-time@masterid:current-time- name:Find Commentuses:peter-evans/find-comment@v1id:find-commentwith:issue-number:${{ github.event.pull_request.number }}comment-author:\"github-actions[bot]\"body-includes:Latest commit deployed to- name:Create or update commentuses:peter-evans/create-or-update-comment@v1with:comment-id:${{ steps.find-comment.outputs.comment-id }}issue-number:${{ github.event.pull_request.number }}body:|üöÄ Latest commit deployed to https://ci.project-staging.domain.com/${{ github.event.pull_request.number }} * Date: `${{ steps.current-time.outputs.time }}` * Commit: ${{ github.sha }} (Merging ${{ github.event.pull_request.head.sha }} into ${{ github.event.pull_request.base.sha }})edit-mode:replace   These steps add a new comment to PRs, looking something like this:\nFor later commits to the PR, the original comment will be replaced rather than creating another comment. This helps us avoid littering user‚Äôs notifications and keeps a clean comment thread.\nAllow users to customize configuration As previously mentioned, the frontend connects to multiple backing APIs. By default, the CI builds point to our staging APIs. However, it‚Äôs a realistic scenario that a developer would want their custom environment to point to a different API release (e.g. a developer is working on frontend changes in tandem with changes being made to the backend API). To support this, we want to allow developers to manually override certain configurations. To do this, we added the workflow_dispatch trigger to our workflow, allowing for manual workflow runs. We also add inputs for each configuration we want to allow a developer to specify.\n Example of adding workflow_dispatch event with inputs to your workflow 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50  name:Deploy to CI environmenton:pull_request:workflow_dispatch:inputs:stac-api-url:description:Override STAC API URLdefault:https://project-staging.domain.com/stacorders-api-url:description:Override Orders API URLdefault:https://project-staging.domain.com/apideployment-id:description:Unique identifier for build (used to construct path for upload)required:truejobs:build-and-deploy:runs-on:ubuntu-lateststeps:# ...- name:Build and Exportid:buildenv:NEXT_PUBLIC_BASE_URL:https://ci.project-staging.domain.com/${{ github.event.inputs.deployment-id || github.event.pull_request.number }}NEXT_PUBLIC_STAC_API:${{ github.event.inputs.stac-api-url || 'https://project-staging.domain.com/stac' }}NEXT_PUBLIC_ORDERS_API:${{ github.event.inputs.orders-api-url || 'https://project-staging.domain.com/api' }}NEXT_PUBLIC_MB_TOKEN:pk.eyJ1IjoiZGV2c2VlZCIsImEiOiJjazB6YXU2bDUwMWNkM2VvNGNpMnFhOXMxIn0.c30a2TQIfCDF3GlqMdSQ_gNEXT_PUBLIC_GA_ID:GTM-WNP7MLFrun:|yarn install yarn build yarn run next export- name:Get current timeuses:gerred/actions/current-time@masterif:${{ github.event.pull_request.number }}# ...- name:Find Commentuses:peter-evans/find-comment@v1if:${{ github.event.pull_request.number }}# ...- name:Create or update commentuses:peter-evans/create-or-update-comment@v1if:${{ github.event.pull_request.number }}# ...   You‚Äôll note that any place where we originally specified our API configuration or had a dependency on a PR number, we now first try to retrieve the value from github.event.inputs (only available during manual workflow_dispatch events) and otherwise fall back to values used during standard PR builds. This can be achieved by utilizing the OR operator as so: ${{ github.event.inputs.deployment-id || github.event.pull_request.number }}.\nAdditionally, we will only want to comment on a PR during PR builds, so we avoid running the comment steps by adding an if: ${{ github.event.pull_request.number }} clause to each step that we want to skip.\nCleanup After each PR is merged, we want to clean up the past build to avoid unnecessary storage in our CI bucket. This can be achieved with another workflow that cleans up the build whenever a pull request is closed.\n Example of a workflow to destroy CI builds 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49  name:Destroy PR Previewon:pull_request:types:[closed]workflow_dispatch:inputs:deployment-id:description:Unique identifier of CI build to be deletedrequired:truejobs:build-and-deploy:runs-on:ubuntu-lateststeps:# ...- name:Destroy üí£run:|aws s3 rm --recursive s3://project-frontend-ci/${{ github.event.inputs.deployment-id || github.event.pull_request.number }}/- name:Get current timeuses:gerred/actions/current-time@masterif:${{ github.event.pull_request.number }}id:current-time- name:Find Commentuses:peter-evans/find-comment@v1if:${{ github.event.pull_request.number }}id:find-commentwith:issue-number:${{ github.event.pull_request.number }}comment-author:\"github-actions[bot]\"body-includes:Latest commit deployed to- name:Create or update commentuses:peter-evans/create-or-update-comment@v1if:${{ github.event.pull_request.number }}with:comment-id:${{ steps.find-comment.outputs.comment-id }}issue-number:${{ github.event.pull_request.number }}body:|--- üßπ Deleted build at https://ci.project-staging.domain.com/${{ github.event.inputs.deployment-id || github.event.pull_request.number }} * Date: `${{ steps.current-time.outputs.time }}`edit-mode:append   Our pull request message is then appended with information to let others know that the build environment is no longer available.\nPutting it all together To achieve our goals of deployment, notification, customization, and cleanup, we have settled on these two Github workflows:\n .github/workflows/deploy-pr-preview.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100  name:Deploy to CI environmenton:pull_request:workflow_dispatch:inputs:stac-api-url:description:Override STAC API URLdefault:https://project-staging.domain.com/stacorders-api-url:description:Override Orders API URLdefault:https://project-staging.domain.com/apideployment-id:description:Unique identifier for build (used to construct path for upload)required:truejobs:build-and-deploy:runs-on:ubuntu-lateststeps:- name:Cancel Previous Runsuses:styfle/cancel-workflow-action@0.8.0with:access_token:${{ github.token }}- name:Checkoutuses:actions/checkout@v2- name:Use Node.js 14uses:actions/setup-node@v1with:node-version:14- name:Cache node modulesuses:actions/cache@v2env:cache-name:cache-node-moduleswith:path:node_moduleskey:${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/yarn.lock') }}restore-keys:|${{ runner.os }}-build-${{ env.cache-name }}- ${{ runner.os }}-build- ${{ runner.os }}-- name:Build and Exportid:buildenv:NEXT_PUBLIC_BASE_URL:https://ci.project-staging.domain.com/${{ github.event.inputs.deployment-id || github.event.pull_request.number }}NEXT_PUBLIC_STAC_API:${{ github.event.inputs.stac-api-url || 'https://project-staging.domain.com/stac' }}NEXT_PUBLIC_ORDERS_API:${{ github.event.inputs.orders-api-url || 'https://project-staging.domain.com/api' }}NEXT_PUBLIC_MB_TOKEN:pk.eyJ1IjoiZGV2c2VlZCIsImEiOiJjazB6YXU2bDUwMWNkM2VvNGNpMnFhOXMxIn0.c30a2TQIfCDF3GlqMdSQ_gNEXT_PUBLIC_GA_ID:GTM-WNP7MLFrun:|yarn install yarn build yarn run next export- name:Configure AWS credentials from staging accountuses:aws-actions/configure-aws-credentials@v1with:aws-access-key-id:${{ secrets.STAGING_AWS_ACCESS_KEY_ID }}aws-secret-access-key:${{ secrets.STAGING_AWS_SECRET_ACCESS_KEY }}aws-region:us-east-1- name:Deploy üöÄrun:|aws s3 sync \\ ./out \\ s3://project-frontend-ci/${{ github.event.inputs.deployment-id || github.event.pull_request.number }} \\ --delete \\ --acl public-read- name:Get current timeuses:gerred/actions/current-time@masterif:${{ github.event.pull_request.number }}id:current-time- name:Find Commentuses:peter-evans/find-comment@v1if:${{ github.event.pull_request.number }}id:find-commentwith:issue-number:${{ github.event.pull_request.number }}comment-author:\"github-actions[bot]\"body-includes:Latest commit deployed to- name:Create or update commentuses:peter-evans/create-or-update-comment@v1if:${{ github.event.pull_request.number }}with:comment-id:${{ steps.find-comment.outputs.comment-id }}issue-number:${{ github.event.pull_request.number }}body:|üöÄ Latest commit deployed to https://ci.project-staging.domain.com/${{ github.event.inputs.deployment-id || github.event.pull_request.number }} * Date: `${{ steps.current-time.outputs.time }}` * Commit: ${{ github.sha }} (merging ${{ github.event.pull_request.head.sha }} into ${{ github.event.pull_request.base.sha }})edit-mode:replace    .github/workflows/destroy-pr-preview.yml 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58  name:Destroy PR Previewon:pull_request:types:[closed]workflow_dispatch:inputs:deployment-id:description:Unique identifier of CI build to be deletedrequired:truejobs:build-and-deploy:runs-on:ubuntu-lateststeps:- name:Cancel Previous Runsuses:styfle/cancel-workflow-action@0.8.0with:access_token:${{ github.token }}- name:Configure AWS credentials from staging accountuses:aws-actions/configure-aws-credentials@v1with:aws-access-key-id:${{ secrets.STAGING_AWS_ACCESS_KEY_ID }}aws-secret-access-key:${{ secrets.STAGING_AWS_SECRET_ACCESS_KEY }}aws-region:us-east-1- name:Destroy üí£run:|aws s3 rm --recursive s3://project-frontend-ci/${{ github.event.inputs.deployment-id || github.event.pull_request.number }}/- name:Get current timeuses:gerred/actions/current-time@masterif:${{ github.event.pull_request.number }}id:current-time- name:Find Commentuses:peter-evans/find-comment@v1if:${{ github.event.pull_request.number }}id:find-commentwith:issue-number:${{ github.event.pull_request.number }}comment-author:\"github-actions[bot]\"body-includes:Latest commit deployed to- name:Create or update commentuses:peter-evans/create-or-update-comment@v1if:${{ github.event.pull_request.number }}with:comment-id:${{ steps.find-comment.outputs.comment-id }}issue-number:${{ github.event.pull_request.number }}body:|--- üßπ Deleted build at https://ci.project-staging.domain.com/${{ github.event.inputs.deployment-id || github.event.pull_request.number }} * Date: `${{ steps.current-time.outputs.time }}`edit-mode:append    This system is very new for us and required some additional changes to other services (i.e. updating CORS rules on our APIs to allow us to use this new URL), but so far it seems to be operating as expected. Hoping that this can help others who are looking to build out better CI preview environments for their applications.\n Followup  this is super cool but was there a reason we couldn‚Äôt use netlify or another third party service for this?\n This is a fair question. We opted to roll our own solution being that the general idea (uploading builds to S3) was something that we were already doing for deployments to our Production and Staging environments. However, if you‚Äôre starting a new project, you may be interested in achieving per-PR deployments with a third party tool. It appears that most common hosting solutions offer something for this:\n Netlify offers Deploy Previews Vercel offers Preview URLs via its Github Integration AWS Amplify offers Web Previews Surge.sh can be configured to preview URLs via the surge-preview Github Action  ","wordCount":"2217","inLanguage":"en","datePublished":"2021-11-21T00:00:00Z","dateModified":"2021-11-21T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://alukach.com/posts/diy-pr-previews/"},"publisher":{"@type":"Organization","name":"anthony lukach","logo":{"@type":"ImageObject","url":"https://alukach.com/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://alukach.com/ accesskey=h title="anthony lukach (Alt + H)">anthony lukach</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://alukach.com/categories/posts title=Posts>
<span>Posts</span>
</a>
</li>
<li>
<a href=https://alukach.com/categories/snippets title=Snippets>
<span>Snippets</span>
</a>
</li>
<li>
<a href=https://alukach.com/search title="Search (Alt + /)" accesskey=/>
<span>Search</span>
</a>
</li>
<li>
<a href=https://alukach.com/resume title=R√©sum√©>
<span>R√©sum√©</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<h1 class=post-title>
Roll your own PR preview CI pipeline
</h1>
<div class=post-meta><span title="2021-11-21 00:00:00 +0000 UTC">November 21, 2021</span>&nbsp;¬∑&nbsp;11 min&nbsp;|&nbsp;<a href=https://github.com/alukach/alukach.github.io/edit/main/content/posts/diy-pr-previews.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header> <div class=toc>
<details>
<summary accesskey=c title="(Alt + C)">
<span class=details>Table of Contents</span>
</summary>
<div class=inner><ul>
<li>
<a href=#goal aria-label=Goal>Goal</a><ul>
<li>
<a href=#other-options aria-label="Other Options">Other Options</a></li></ul>
</li>
<li>
<a href=#background-project-infrastructure aria-label="Background: Project Infrastructure">Background: Project Infrastructure</a></li>
<li>
<a href=#ci-cloud-infrastructure aria-label="CI: Cloud Infrastructure">CI: Cloud Infrastructure</a><ul>
<li>
<a href=#1-setup-a-bucket aria-label="1. Setup a bucket">1. Setup a bucket</a></li>
<li>
<a href=#2-setup-ssl-via-api-gateway aria-label="2. Setup SSL via API Gateway">2. Setup SSL via API Gateway</a></li>
<li>
<a href=#3-setup-a-url-for-the-ci-builds aria-label="3. Setup a URL for the CI builds">3. Setup a URL for the CI builds</a><ul>
<li>
<a href=#a-create-ssl-certificate aria-label="a. Create SSL Certificate">a. Create SSL Certificate</a></li>
<li>
<a href=#b-verify-ownership-of-domain aria-label="b. Verify ownership of domain">b. Verify ownership of domain</a></li>
<li>
<a href=#c-setup-api-gateway-custom-domain aria-label="c. Setup API Gateway custom domain">c. Setup API Gateway custom domain</a></li>
<li>
<a href=#d-creating-a-dns-entry-for-our-new-url aria-label="d. Creating a DNS entry for our new URL">d. Creating a DNS entry for our new URL</a></li></ul>
</li></ul>
</li>
<li>
<a href=#ci-workflows aria-label="CI: Workflows">CI: Workflows</a><ul>
<li>
<a href=#building--deploying aria-label="Building &amp;amp; Deploying">Building & Deploying</a></li>
<li>
<a href=#adding-a-comment-on-our-pr-to-notify-others-of-the-build aria-label="Adding a comment on our PR to notify others of the build">Adding a comment on our PR to notify others of the build</a></li>
<li>
<a href=#allow-users-to-customize-configuration aria-label="Allow users to customize configuration">Allow users to customize configuration</a></li>
<li>
<a href=#cleanup aria-label=Cleanup>Cleanup</a></li>
<li>
<a href=#putting-it-all-together aria-label="Putting it all together">Putting it all together</a></li>
<li>
<a href=#followup aria-label=Followup>Followup</a>
</li>
</ul>
</li>
</ul>
</div>
</details>
</div>
<div class=post-content><h2 id=goal>Goal<a hidden class=anchor aria-hidden=true href=#goal>#</a></h2>
<p>We want a CI pipeline that will build and deploy an instance of our frontend application for every PR created in our frontend repo. Additionally, we want to be able to easily spin up applications with overridden configuration to allow developers to test the frontend against experimental backends. Finally, we want a reporting mechanism to inform developers when and where these deployed environments are available.</p>
<h3 id=other-options>Other Options<a hidden class=anchor aria-hidden=true href=#other-options>#</a></h3>
<p>Before you jump into this, consider that there are out-of-the-box solutions to solve this problem mentioned in the <a href=#followup>followup</a> at the bottom of this page.</p>
<h2 id=background-project-infrastructure>Background: Project Infrastructure<a hidden class=anchor aria-hidden=true href=#background-project-infrastructure>#</a></h2>
<p>Our production frontend is a React application (using Next.js). We build this application into static HTML/CSS/JS files and upload them to an S3 bucket. This bucket has been <a href=https://docs.aws.amazon.com/AmazonS3/latest/userguide/WebsiteHosting.html>setup to serve static websites</a> and is served via HTTPS by CloudFront (see #270).</p>
<p>The frontend accesses multiple backend APIs (e.g. a STAC API, a FastAPI REST API). Deployment of those APIs is outside of the scope of the frontend codebase.</p>
<h2 id=ci-cloud-infrastructure>CI: Cloud Infrastructure<a hidden class=anchor aria-hidden=true href=#ci-cloud-infrastructure>#</a></h2>
<p>Our goal is to mimic the production frontend deployment to a reasonable degree.</p>
<h3 id=1-setup-a-bucket>1. Setup a bucket<a hidden class=anchor aria-hidden=true href=#1-setup-a-bucket>#</a></h3>
<p>First, we will need an S3 bucket to store our builds. We created a bucket (<code>s3://project-frontend-ci</code>) and configured it to serve static websites. As a sanity check, we wrote a simple message to a public file that we place at the root of the bucket:</p>
<div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-sh data-lang=sh><span style=color:#5918bb;font-weight:700>echo</span> <span style=color:#0c6>&#34;Project frontend CI builds&#34;</span> | aws s3 cp - s3://project-frontend-ci/index.html --acl public-read --content-type text/html
</code></pre></td></tr></table>
</div>
</div><p>We can verify that everything is configured properly by visiting the bucket&rsquo;s website url: <a href=http://project-frontend-ci.s3-website.us-east-1.amazonaws.com/>http://project-frontend-ci.s3-website.us-east-1.amazonaws.com/</a></p>
<h3 id=2-setup-ssl-via-api-gateway>2. Setup SSL via API Gateway<a hidden class=anchor aria-hidden=true href=#2-setup-ssl-via-api-gateway>#</a></h3>
<p>Unfortunately, S3 does not support serving content via SSL (i.e. over HTTPS). As such, we need to use something like API Gateway or CloudFront to accept traffic over HTTPS and to route it to our bucket&rsquo;s content over HTTP. For the sake of simplicity, we chose to use API Gateway for this purpose. For our actual staging environment, we utilize CloudFront to more closely mimic the production environment, however for these temporary CI builds we felt that API Gateway was close-enough.</p>
<p>We created an API Gateway <a href=https://docs.aws.amazon.com/apigateway/latest/developerguide/http-api.html>HTTP API</a> configured to direct all traffic to our S3 bucket&rsquo;s website URL:
<img loading=lazy src=https://user-images.githubusercontent.com/897290/141352748-e30c371c-523b-4f31-89bb-618b7f87aa6b.png alt=image>
</p>
<p>We can now visit our bucket over SSL via the API Gateway endpoint: <a href=https://0zy9z5ko27.execute-api.us-east-1.amazonaws.com/>https://0zy9z5ko27.execute-api.us-east-1.amazonaws.com/</a></p>
<h3 id=3-setup-a-url-for-the-ci-builds>3. Setup a URL for the CI builds<a hidden class=anchor aria-hidden=true href=#3-setup-a-url-for-the-ci-builds>#</a></h3>
<p>The downside of API Gateway or CloudFront is that it produces very unmemorable URLs. Just to be a bit fancy üíÖ , we set up a custom URL on <code>domain.com</code>. We settled on <code>ci.project-staging.domain.com</code> to pair nicely with our staging environment (<code>project-staging.domain.com</code>).</p>
<details>
<summary>Setting this up is a bit of a multi-step process. Click here to see the details...</summary>
<h4 id=a-create-ssl-certificate>a. Create SSL Certificate<a hidden class=anchor aria-hidden=true href=#a-create-ssl-certificate>#</a></h4>
<p>On the AWS account owns the API Gateway HTTP API we just setup, we created an SSL Certificate via AWS Certificate Manager (ACM):</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/897290/141357476-cafcc308-2215-49d2-b3c5-302f944fd16a.png alt=image>
</p>
<h4 id=b-verify-ownership-of-domain>b. Verify ownership of domain<a hidden class=anchor aria-hidden=true href=#b-verify-ownership-of-domain>#</a></h4>
<p>ACM requires that you verify that you have control of a domain before it will grant you an SSL certificate. After creating an SSL certificate, you&rsquo;ll see that it is in &ldquo;Pending Validation&rdquo; status.</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/897290/141358311-217d51dd-8b13-413c-95f4-88c0c61d1b69.png alt=image>
</p>
<p>To verify that we control <code>domain.com</code>, we add a CNAME record to the <code>domain.com</code> hosted zone. Once this is done, we frantically refresh the ACM status page until it states that our domain has been verified.</p>
<h4 id=c-setup-api-gateway-custom-domain>c. Setup API Gateway custom domain<a hidden class=anchor aria-hidden=true href=#c-setup-api-gateway-custom-domain>#</a></h4>
<p>Back over to API Gateway, we set up a custom domain.</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/897290/141358750-797889a4-d79b-492f-b9fd-c4f0015a1766.png alt=image>
</p>
<p>After creating the custom domain, we add an API mapping to our HTTP API.</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/897290/141359117-c5ea1a3d-6bbf-4efa-bf61-813509358eb2.png alt=image>
</p>
<h4 id=d-creating-a-dns-entry-for-our-new-url>d. Creating a DNS entry for our new URL<a hidden class=anchor aria-hidden=true href=#d-creating-a-dns-entry-for-our-new-url>#</a></h4>
<p>We now want to instruct Route53 to direct all traffic sent to our URL (<code>ci.project-staging.domain.com</code>) to our new API Gateway custom domain. To do this, we copy the API Gateway domain name.</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/897290/141359323-e8eec982-af38-4246-b49a-5099ea1ec5af.png alt=image>
</p>
<p>We use the copied API Gateway domain name to create a new DNS entry to facilitate this mapping:</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/897290/141360545-c020accc-e4b3-46b0-ab50-82723b356a2e.png alt=image>
</p>
</details>
<p>After this, we should be able to see our sanity-check message at <a href=https://ci.project-staging.domain.com>https://ci.project-staging.domain.com</a>.</p>
<h2 id=ci-workflows>CI: Workflows<a hidden class=anchor aria-hidden=true href=#ci-workflows>#</a></h2>
<h3 id=building--deploying>Building & Deploying<a hidden class=anchor aria-hidden=true href=#building--deploying>#</a></h3>
<p>Our goal is to build a version of our frontend application for every pull request and have it available at <a href=https://ci.project-staging.domain.com>https://ci.project-staging.domain.com</a>. Our chosen strategy was to build each PR and to place the build in a path prefixed with the PR number (i.e. PR 208 should be available at <a href=https://ci.project-staging.domain.com/208)>https://ci.project-staging.domain.com/208)</a>. To facilitate this, your frontend application must be configured to allow it to be served from non-route paths. In the case of NextJS, this is done via the <a href=https://nextjs.org/docs/api-reference/next.config.js/basepath>Base Path configuration</a>.</p>
<p>Building and Deploying the application via Github actions is pretty straightforward.</p>
<details>
<summary>Example of a simple build/deploy Github Actions workflow</summary>
<div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Deploy to CI environment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>on</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>pull_request</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>jobs</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>build-and-deploy</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>runs-on</span>:<span style=color:#cbcbcb> </span>ubuntu-latest<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>steps</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Cancel Previous Runs<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>styfle/cancel-workflow-action@0.8.0<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>access_token</span>:<span style=color:#cbcbcb> </span>${{ github.token }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Checkout<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>actions/checkout@v2<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Use Node.js 14<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>actions/setup-node@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>node-version</span>:<span style=color:#cbcbcb> </span><span style=color:#5918bb;font-weight:700>14</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Cache node modules<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>actions/cache@v2<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>env</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>cache-name</span>:<span style=color:#cbcbcb> </span>cache-node-modules<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>path</span>:<span style=color:#cbcbcb> </span>node_modules<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>key</span>:<span style=color:#cbcbcb> </span>${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(&#39;**/yarn.lock&#39;) }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>restore-keys</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>            ${{ runner.os }}-build-${{ env.cache-name }}-
</span><span style=color:#0c6;font-style:italic>            ${{ runner.os }}-build-
</span><span style=color:#0c6;font-style:italic>            ${{ runner.os }}-</span><span style=color:#cbcbcb>            
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Build and Export<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>id</span>:<span style=color:#cbcbcb> </span>build<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>env</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_BASE_URL</span>:<span style=color:#cbcbcb> </span>https://ci.project-staging.domain.com/${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_STAC_API</span>:<span style=color:#cbcbcb> </span>${{ &#39;https://project-staging.domain.com/stac&#39; }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_ORDERS_API</span>:<span style=color:#cbcbcb> </span>${{ &#39;https://project-staging.domain.com/api&#39; }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>          yarn install
</span><span style=color:#0c6;font-style:italic>          yarn build
</span><span style=color:#0c6;font-style:italic>          yarn run next export</span><span style=color:#cbcbcb>          
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Configure AWS credentials from staging account<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>aws-actions/configure-aws-credentials@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>aws-access-key-id</span>:<span style=color:#cbcbcb> </span>${{ secrets.STAGING_AWS_ACCESS_KEY_ID }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>aws-secret-access-key</span>:<span style=color:#cbcbcb> </span>${{ secrets.STAGING_AWS_SECRET_ACCESS_KEY }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>aws-region</span>:<span style=color:#cbcbcb> </span>us-east-1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Deploy üöÄ<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>          aws s3 sync \
</span><span style=color:#0c6;font-style:italic>            ./out \
</span><span style=color:#0c6;font-style:italic>            s3://project-frontend-ci/${{ github.event.pull_request.number }} \
</span><span style=color:#0c6;font-style:italic>            --delete \
</span><span style=color:#0c6;font-style:italic>            --acl public-read</span><span style=color:#cbcbcb>          
</span></code></pre></td></tr></table>
</div>
</div><p>You can see that we pass in our Base URL and external APIs via the <code>env</code> at build time and that we have our AWS credentials available as <a href=https://docs.github.com/en/actions/security-guides/encrypted-secrets>encrypted secrets</a>.</p>
<p>Note that, as per the <a href=https://docs.github.com/en/actions/learn-github-actions/events-that-trigger-workflows#pull_request>Github docs</a>, the <code>pull_request</code> event only triggers when a PR is opened, updated, or re-opened:</p>
<blockquote>
<p>By default, a workflow only runs when a <code>pull_request</code>&rsquo;s activity type is <code>opened</code>, <code>synchronize</code>, or <code>reopened</code>.</p>
</blockquote>
</details>
<h3 id=adding-a-comment-on-our-pr-to-notify-others-of-the-build>Adding a comment on our PR to notify others of the build<a hidden class=anchor aria-hidden=true href=#adding-a-comment-on-our-pr-to-notify-others-of-the-build>#</a></h3>
<p>Once the CI has built and deployed a new instance of our frontend, we want to notify others (e.g. those reviewing PRs) where they can view the build. To do this, we add the following steps to our Github Actions workflow to take place after our build:</p>
<details>
<summary>Example of jobs to add comments to a PR</summary>
<div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#2c5dcd;font-weight:700>jobs</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>build-and-deploy</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>steps</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span><span style=color:#0080ff;font-style:italic># ...</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Get current time<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>gerred/actions/current-time@master<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>id</span>:<span style=color:#cbcbcb> </span>current-time<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Find Comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>peter-evans/find-comment@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>id</span>:<span style=color:#cbcbcb> </span>find-comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>issue-number</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>comment-author</span>:<span style=color:#cbcbcb> </span><span style=color:#0c6>&#34;github-actions[bot]&#34;</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>body-includes</span>:<span style=color:#cbcbcb> </span>Latest commit deployed to<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Create or update comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>peter-evans/create-or-update-comment@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>comment-id</span>:<span style=color:#cbcbcb> </span>${{ steps.find-comment.outputs.comment-id }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>issue-number</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>body</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>            üöÄ Latest commit deployed to https://ci.project-staging.domain.com/${{ github.event.pull_request.number }}
</span><span style=color:#0c6;font-style:italic>            * Date: `${{ steps.current-time.outputs.time }}`
</span><span style=color:#0c6;font-style:italic>            * Commit: ${{ github.sha }} (Merging ${{ github.event.pull_request.head.sha }} into ${{ github.event.pull_request.base.sha }})</span><span style=color:#cbcbcb>            
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>edit-mode</span>:<span style=color:#cbcbcb> </span>replace<span style=color:#cbcbcb>
</span></code></pre></td></tr></table>
</div>
</div></details>
<p>These steps add a new comment to PRs, looking something like this:</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/897290/141362960-87186629-d0f7-4501-a8c3-273bb923c7bc.png alt=image>
</p>
<p>For later commits to the PR, the original comment will be replaced rather than creating another comment. This helps us avoid littering user&rsquo;s notifications and keeps a clean comment thread.</p>
<h3 id=allow-users-to-customize-configuration>Allow users to customize configuration<a hidden class=anchor aria-hidden=true href=#allow-users-to-customize-configuration>#</a></h3>
<p>As previously mentioned, the frontend connects to multiple backing APIs. By default, the CI builds point to our staging APIs. However, it&rsquo;s a realistic scenario that a developer would want their custom environment to point to a different API release (e.g. a developer is working on frontend changes in tandem with changes being made to the backend API). To support this, we want to allow developers to manually override certain configurations. To do this, we added the <code>workflow_dispatch</code> trigger to our workflow, allowing for <a href=https://docs.github.com/en/actions/managing-workflow-runs/manually-running-a-workflow#running-a-workflow-using-the-rest-api>manual workflow runs</a>. We also add <code>inputs</code> for each configuration we want to allow a developer to specify.</p>
<details>
<summary>Example of adding <code>workflow_dispatch</code> event with <code>inputs</code> to your workflow</summary>
<div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Deploy to CI environment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>on</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>pull_request</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>workflow_dispatch</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>inputs</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span><span style=color:#2c5dcd;font-weight:700>stac-api-url</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>description</span>:<span style=color:#cbcbcb> </span>Override STAC API URL<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>default</span>:<span style=color:#cbcbcb> </span>https://project-staging.domain.com/stac<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span><span style=color:#2c5dcd;font-weight:700>orders-api-url</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>description</span>:<span style=color:#cbcbcb> </span>Override Orders API URL<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>default</span>:<span style=color:#cbcbcb> </span>https://project-staging.domain.com/api<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span><span style=color:#2c5dcd;font-weight:700>deployment-id</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>description</span>:<span style=color:#cbcbcb> </span>Unique identifier for build (used to construct path for upload)<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>required</span>:<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>true</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>jobs</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>build-and-deploy</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>runs-on</span>:<span style=color:#cbcbcb> </span>ubuntu-latest<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>steps</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span><span style=color:#0080ff;font-style:italic># ...</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Build and Export<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>id</span>:<span style=color:#cbcbcb> </span>build<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>env</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_BASE_URL</span>:<span style=color:#cbcbcb> </span>https://ci.project-staging.domain.com/${{ github.event.inputs.deployment-id || github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_STAC_API</span>:<span style=color:#cbcbcb> </span>${{ github.event.inputs.stac-api-url || &#39;https://project-staging.domain.com/stac&#39; }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_ORDERS_API</span>:<span style=color:#cbcbcb> </span>${{ github.event.inputs.orders-api-url || &#39;https://project-staging.domain.com/api&#39; }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_MB_TOKEN</span>:<span style=color:#cbcbcb> </span>pk.eyJ1IjoiZGV2c2VlZCIsImEiOiJjazB6YXU2bDUwMWNkM2VvNGNpMnFhOXMxIn0.c30a2TQIfCDF3GlqMdSQ_g<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_GA_ID</span>:<span style=color:#cbcbcb> </span>GTM-WNP7MLF<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>          yarn install
</span><span style=color:#0c6;font-style:italic>          yarn build
</span><span style=color:#0c6;font-style:italic>          yarn run next export</span><span style=color:#cbcbcb>          
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Get current time<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>gerred/actions/current-time@master<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#0080ff;font-style:italic># ...</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Find Comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>peter-evans/find-comment@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#0080ff;font-style:italic># ...</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Create or update comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>peter-evans/create-or-update-comment@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#0080ff;font-style:italic># ...</span><span style=color:#cbcbcb>
</span></code></pre></td></tr></table>
</div>
</div></details>
<p>You&rsquo;ll note that any place where we originally specified our API configuration or had a dependency on a PR number, we now first try to retrieve the value from <code>github.event.inputs</code> (only available during manual <code>workflow_dispatch</code> events) and otherwise fall back to values used during standard PR builds. This can be achieved by utilizing the <a href=https://docs.github.com/en/actions/learn-github-actions/expressions#operators>OR operator</a> as so: <code>${{ github.event.inputs.deployment-id || github.event.pull_request.number }}</code>.</p>
<p>Additionally, we will only want to comment on a PR during PR builds, so we avoid running the comment steps by adding an <code>if: ${{ github.event.pull_request.number }}</code> clause to each step that we want to skip.</p>
<h3 id=cleanup>Cleanup<a hidden class=anchor aria-hidden=true href=#cleanup>#</a></h3>
<p>After each PR is merged, we want to clean up the past build to avoid unnecessary storage in our CI bucket. This can be achieved with another workflow that cleans up the build whenever a pull request is closed.</p>
<details>
<summary>Example of a workflow to destroy CI builds</summary>
<div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Destroy PR Preview<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>on</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>pull_request</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>types</span>:<span style=color:#cbcbcb> </span>[closed]<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>workflow_dispatch</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>inputs</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span><span style=color:#2c5dcd;font-weight:700>deployment-id</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>description</span>:<span style=color:#cbcbcb> </span>Unique identifier of CI build to be deleted<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>required</span>:<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>true</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>jobs</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>build-and-deploy</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>runs-on</span>:<span style=color:#cbcbcb> </span>ubuntu-latest<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>steps</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span><span style=color:#0080ff;font-style:italic># ...</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Destroy üí£<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>          </span><span style=color:#cbcbcb>          </span>aws s3 rm --recursive s3://project-frontend-ci/${{ github.event.inputs.deployment-id || github.event.pull_request.number }}/<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Get current time<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>gerred/actions/current-time@master<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>id</span>:<span style=color:#cbcbcb> </span>current-time<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Find Comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>peter-evans/find-comment@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>id</span>:<span style=color:#cbcbcb> </span>find-comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>issue-number</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>comment-author</span>:<span style=color:#cbcbcb> </span><span style=color:#0c6>&#34;github-actions[bot]&#34;</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>body-includes</span>:<span style=color:#cbcbcb> </span>Latest commit deployed to<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Create or update comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>peter-evans/create-or-update-comment@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>comment-id</span>:<span style=color:#cbcbcb> </span>${{ steps.find-comment.outputs.comment-id }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>issue-number</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>body</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>            ---
</span><span style=color:#0c6;font-style:italic>            üßπ Deleted build at https://ci.project-staging.domain.com/${{ github.event.inputs.deployment-id || github.event.pull_request.number }} 
</span><span style=color:#0c6;font-style:italic>            
</span><span style=color:#0c6;font-style:italic>            * Date: `${{ steps.current-time.outputs.time }}`</span><span style=color:#cbcbcb>            
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>edit-mode</span>:<span style=color:#cbcbcb> </span>append<span style=color:#cbcbcb>
</span></code></pre></td></tr></table>
</div>
</div></details>
<p>Our pull request message is then appended with information to let others know that the build environment is no longer available.</p>
<p><img loading=lazy src=https://user-images.githubusercontent.com/897290/141370017-cf8b9fd2-ae20-46cd-9a0c-74083cb36a11.png alt=image>
</p>
<h3 id=putting-it-all-together>Putting it all together<a hidden class=anchor aria-hidden=true href=#putting-it-all-together>#</a></h3>
<p>To achieve our goals of deployment, notification, customization, and cleanup, we have settled on these two Github workflows:</p>
<details>
<summary><code>.github/workflows/deploy-pr-preview.yml</code></summary>
<div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Deploy to CI environment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>on</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>pull_request</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>workflow_dispatch</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>inputs</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span><span style=color:#2c5dcd;font-weight:700>stac-api-url</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>description</span>:<span style=color:#cbcbcb> </span>Override STAC API URL<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>default</span>:<span style=color:#cbcbcb> </span>https://project-staging.domain.com/stac<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span><span style=color:#2c5dcd;font-weight:700>orders-api-url</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>description</span>:<span style=color:#cbcbcb> </span>Override Orders API URL<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>default</span>:<span style=color:#cbcbcb> </span>https://project-staging.domain.com/api<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span><span style=color:#2c5dcd;font-weight:700>deployment-id</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>description</span>:<span style=color:#cbcbcb> </span>Unique identifier for build (used to construct path for upload)<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>required</span>:<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>true</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>jobs</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>build-and-deploy</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>runs-on</span>:<span style=color:#cbcbcb> </span>ubuntu-latest<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>steps</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Cancel Previous Runs<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>styfle/cancel-workflow-action@0.8.0<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>access_token</span>:<span style=color:#cbcbcb> </span>${{ github.token }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Checkout<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>actions/checkout@v2<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Use Node.js 14<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>actions/setup-node@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>node-version</span>:<span style=color:#cbcbcb> </span><span style=color:#5918bb;font-weight:700>14</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Cache node modules<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>actions/cache@v2<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>env</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>cache-name</span>:<span style=color:#cbcbcb> </span>cache-node-modules<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>path</span>:<span style=color:#cbcbcb> </span>node_modules<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>key</span>:<span style=color:#cbcbcb> </span>${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles(&#39;**/yarn.lock&#39;) }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>restore-keys</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>            ${{ runner.os }}-build-${{ env.cache-name }}-
</span><span style=color:#0c6;font-style:italic>            ${{ runner.os }}-build-
</span><span style=color:#0c6;font-style:italic>            ${{ runner.os }}-</span><span style=color:#cbcbcb>            
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Build and Export<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>id</span>:<span style=color:#cbcbcb> </span>build<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>env</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_BASE_URL</span>:<span style=color:#cbcbcb> </span>https://ci.project-staging.domain.com/${{ github.event.inputs.deployment-id || github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_STAC_API</span>:<span style=color:#cbcbcb> </span>${{ github.event.inputs.stac-api-url || &#39;https://project-staging.domain.com/stac&#39; }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_ORDERS_API</span>:<span style=color:#cbcbcb> </span>${{ github.event.inputs.orders-api-url || &#39;https://project-staging.domain.com/api&#39; }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_MB_TOKEN</span>:<span style=color:#cbcbcb> </span>pk.eyJ1IjoiZGV2c2VlZCIsImEiOiJjazB6YXU2bDUwMWNkM2VvNGNpMnFhOXMxIn0.c30a2TQIfCDF3GlqMdSQ_g<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>NEXT_PUBLIC_GA_ID</span>:<span style=color:#cbcbcb> </span>GTM-WNP7MLF<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>          yarn install
</span><span style=color:#0c6;font-style:italic>          yarn build
</span><span style=color:#0c6;font-style:italic>          yarn run next export</span><span style=color:#cbcbcb>          
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Configure AWS credentials from staging account<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>aws-actions/configure-aws-credentials@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>aws-access-key-id</span>:<span style=color:#cbcbcb> </span>${{ secrets.STAGING_AWS_ACCESS_KEY_ID }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>aws-secret-access-key</span>:<span style=color:#cbcbcb> </span>${{ secrets.STAGING_AWS_SECRET_ACCESS_KEY }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>aws-region</span>:<span style=color:#cbcbcb> </span>us-east-1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Deploy üöÄ<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>          aws s3 sync \
</span><span style=color:#0c6;font-style:italic>            ./out \
</span><span style=color:#0c6;font-style:italic>            s3://project-frontend-ci/${{ github.event.inputs.deployment-id || github.event.pull_request.number }} \
</span><span style=color:#0c6;font-style:italic>            --delete \
</span><span style=color:#0c6;font-style:italic>            --acl public-read</span><span style=color:#cbcbcb>          
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Get current time<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>gerred/actions/current-time@master<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>id</span>:<span style=color:#cbcbcb> </span>current-time<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Find Comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>peter-evans/find-comment@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>id</span>:<span style=color:#cbcbcb> </span>find-comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>issue-number</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>comment-author</span>:<span style=color:#cbcbcb> </span><span style=color:#0c6>&#34;github-actions[bot]&#34;</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>body-includes</span>:<span style=color:#cbcbcb> </span>Latest commit deployed to<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Create or update comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>peter-evans/create-or-update-comment@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>comment-id</span>:<span style=color:#cbcbcb> </span>${{ steps.find-comment.outputs.comment-id }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>issue-number</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>body</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>            üöÄ Latest commit deployed to https://ci.project-staging.domain.com/${{ github.event.inputs.deployment-id || github.event.pull_request.number }}
</span><span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>            * Date: `${{ steps.current-time.outputs.time }}`
</span><span style=color:#0c6;font-style:italic>            * Commit: ${{ github.sha }} (merging ${{ github.event.pull_request.head.sha }} into ${{ github.event.pull_request.base.sha }})</span><span style=color:#cbcbcb>            
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>edit-mode</span>:<span style=color:#cbcbcb> </span>replace<span style=color:#cbcbcb>
</span></code></pre></td></tr></table>
</div>
</div></details>
<details>
<summary><code>.github/workflows/destroy-pr-preview.yml</code></summary>
<div class=highlight><div style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2>
<table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span></code></pre></td>
<td style=vertical-align:top;padding:0;margin:0;border:0;width:100%>
<pre tabindex=0 style=color:#4d4d4d;background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-yaml data-lang=yaml><span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Destroy PR Preview<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>on</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>pull_request</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>types</span>:<span style=color:#cbcbcb> </span>[closed]<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>workflow_dispatch</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>inputs</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span><span style=color:#2c5dcd;font-weight:700>deployment-id</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>description</span>:<span style=color:#cbcbcb> </span>Unique identifier of CI build to be deleted<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>required</span>:<span style=color:#cbcbcb> </span><span style=color:#2c5dcd;font-weight:700>true</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb></span><span style=color:#2c5dcd;font-weight:700>jobs</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>  </span><span style=color:#2c5dcd;font-weight:700>build-and-deploy</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>runs-on</span>:<span style=color:#cbcbcb> </span>ubuntu-latest<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>    </span><span style=color:#2c5dcd;font-weight:700>steps</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Cancel Previous Runs<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>styfle/cancel-workflow-action@0.8.0<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>access_token</span>:<span style=color:#cbcbcb> </span>${{ github.token }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Configure AWS credentials from staging account<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>aws-actions/configure-aws-credentials@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>aws-access-key-id</span>:<span style=color:#cbcbcb> </span>${{ secrets.STAGING_AWS_ACCESS_KEY_ID }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>aws-secret-access-key</span>:<span style=color:#cbcbcb> </span>${{ secrets.STAGING_AWS_SECRET_ACCESS_KEY }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>aws-region</span>:<span style=color:#cbcbcb> </span>us-east-1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Destroy üí£<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>run</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>          </span><span style=color:#cbcbcb>          </span>aws s3 rm --recursive s3://project-frontend-ci/${{ github.event.inputs.deployment-id || github.event.pull_request.number }}/<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Get current time<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>gerred/actions/current-time@master<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>id</span>:<span style=color:#cbcbcb> </span>current-time<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Find Comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>peter-evans/find-comment@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>id</span>:<span style=color:#cbcbcb> </span>find-comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>issue-number</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>comment-author</span>:<span style=color:#cbcbcb> </span><span style=color:#0c6>&#34;github-actions[bot]&#34;</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>body-includes</span>:<span style=color:#cbcbcb> </span>Latest commit deployed to<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>      </span>- <span style=color:#2c5dcd;font-weight:700>name</span>:<span style=color:#cbcbcb> </span>Create or update comment<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>uses</span>:<span style=color:#cbcbcb> </span>peter-evans/create-or-update-comment@v1<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>if</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>        </span><span style=color:#2c5dcd;font-weight:700>with</span>:<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>comment-id</span>:<span style=color:#cbcbcb> </span>${{ steps.find-comment.outputs.comment-id }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>issue-number</span>:<span style=color:#cbcbcb> </span>${{ github.event.pull_request.number }}<span style=color:#cbcbcb>
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>body</span>:<span style=color:#cbcbcb> </span>|<span style=color:#0c6;font-style:italic>
</span><span style=color:#0c6;font-style:italic>            ---
</span><span style=color:#0c6;font-style:italic>            üßπ Deleted build at https://ci.project-staging.domain.com/${{ github.event.inputs.deployment-id || github.event.pull_request.number }} 
</span><span style=color:#0c6;font-style:italic>            
</span><span style=color:#0c6;font-style:italic>            * Date: `${{ steps.current-time.outputs.time }}`</span><span style=color:#cbcbcb>            
</span><span style=color:#cbcbcb>          </span><span style=color:#2c5dcd;font-weight:700>edit-mode</span>:<span style=color:#cbcbcb> </span>append<span style=color:#cbcbcb>
</span></code></pre></td></tr></table>
</div>
</div></details>
<hr>
<p>This system is very new for us and required some additional changes to other services (i.e. updating CORS rules on our APIs to allow us to use this new URL), but so far it seems to be operating as expected. Hoping that this can help others who are looking to build out better CI preview environments for their applications.</p>
<hr>
<h3 id=followup>Followup<a hidden class=anchor aria-hidden=true href=#followup>#</a></h3>
<blockquote>
<p>this is super cool but was there a reason we couldn‚Äôt use netlify or another third party service for this?</p>
</blockquote>
<p>This is a fair question. We opted to roll our own solution being that the general idea (uploading builds to S3) was something that we were already doing for deployments to our Production and Staging environments. However, if you&rsquo;re starting a new project, you may be interested in achieving per-PR deployments with a third party tool. It appears that most common hosting solutions offer something for this:</p>
<ul>
<li>Netlify offers <a href=https://docs.netlify.com/site-deploys/deploy-previews/>Deploy Previews</a></li>
<li>Vercel offers <a href=https://vercel.com/docs/concepts/deployments/environments#preview>Preview URLs</a> via its <a href=https://vercel.com/docs/concepts/git/vercel-for-github>Github Integration</a></li>
<li>AWS Amplify offers <a href=https://docs.aws.amazon.com/amplify/latest/userguide/pr-previews.html>Web Previews</a></li>
<li>Surge.sh can be configured to preview URLs via the <a href=https://github.com/afc163/surge-preview>surge-preview</a> Github Action</li>
</ul>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://alukach.com/tags/devops/>devops</a></li>
<li><a href=https://alukach.com/tags/github-actions/>github actions</a></li>
<li><a href=https://alukach.com/tags/s3/>s3</a></li>
</ul>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://alukach.com/>anthony lukach</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>